<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compliance Calendar</title>


    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FullCalendar JS & CSS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Tippy.js -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <style>
        /* Base Styles */
        html,
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            height: auto !important;
            min-height: 0 !important;
        }

        /* FullCalendar Customization */
        :root {
            --fc-border-color: #e2e8f0;
            --fc-daygrid-event-dot-width: 8px;
            --fc-list-event-dot-width: 10px;
            --fc-event-bg-color: #3b82f6;
            --fc-event-border-color: #3b82f6;
            --fc-event-text-color: #ffffff;
            --fc-button-bg-color: #ffffff;
            --fc-button-text-color: #334155;
            --fc-button-border-color: #cbd5e1;
            --fc-button-hover-bg-color: #f1f5f9;
            --fc-button-active-bg-color: #e2e8f0;
            --fc-today-bg-color: rgba(59, 130, 246, 0.1);
            --fc-page-bg-color: #ffffff;
        }

        .fc {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
        }

        .fc .fc-toolbar-title {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .fc .fc-daygrid-day-number,
        .fc .fc-col-header-cell-cushion {
            color: #475569;
        }

        .fc-theme-standard .fc-list-day-cushion {
            background-color: #f1f5f9;
        }

        /* Modal Transitions */
        .modal {
            transition: opacity 0.25s ease;
        }

        .modal-content {
            transition: transform 0.25s ease;
        }

        /* Tab Navigation (Main Page) */
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }

        .participant-tab-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
        }

        /* Tooltips */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 5px;
            background-color: #1e293b;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        /* --- STYLES FOR NEW MEETING MODAL FEATURES --- */

        /* Custom Multi-select */
        .multi-select-container {
            position: relative;
        }

        .multi-select-input {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 2px;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            min-height: 38px;
            background-color: #ffffff;
            padding-right: 30px;
            /* Make room for arrow */
        }

        .multi-select-tag {
            display: flex;
            align-items: center;
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 0.25rem;
            padding: 2px 6px;
            margin: 2px;
            font-size: 0.875rem;
        }

        .multi-select-tag button {
            margin-left: 4px;
            color: #4338ca;
        }

        .multi-select-search {
            flex-grow: 1;
            border: none;
            outline: none;
            padding: 4px;
            background: transparent;
            min-width: 100px;
        }

        /* Chevron for Dropdowns */
        .select-chevron {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #64748b;
            /* slate-500 */
            width: 16px;
            height: 16px;
        }

        /* Fixed Dropdown - Updated for Fixed Positioning */
        .multi-select-dropdown {
            /* Position set via JS to 'fixed' to escape overflow containers */
            background-color: white;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: none;
        }

        .multi-select-dropdown.show {
            display: block;
        }

        .multi-select-dropdown div {
            padding: 8px 12px;
            cursor: pointer;
        }

        .multi-select-dropdown div:hover {
            background-color: #f1f5f9;
        }

        .multi-select-all {
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 600;
            color: #3b82f6;
            background-color: #eff6ff;
        }

        .multi-select-all:hover {
            background-color: #dbeafe;
        }

        /* Single-select specific styles */
        .single-select-container .multi-select-input {
            padding-right: 30px;
        }

        .single-select-container .multi-select-search {
            background-color: transparent;
            width: 100%;
        }

        /* Meeting Modal Inner Tabs */
        .tab-nav-item {
            padding: 0.5rem 1rem;
            font-weight: 500;
            color: #475569;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .tab-nav-item:hover {
            color: #020617;
        }

        .tab-nav-item.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Validation Modal Tabs */
        .val-tab-content {
            display: none;
        }

        .val-tab-content.active {
            display: block;
        }

        /* NEW: Meeting Modal Tabs */
        .meeting-tab-content {
            display: none;
        }

        .meeting-tab-content.active {
            display: block;
        }


        /* Color Picker */
        .color-swatch {
            -webkit-appearance: none;
            appearance: none;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid #ffffff;
            margin-right: 0.75rem;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .color-swatch:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1rem;
            height: 1rem;
            transform: translate(-50%, -50%);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        .swatch-blue {
            background-color: #3b82f6;
        }

        .swatch-purple {
            background-color: #a855f7;
        }

        .swatch-green {
            background-color: #22c55e;
        }

        .swatch-yellow {
            background-color: #eab308;
        }

        .swatch-red {
            background-color: #ef4444;
        }

        .swatch-gray {
            background-color: #64748b;
        }

        .color-swatch-custom {
            position: relative;
            display: block;
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            cursor: pointer;
            border: 2px solid #ffffff;
            overflow: hidden;
            margin-right: 0.75rem;
            margin-bottom: 0.5rem;
        }

        #color-custom:checked+#custom-color-label i {
            display: none;
        }

        #color-custom:checked+#custom-color-label::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1rem;
            height: 1rem;
            transform: translate(-50%, -50%);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='20 6 9 17 4 12'%3E%3C/polyline%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
        }

        /* Recurrence Buttons */
        .day-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.25rem;
            height: 2.25rem;
            border: 1px solid #cbd5e1;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            color: #334155;
            background-color: #ffffff;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .day-btn:hover {
            background-color: #f1f5f9;
        }

        .day-btn.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }

        /* Rich Text Editor */
        .rich-text-editor-toolbar {
            border: 1px solid #cbd5e1;
            border-bottom: none;
            border-radius: 0.375rem 0.375rem 0 0;
            background-color: #f8fafc;
            padding: 0.5rem;
        }

        .rich-text-editor-toolbar button {
            width: 2rem;
            height: 2rem;
            border-radius: 0.25rem;
            color: #475569;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .rich-text-editor-toolbar button:hover {
            background-color: #e2e8f0;
        }

        .rich-text-editor-content {
            border: 1px solid #cbd5e1;
            border-radius: 0 0 0.375rem 0.375rem;
            padding: 0.75rem;
            min-height: 100px;
            background-color: #ffffff;
        }

        .rich-text-editor-content:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 1px #3b82f6;
        }

        .rich-text-editor-content ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }

        .rich-text-editor-content ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
        }

        /* Sub-item indentation styles */
        .minutes-sub-item {
            margin-left: 2.5rem;
            /* Indent sub-items */
            border-left: 3px solid #e2e8f0;
            padding-left: 1rem;
        }

        /* Agenda & Action Items */
        .agenda-item {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        .agenda-sub-item {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-left: 2rem;
        }

        .action-item-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
        }

        .file-tag {
            background-color: #e0e7ff;
            color: #4338ca;
            border-radius: 0.25rem;
            padding: 2px 6px;
            margin: 2px;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
        }

        .remove-file-btn {
            margin-left: 4px;
            color: #4338ca;
            font-size: 1rem;
            line-height: 1;
            cursor: pointer;
        }

        /* Tooltip Popup */
        .tooltip-popup {
            position: fixed;
            background-color: #ffffff;
            color: #1e293b;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            width: 500px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .tooltip-popup.show {
            opacity: 1;
            visibility: visible;
        }

        .tooltip-table th {
            background-color: #f8fafc;
            padding: 0.5rem;
            text-align: left;
            font-size: 0.75rem;
            color: #475569;
            text-transform: uppercase;
        }

        .tooltip-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.875rem;
        }

        /* Time Input Customization */
        .time-input-wrapper {
            position: relative;
            width: 100%;
        }

        .time-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            display: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .time-dropdown.show {
            display: block;
        }

        .time-option {
            padding: 4px 12px;
            cursor: pointer;
            font-size: 0.875rem;
            color: #334155;
        }

        .time-option:hover {
            background-color: #f1f5f9;
        }

        /* Saved Views & Filter Bar */
        .views-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .filter-panel {
            transition: all 0.3s ease-in-out;
            max-height: 1000px;
            opacity: 1;
            overflow: visible;
        }

        .filter-panel.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }

        /* Action Menu for Tables */
        .action-menu-container {
            position: relative;
        }

        .action-menu-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            width: 180px;
            /* Wider for better action text */
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            display: none;
        }

        .action-menu-dropdown.show {
            display: block;
        }

        .action-menu-item {
            padding: 8px 12px;
            font-size: 0.875rem;
            color: #334155;
            cursor: pointer;
        }

        .action-menu-item:hover {
            background-color: #f1f5f9;
        }

        .action-menu-item.delete {
            color: #ef4444;
        }
    </style>
</head>

<body class="text-slate-800">
    <!-- Role Simulation -->
    <div class="fixed top-2 right-4 bg-slate-800 text-white p-2 rounded-lg shadow-lg z-[100] text-xs">
        <label for="role-toggle" class="font-bold">Simulate Role:</label>
        <select id="role-toggle" class="bg-slate-700 rounded-md p-1 text-xs">
            <option value="admin">Admin / Compliance</option>
            <option value="trainer">Trainer</option>
        </select>
    </div>

    <!-- Main Container -->
    <div class="p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-slate-900">Calendar</h1>
        </header>

        <!-- Tab Navigation (Main) -->
        <div class="border-b border-slate-200 mb-8 flex justify-between items-center">
            <nav class="-mb-px flex space-x-8" aria-label="Tabs" id="main-view-tabs">
                <button id="tab-schedule" onclick="switchMainView('schedule')"
                    class="tab-btn active whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-blue-600 border-blue-600">
                    Calendar
                </button>
                <button id="tab-list-view" onclick="switchMainView('list')"
                    class="tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-slate-500 border-transparent hover:text-blue-600 hover:border-blue-300">
                    List View
                </button>
            </nav>
            <!-- Add Event Button -->
            <button onclick="openModal('modal-select-event-type')"
                class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium shadow-sm">
                <i data-lucide="plus" class="w-4 h-4"></i> Add Event
            </button>
        </div>

        <!-- Tab Content -->
        <div>
            <div id="content-schedule">
                <!-- Saved Views Toolbar -->
                <div class="views-toolbar">
                    <div class="flex items-center gap-2">
                        <label for="saved-views-select" class="text-sm font-semibold text-slate-700">View:</label>
                        <select id="saved-views-select"
                            class="border border-slate-300 rounded-md text-sm py-1.5 px-3 focus:ring-blue-500 focus:border-blue-500 min-w-[200px]">
                            <option value="default">Default View</option>
                        </select>
                        <button id="btn-save-view"
                            class="p-1.5 text-slate-500 hover:text-blue-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 transition-colors"
                            title="Save Current View">
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <button id="btn-toggle-filters"
                        class="flex items-center gap-1.5 text-sm font-medium text-blue-600 hover:text-blue-800 transition-colors">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        <span id="filter-toggle-text">Hide Filters</span>
                    </button>
                </div>

                <!-- Filters Card (Collapsible) -->
                <div id="filter-panel"
                    class="filter-panel bg-white p-4 rounded-xl border border-slate-200 shadow-sm mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- Program -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Filter by Program</label>
                            <div id="filter-program-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Unit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Filter by Unit</label>
                            <div id="filter-unit-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Org Unit -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Org Unit</label>
                            <div id="filter-org-unit-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Company -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Company</label>
                            <div id="filter-company-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- People -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">People</label>
                            <div id="filter-people-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Company Contacts -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Company Contacts</label>
                            <div id="filter-contacts-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Students -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Students</label>
                            <div id="filter-students-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Meeting Type -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Event Type</label>
                            <div id="filter-meeting-type-select" class="multi-select-container mt-1"></div>
                        </div>

                        <!-- Status -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Status</label>
                            <div id="filter-status-select" class="multi-select-container mt-1"></div>
                        </div>
                    </div>
                </div>
                <div id="calendar"></div>

                <!-- List View Container -->
                <div id="list-view-container" class="hidden">
                    <div class="bg-white rounded-xl border border-slate-200 shadow-sm p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-semibold text-slate-800">All Events</h2>
                            <div class="flex items-center gap-2">
                                <label for="list-view-limit" class="text-sm text-slate-600">Show:</label>
                                <select id="list-view-limit"
                                    class="border border-slate-300 rounded-md text-sm py-1 px-2">
                                    <option value="10">10</option>
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100" selected>100</option>
                                </select>
                            </div>
                        </div>
                        <div id="list-view-content" class="overflow-x-auto">
                            <!-- Table rendered by JS -->
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    </div>

    <!-- Modals -->

    <!-- Event Type Selector -->
    <div id="modal-select-event-type"
        class="modal fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden opacity-0 transition-opacity duration-300">
        <div
            class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-md p-6 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center border-b border-slate-200 pb-3 mb-4">
                <h3 class="text-xl font-bold text-slate-900">Create New Event</h3>
                <button class="modal-close p-1 rounded-full hover:bg-slate-200"
                    onclick="closeModal('modal-select-event-type')"><i data-lucide="x"
                        class="w-5 h-5 text-slate-600"></i></button>
            </div>
            <div class="space-y-4 py-4">
                <button id="select-event-validation"
                    class="w-full text-left p-4 rounded-lg border border-slate-300 hover:bg-slate-50 hover:border-blue-500 hover:shadow-md transition-all group">
                    <div class="flex items-center space-x-4">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center group-hover:bg-blue-500">
                            <i data-lucide="file-check" class="w-6 h-6 text-blue-600 group-hover:text-white"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-800">Validation Event</p>
                            <p class="text-sm text-slate-500">Schedule a compliance validation for specific units.</p>
                        </div>
                    </div>
                </button>
                <button id="select-event-meeting"
                    class="w-full text-left p-4 rounded-lg border border-slate-300 hover:bg-slate-50 hover:border-blue-500 hover:shadow-md transition-all group">
                    <div class="flex items-center space-x-4">
                        <div
                            class="flex-shrink-0 w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center group-hover:bg-indigo-500">
                            <i data-lucide="users" class="w-6 h-6 text-indigo-600 group-hover:text-white"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-800">Meeting Event</p>
                            <p class="text-sm text-slate-500">Schedule a meeting.</p>
                        </div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- Validation Event Modal -->
    <div id="modal-event-management"
        class="modal fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4 hidden opacity-0">
        <div
            class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-7xl p-6 transform scale-95 max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center border-b border-slate-200 pb-3 mb-4 flex-shrink-0">
                <h3 id="event-modal-title" class="text-xl font-bold text-slate-900">Schedule New Validation Event
                </h3>
                <button class="modal-close p-1 rounded-full hover:bg-slate-200"
                    onclick="closeModal('modal-event-management')"><i data-lucide="x"
                        class="w-5 h-5 text-slate-600"></i></button>
            </div>

            <!-- Validation Modal Tabs -->
            <div class="border-b border-slate-200 -mt-4 flex-shrink-0 mb-1">
                <nav class="-mb-px flex space-x-4 overflow-x-auto" aria-label="Tabs">
                    <button class="tab-nav-item active" onclick="switchValTab('details')"
                        data-val-tab="details">Details</button>
                    <button class="tab-nav-item" onclick="switchValTab('participants')"
                        data-val-tab="participants">Participants</button>

                    <!-- Validation-only tabs -->
                    <button class="tab-nav-item" onclick="switchValTab('student-assessments')"
                        data-val-tab="student-assessments" data-category="validation">Assessment Samples</button>
                    <button class="tab-nav-item" onclick="switchValTab('rpl')" data-val-tab="rpl"
                        data-category="validation">RPL</button>
                    <button class="tab-nav-item" onclick="switchValTab('validation-report')"
                        data-val-tab="validation-report" data-category="validation">Report</button>

                    <!-- Meeting-only tabs -->
                    <button class="tab-nav-item" onclick="switchValTab('agenda')" data-val-tab="agenda"
                        data-category="meeting" style="display:none;">Agenda</button>
                    <button class="tab-nav-item" onclick="switchValTab('minutes')" data-val-tab="minutes"
                        data-category="meeting" style="display:none;">Minutes</button>

                    <!-- Shared tabs -->
                    <button class="tab-nav-item" onclick="switchValTab('actions')"
                        data-val-tab="actions">Actions</button>
                    <button class="tab-nav-item" onclick="switchValTab('ci')" data-val-tab="ci">CI</button>
                    <button class="tab-nav-item" onclick="switchValTab('risk')" data-val-tab="risk">Risk</button>
                    <button class="tab-nav-item" onclick="switchValTab('standards')"
                        data-val-tab="standards">Standards</button>
                </nav>
            </div>

            <div class="overflow-y-auto flex-grow pr-2 pb-6 space-y-6">
                <!-- Tab: Meeting Details -->
                <div id="val-tab-details" class="val-tab-content active space-y-4">
                    <!-- General Info Card -->
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-6">
                        <h4 class="font-semibold text-slate-800 mb-3">General Information</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-1 mb-1">
                                    <label class="block text-sm font-medium text-slate-700">Event Type <span
                                            class="text-red-500">*</span></label>
                                    <button type="button" class="text-slate-400 hover:text-blue-600 transition-colors"
                                        onclick="openModal('modal-validation-type-info')" title="View Definitions">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <!-- Validation Type Section -->
                                <div id="validation-type-section">
                                    <!-- UPDATED: Validation Meeting Type Select -->
                                    <select id="validation-meeting-type-select"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                        onchange="handleValidationTypeAutoPopulation()">
                                        <option value="" disabled selected>Select Event Type...</option>
                                        <option value="Pre-Assessment Validation">Pre-Assessment Validation</option>
                                        <option value="Post-Assessment Validation">Post-Assessment Validation</option>
                                    </select>
                                </div>

                                <!-- Meeting Type Section (Meeting Only) -->
                                <div id="meeting-type-section" style="display:none;">
                                    <div id="meeting-type-select" class="multi-select-container mt-1"></div>
                                </div>

                                <div>
                                    <div class="flex items-center gap-1 mb-1">
                                        <label for="event-title" class="block text-sm font-medium text-slate-700">Event
                                            Title <span class="text-red-500">*</span></label>
                                        <button type="button"
                                            class="text-slate-400 hover:text-blue-600 focus:outline-none"
                                            title="Give the validation event a clear, descriptive name (e.g., 'Q3 Cookery Validation - SIT30816').">
                                            <i data-lucide="info" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                    <input type="text" id="event-title"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>

                                <!-- Description (Meeting Only) -->
                                <div id="meeting-description-section" style="display:none;">
                                    <label for="meeting-description"
                                        class="block text-sm font-medium text-slate-700">Description</label>
                                    <textarea id="meeting-description" rows="3"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="Enter meeting description..."></textarea>
                                </div>
                            </div>

                            <!-- NEW: Validation Status Field -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Status</label>
                                <input type="text" id="event-status" readonly
                                    class="mt-1 block w-full border-slate-300 bg-slate-100 text-slate-500 rounded-md shadow-sm px-3 py-2 cursor-not-allowed"
                                    value="Scheduled">
                            </div>



                            <!-- UPDATED: Event Color Picker -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-2">Event Color</label>
                                <div class="flex items-center gap-3">
                                    <!-- Blue (Default) -->
                                    <label class="cursor-pointer">
                                        <input type="radio" name="event-color" value="#3b82f6" class="peer sr-only"
                                            checked>
                                        <div
                                            class="w-8 h-8 rounded-full bg-blue-500 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-blue-500 hover:scale-110 transition-transform">
                                        </div>
                                    </label>
                                    <!-- Purple -->
                                    <label class="cursor-pointer">
                                        <input type="radio" name="event-color" value="#a855f7" class="peer sr-only">
                                        <div
                                            class="w-8 h-8 rounded-full bg-purple-500 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-purple-500 hover:scale-110 transition-transform">
                                        </div>
                                    </label>
                                    <!-- Green -->
                                    <label class="cursor-pointer">
                                        <input type="radio" name="event-color" value="#22c55e" class="peer sr-only">
                                        <div
                                            class="w-8 h-8 rounded-full bg-green-500 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-green-500 hover:scale-110 transition-transform">
                                        </div>
                                    </label>
                                    <!-- Amber (Warning/Audit) -->
                                    <label class="cursor-pointer">
                                        <input type="radio" name="event-color" value="#f59e0b" class="peer sr-only">
                                        <div
                                            class="w-8 h-8 rounded-full bg-amber-500 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-amber-500 hover:scale-110 transition-transform">
                                        </div>
                                    </label>
                                    <!-- Rose (Urgent/Validation) -->
                                    <label class="cursor-pointer">
                                        <input type="radio" name="event-color" value="#e11d48" class="peer sr-only">
                                        <div
                                            class="w-8 h-8 rounded-full bg-rose-600 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-rose-500 hover:scale-110 transition-transform">
                                        </div>
                                    </label>

                                    <!-- Custom Color Input (Validation) - Integrated Pill -->
                                    <div
                                        class="flex items-center ml-2 p-0.5 rounded-full bg-slate-100 border border-slate-200 hover:border-slate-300 transition-colors focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500">
                                        <label class="cursor-pointer relative flex-shrink-0">
                                            <input type="radio" name="event-color" id="val-color-custom"
                                                class="peer sr-only">
                                            <div id="val-custom-color-container"
                                                class="w-8 h-8 rounded-full bg-slate-200 border-2 border-transparent peer-checked:border-slate-600 peer-checked:ring-2 peer-checked:ring-offset-2 peer-checked:ring-blue-500 hover:scale-110 transition-transform overflow-hidden flex items-center justify-center relative"
                                                style="background-color: #0ea5e9;">
                                                <input type="color" id="val-custom-color-input"
                                                    class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                                                    value="#0ea5e9"
                                                    oninput="document.getElementById('val-custom-color-container').style.backgroundColor = this.value; document.getElementById('val-color-custom').checked = true; document.getElementById('val-color-custom').value = this.value; document.getElementById('val-custom-color-text').value = this.value;">
                                                <i data-lucide="palette"
                                                    class="w-4 h-4 text-white opacity-90 pointer-events-none"></i>
                                            </div>
                                        </label>
                                        <input type="text" id="val-custom-color-text" value="#0ea5e9"
                                            placeholder="#000000" maxlength="7"
                                            class="w-20 border-0 bg-transparent px-2 py-1 text-xs font-mono uppercase text-slate-700 focus:ring-0 placeholder-slate-400"
                                            oninput="if(this.value.match(/^#[0-9A-Fa-f]{6}$/)) { document.getElementById('val-custom-color-input').value = this.value; document.getElementById('val-custom-color-container').style.backgroundColor = this.value; document.getElementById('val-color-custom').checked = true; document.getElementById('val-color-custom').value = this.value; }">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Scope & Context Card -->
                    <section id="scope-context-section" class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                        <h4 class="font-semibold text-slate-800 mb-2">Scope & Context</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center gap-1 mb-1">
                                    <label for="event-program" class="block text-sm font-medium text-slate-700">Program
                                        <span class="text-red-500">*</span></label>
                                    <button type="button" class="text-slate-400 hover:text-blue-600 focus:outline-none"
                                        title="Select the program whose units are being validated. The list is sorted by risk.">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div id="event-program-select" class="multi-select-container mt-1"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Units for Validation <span
                                        class="text-red-500">*</span></label>
                                <div id="units-multi-select" class="multi-select-container mt-1">
                                    <!-- JS Injected Here -->
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Time & Recurrence Card -->
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg">
                        <h4 class="font-semibold text-slate-800 mb-3">Time & Recurrence</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="event-date" class="block text-sm font-medium text-slate-700">Date <span
                                            class="text-red-500">*</span></label>
                                    <input type="date" id="event-date"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        required>
                                </div>
                                <div>
                                    <label for="event-start-time" class="block text-sm font-medium text-slate-700">Start
                                        Time <span class="text-red-500">*</span></label>
                                    <select id="event-start-time"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2"
                                        required onchange="adjustEndTime(this)">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                                <div>
                                    <label for="event-end-time" class="block text-sm font-medium text-slate-700">End
                                        Time <span class="text-red-500">*</span></label>
                                    <select id="event-end-time"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 px-3 py-2">
                                        <!-- Populated by JS -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="md:col-span-1">
                            <label for="event-recurrence-type"
                                class="block text-sm font-medium text-slate-700">Repeat</label>
                            <select id="event-recurrence-type"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                onchange="toggleEventRecurrenceOptions()">
                                <option value="none">Does not repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="fortnightly">Fortnightly</option>
                                <option value="monthly">Monthly</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>

                        <!-- Recurrence Options for Validation (Hidden by default) -->
                        <div id="event-recurrence-options-panel"
                            class="hidden mt-2 p-3 bg-white border border-slate-200 rounded-md shadow-sm">
                            <!-- Recurrence Content Same as Meeting (Simplified for brevity in block, assume copied from previous turn fully) -->
                            <!-- Daily -->
                            <div id="val-rec-daily" class="hidden text-sm text-slate-600">
                                <div class="flex items-center gap-2"><span>Recur every</span><input type="number"
                                        value="1" min="1"
                                        class="w-16 border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm"><span>day(s)</span>
                                </div>
                            </div>
                            <!-- Weekly -->
                            <div id="val-rec-weekly" class="hidden text-sm text-slate-600">
                                <div class="flex items-center gap-2 mb-2"><span>Recur every</span><input type="number"
                                        value="1" min="1"
                                        class="w-16 border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm"><span>week(s)
                                        on:</span></div>
                                <div class="flex gap-2"><button type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">M</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">T</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">W</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">T</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">F</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">S</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">S</button>
                                </div>
                            </div>
                            <!-- Fortnightly -->
                            <div id="val-rec-fortnightly" class="hidden text-sm text-slate-600">
                                <div class="flex items-center gap-2 mb-2"><span>Recur every</span><input type="number"
                                        value="2" disabled
                                        class="w-16 border-slate-200 bg-slate-100 rounded-md shadow-sm px-3 py-2 text-sm text-slate-500 cursor-not-allowed"><span>weeks
                                        on:</span></div>
                                <div class="flex gap-2"><button type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">M</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">T</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">W</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">T</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">F</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">S</button><button
                                        type="button"
                                        class="day-btn w-8 h-8 rounded-full border border-slate-300 flex items-center justify-center hover:bg-slate-100 transition-colors">S</button>
                                </div>
                            </div>
                            <!-- Monthly -->
                            <div id="val-rec-monthly" class="hidden text-sm text-slate-600 space-y-3">
                                <div class="flex items-center gap-2"><input type="radio" name="val-monthly-opt" checked
                                        class="text-blue-600 focus:ring-blue-500"> <span>Day</span><input type="number"
                                        class="w-16 border-slate-300 rounded px-3 py-2 text-sm" value="15" min="1"
                                        max="31"><span>of every</span><input type="number"
                                        class="w-16 border-slate-300 rounded px-3 py-2 text-sm" value="1"
                                        min="1"><span>month(s)</span></div>
                                <div class="flex items-center gap-2 flex-wrap"><input type="radio"
                                        name="val-monthly-opt" class="text-blue-600 focus:ring-blue-500">
                                    <span>The</span><select class="border-slate-300 rounded px-3 py-2 text-sm">
                                        <option>First</option>
                                    </select> <select class="border-slate-300 rounded px-3 py-2 text-sm">
                                        <option>Monday</option>
                                    </select><span>of every</span><input type="number"
                                        class="w-16 border-slate-300 rounded px-3 py-2 text-sm" value="1"
                                        min="1"><span>month(s)</span>
                                </div>
                            </div>
                            <!-- Yearly -->
                            <div id="val-rec-yearly" class="hidden text-sm text-slate-600 space-y-3">
                                <div class="flex items-center gap-2"><span class="font-medium mr-2">Recur every 1
                                        year(s)</span></div>
                                <div class="flex items-center gap-2"><input type="radio" name="val-yearly-opt" checked
                                        class="text-blue-600 focus:ring-blue-500"> <span>On:</span><select
                                        class="border-slate-300 rounded px-3 py-2 text-sm">
                                        <option>January</option>
                                    </select><input type="number"
                                        class="w-14 border-slate-300 rounded px-3 py-2 text-sm" value="15" min="1"
                                        max="31"></div>
                            </div>
                            <!-- End Recurrence -->
                            <div class="pt-3 mt-3 border-t border-slate-100 space-y-2">
                                <label class="block text-xs font-bold text-slate-700 uppercase">End
                                    Recurrence</label>
                                <div class="flex items-center gap-3"><input type="radio" name="val-rec-end"
                                        id="val-rec-end-date" class="text-blue-600 focus:ring-blue-500"><label
                                        for="val-rec-end-date" class="text-sm text-slate-700">On</label><input
                                        type="date" class="border-slate-300 rounded px-3 py-2 text-sm h-9"></div>
                                <div class="flex items-center gap-3"><input type="radio" name="val-rec-end"
                                        id="val-rec-end-after" checked class="text-blue-600 focus:ring-blue-500"><label
                                        for="val-rec-end-after" class="text-sm text-slate-700">After</label><input
                                        type="number" class="w-16 border-slate-300 rounded px-3 py-2 text-sm h-9"
                                        value="10"><span class="text-sm text-slate-700">occurrences</span></div>
                            </div>
                        </div>

                    </section>

                    <!-- Reminders Card (Validation) -->
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                        <h4 class="font-semibold text-slate-800 mb-2">Reminders</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="mt-4 pt-4 border-t border-slate-100">
                                    <div class="flex items-center gap-3">
                                        <div class="flex items-center h-5">
                                            <input id="val-reminder-enable" type="checkbox"
                                                class="h-4 w-4 text-blue-600 focus:ring-blue-500 rounded border-gray-300"
                                                onchange="document.getElementById('val-reminder-settings').classList.toggle('hidden', !this.checked)">
                                        </div>
                                        <div class="ml-2 text-sm">
                                            <label for="val-reminder-enable" class="font-medium text-slate-700">Set
                                                Reminder</label>
                                        </div>
                                        <div id="val-reminder-settings" class="hidden flex items-center gap-2">
                                            <input type="number" id="val-reminder-value" value="15"
                                                class="w-16 border-slate-300 rounded-md shadow-sm text-sm p-1">
                                            <select id="val-reminder-unit"
                                                class="border-slate-300 rounded-md shadow-sm text-sm p-1">
                                                <option value="minutes">Minutes before</option>
                                                <option value="hours">Hours before</option>
                                                <option value="days">Days before</option>
                                            </select>
                                        </div>
                                    </div>
                                    <!-- Notification Type Options -->
                                    <div id="val-reminder-type-container" class="mt-2 ml-9 hidden">
                                        <!-- Toggled by checkbox logic via JS or just CSS based on checkbox? Easier to just verify persistence -->
                                        <div class="flex items-center gap-4 text-sm mt-1">
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="val-reminder-type" value="email"
                                                    class="text-blue-600 focus:ring-blue-500">
                                                <span class="ml-2 text-slate-700">Email</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="val-reminder-type" value="system"
                                                    class="text-blue-600 focus:ring-blue-500">
                                                <span class="ml-2 text-slate-700">System Notification</span>
                                            </label>
                                            <label class="inline-flex items-center">
                                                <input type="radio" name="val-reminder-type" value="both"
                                                    class="text-blue-600 focus:ring-blue-500" checked>
                                                <span class="ml-2 text-slate-700">Both</span>
                                            </label>
                                        </div>
                                    </div>
                                    <script>
                                        // Simple script to toggle the notification type visibility when reminder is checked.
                                        // Or cleaner: modify the onchange above.
                                        document.getElementById('val-reminder-enable').addEventListener('change', function () {
                                            const typeContainer = document.getElementById('val-reminder-type-container');
                                            if (this.checked) typeContainer.classList.remove('hidden');
                                            else typeContainer.classList.add('hidden');
                                        });
                                    </script>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Location Card -->
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                        <h4 class="font-semibold text-slate-800 mb-2">Location</h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Location Type</label>
                                <div class="mt-2 flex space-x-4">
                                    <label class="flex items-center"><input type="radio" name="event-location-type"
                                            value="physical" class="h-4 w-4 text-blue-600 focus:ring-blue-500" checked
                                            onchange="toggleEventLocationFields()"><span class="ml-2">Physical
                                            Location</span></label>
                                    <label class="flex items-center"><input type="radio" name="event-location-type"
                                            value="virtual" class="h-4 w-4 text-blue-600 focus:ring-blue-500"
                                            onchange="toggleEventLocationFields()"><span
                                            class="ml-2">Virtual</span></label>
                                </div>
                            </div>

                            <div id="event-location-physical" class="space-y-4 mt-4">
                                <!-- Sub-toggle for Physical -->
                                <div class="flex items-center space-x-4 mb-3">
                                    <label class="flex items-center"><input type="radio" name="event-physical-type"
                                            value="onsite" class="h-4 w-4 text-blue-600" checked
                                            onchange="toggleEventPhysicalSubtype()"> <span
                                            class="ml-2 text-sm text-slate-700">Onsite Location</span></label>
                                    <label class="flex items-center"><input type="radio" name="event-physical-type"
                                            value="external" class="h-4 w-4 text-blue-600"
                                            onchange="toggleEventPhysicalSubtype()"> <span
                                            class="ml-2 text-sm text-slate-700">External Location</span></label>
                                </div>

                                <div id="event-loc-onsite" class="space-y-4">
                                    <div>
                                        <label for="event-location-select"
                                            class="block text-sm font-medium text-slate-700">Location</label>
                                        <select id="event-location-select"
                                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                            onchange="populateEventRooms()">
                                            <option value="">Select a location...</option>
                                            <option value="Boardroom A">Boardroom A</option>
                                            <option value="Main Campus">Main Campus</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="event-room-select"
                                            class="block text-sm font-medium text-slate-700">Room</label>
                                        <select id="event-room-select"
                                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                            disabled>
                                            <option value="">Select a location first...</option>
                                        </select>
                                    </div>
                                </div>
                                <!-- External Location Field -->
                                <div id="event-loc-external" class="mt-2 hidden">
                                    <label for="event-external-location"
                                        class="block text-sm font-medium text-slate-700">External Location</label>
                                    <input type="text" id="event-external-location"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="e.g. Off-site office, Cafe, etc.">
                                </div>
                            </div>

                            <div id="event-location-virtual" class="hidden mt-4">
                                <label for="event-url" class="block text-sm font-medium text-slate-700">Event
                                    URL</label>
                                <input type="text" id="event-url" placeholder="https://zoom.us/..."
                                    class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </section>

                    <!-- Event Meta Card -->
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                        <h4 class="font-semibold text-slate-800 mb-2">Event Meta</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Event Creator</label>
                                <input type="text" id="event-creator" readonly
                                    class="mt-1 block w-full border-slate-300 bg-slate-100 text-slate-500 rounded-md shadow-sm px-3 py-2 cursor-not-allowed"
                                    value="System Admin">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Date Created</label>
                                <input type="text" id="event-date-created" readonly
                                    class="mt-1 block w-full border-slate-300 bg-slate-100 text-slate-500 rounded-md shadow-sm px-3 py-2 cursor-not-allowed"
                                    value="">
                            </div>
                        </div>
                    </section>

                </div>

                <!-- NEW Tab: Participants -->
                <div id="val-tab-participants" class="val-tab-content">
                    <!-- VALIDATION PARTICIPANTS (conditionally shown) -->
                    <div id="participants-validation" data-category="validation">
                        <!-- Participants Section Moved Here -->
                        <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-semibold text-slate-800">Participants</h4>
                                <button type="button"
                                    class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-md hover:bg-slate-50 text-slate-600 transition-colors"
                                    onclick="openModal('modal-add-participant')" title="Add Participant">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>

                            <!-- Compliance Pending Banner -->
                            <div id="compliance-banner"
                                class="hidden p-3 mb-4 rounded-lg bg-red-50 border border-red-200 text-red-800 flex items-center space-x-3 transition-all">
                                <i data-lucide="alert-triangle" class="w-5 h-5 flex-shrink-0"></i>
                                <p class="text-sm font-medium" id="compliance-banner-text">Compliance Pending: The team
                                    is
                                    collectively missing evidence for 'Professional Development'.</p>
                            </div>

                            <div id="participant-list" class="space-y-4">
                                <!-- Mock participant -->
                                <div class="bg-white border border-slate-200 rounded-md shadow-sm participant-card">
                                    <div class="p-4 flex items-start justify-between">
                                        <div class="flex items-center gap-3">
                                            <div
                                                class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
                                                SC</div>
                                            <div>
                                                <p class="text-sm font-bold text-slate-900">Sarah Chen</p>
                                                <p class="text-xs text-slate-500">Compliance Manager</p>
                                                <button type="button"
                                                    class="text-xs text-blue-600 font-medium hover:underline mt-1">View
                                                    Linked Evidence</button>
                                            </div>
                                        </div>
                                        <div class="flex items-center gap-3">
                                            <label
                                                class="flex items-center text-xs text-slate-600 gap-1 cursor-pointer">
                                                <input type="checkbox"
                                                    class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">Independent
                                            </label>
                                            <div class="action-menu-container relative inline-block text-left">
                                                <button type="button" class="p-1 text-slate-400 hover:text-slate-600"
                                                    onclick="toggleActionMenu(this)" title="Actions">
                                                    <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                                </button>
                                                <div
                                                    class="action-menu-dropdown absolute right-0 bottom-full mb-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                                    <div class="py-1">
                                                        <a href="#"
                                                            class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center gap-2"
                                                            onclick="event.preventDefault(); editValidationParticipant(0);"><i
                                                                data-lucide="edit-2" class="w-4 h-4"></i> Edit</a>
                                                        <a href="#"
                                                            class="text-red-600 block px-4 py-2 text-sm hover:bg-red-50 flex items-center gap-2"
                                                            onclick="event.preventDefault(); removeValidationParticipant(0);"><i
                                                                data-lucide="trash-2" class="w-4 h-4"></i> Delete</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Credentials Footer -->
                                    <div class="bg-slate-50 p-3 border-t border-slate-100 rounded-b-md">
                                        <p class="text-xs font-semibold text-slate-700 mb-2">Tag evidence against
                                            requirements:</p>
                                        <div class="flex flex-wrap gap-4">
                                            <label class="inline-flex items-center gap-2 cursor-pointer"><input
                                                    type="checkbox"
                                                    class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4"
                                                    data-type="Industry Currency" checked
                                                    onchange="checkCompliance()"><span
                                                    class="text-xs text-slate-600">Industry Currency</span></label>
                                            <label class="inline-flex items-center gap-2 cursor-pointer"><input
                                                    type="checkbox"
                                                    class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4"
                                                    data-type="Professional Development"
                                                    onchange="checkCompliance()"><span
                                                    class="text-xs text-slate-600">Professional
                                                    Development</span></label>
                                            <label class="inline-flex items-center gap-2 cursor-pointer"><input
                                                    type="checkbox"
                                                    class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4"
                                                    data-type="Trainer Credential" checked
                                                    onchange="checkCompliance()"><span
                                                    class="text-xs text-slate-600">Trainer Credential</span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button id="add-participant-btn" type="button"
                                class="mt-4 w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-700 text-sm font-semibold py-2 rounded-lg border border-slate-300"
                                onclick="openModal('modal-add-participant')">
                                <i data-lucide="plus" class="inline w-4 h-4 mr-1"></i> Add Participant
                            </button>
                        </section>
                    </div><!-- END participants-validation -->

                    <!-- MEETING PARTICIPANTS (conditionally shown) -->
                    <div id="participants-meeting" data-category="meeting" style="display:none;">
                        <div class="space-y-6">
                            <!-- Internal Participants Section -->
                            <div id="card-meeting-internal-participants"
                                class="bg-white border border-slate-200 rounded-lg shadow-sm">
                                <div
                                    class="px-6 py-4 border-b border-slate-200 bg-slate-50 rounded-t-lg flex justify-between items-center">
                                    <h3 class="text-base font-semibold text-slate-900">Internal Participants</h3>
                                    <button type="button"
                                        class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-md hover:bg-slate-50 text-slate-600 transition-colors"
                                        onclick="openModal('modal-add-meeting-participant')"
                                        title="Add Internal Participant">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="p-4">
                                    <div id="meeting-internal-participants-list" class="space-y-3 mb-4">
                                        <!-- Internal participant cards will be rendered here -->
                                    </div>
                                    <button type="button" onclick="openModal('modal-add-meeting-participant')"
                                        class="w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-slate-400 hover:text-slate-700 transition-colors">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                        <span>Add Participant</span>
                                    </button>
                                </div>
                            </div>

                            <!-- External Participants Section -->
                            <div id="card-meeting-external-participants"
                                class="bg-white border border-slate-200 rounded-lg shadow-sm">
                                <div
                                    class="px-6 py-4 border-b border-slate-200 bg-slate-50 flex justify-between items-center">
                                    <h3 class="text-base font-semibold text-slate-900">External Participants</h3>
                                    <button type="button"
                                        class="w-8 h-8 flex items-center justify-center bg-white border border-slate-200 rounded-md hover:bg-slate-50 text-slate-600 transition-colors"
                                        onclick="openModal('modal-add-meeting-external')"
                                        title="Add External Participant">
                                        <i data-lucide="plus" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                <div class="p-4">
                                    <div id="meeting-external-participants-list" class="space-y-3 mb-4">
                                        <!-- External participant cards will be rendered here -->
                                    </div>
                                    <button type="button" onclick="openModal('modal-add-meeting-external')"
                                        class="w-full flex items-center justify-center gap-2 px-4 py-2 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-slate-400 hover:text-slate-700 transition-colors">
                                        <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                        <span>Add External Participant</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div><!-- END participants-meeting -->
                </div>

                <!-- Tab: Standards (Validation) -->


                <!-- Tab: Completed Student Assessments -->
                <div id="val-tab-student-assessments" class="val-tab-content">
                    <section class="space-y-4">
                        <div class="flex justify-between items-center">
                            <h4 class="font-semibold text-slate-800">Assessment Samples</h4>
                            <div class="flex items-center">
                                <span id="display-samples-error"
                                    class="text-xs text-red-600 font-medium hidden mr-3"></span>
                                <button id="btn-display-samples" type="button"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium text-sm hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-md font-medium text-sm hover:bg-blue-700 transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                    onclick="generateAssessmentSamples()">
                                    Display Samples
                                </button>
                            </div>
                        </div>

                        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                            <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                                <!-- Row 1: All Configs & Filters -->
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-semibold text-slate-600 uppercase mb-1 truncate"
                                        title="Sample Size">Sample Size</label>
                                    <input type="number" id="sample-size-input"
                                        class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                        value="3" placeholder="3">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-semibold text-slate-600 uppercase mb-1 truncate"
                                        title="Collection Period (Months)">Collection Period (Months)</label>
                                    <input id="assessments-months" type="number"
                                        class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                        value="12" placeholder="12">
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-xs font-semibold text-slate-600 uppercase mb-1 truncate"
                                        title="Upload Type">Source</label>
                                    <select id="upload-assessment-type"
                                        class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm px-2">
                                        <option value="lms" selected>LMS</option>
                                        <option value="manual">Manual Upload</option>
                                    </select>
                                </div>

                                <div class="md:col-span-3">
                                    <label
                                        class="block text-xs font-semibold text-slate-600 uppercase mb-1 truncate">Assessors</label>
                                    <div id="student-assessments-trainers-select"
                                        class="multi-select-container bg-white">
                                        <!-- JS Injected Here -->
                                    </div>
                                </div>
                                <div class="md:col-span-3">
                                    <label
                                        class="block text-xs font-semibold text-slate-600 uppercase mb-1 truncate">Outcomes</label>
                                    <div id="outcome-types-select" class="multi-select-container bg-white">
                                        <!-- JS Injected Here -->
                                    </div>
                                </div>

                                <!-- Row 3: Rationale -->
                                <div class="md:col-span-12">
                                    <label class="block text-xs font-semibold text-slate-600 uppercase mb-1">Sampling
                                        Rationale</label>
                                    <textarea id="sample-rationale" rows="2"
                                        class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm"
                                        placeholder="Explain why this sample size was chosen...">Random sampling across different cohorts to ensure consistency.</textarea>
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-200 pt-4">
                            <div id="student-assessments-list" class="space-y-4"></div>
                        </div>
                    </section>
                </div>

                <!-- NEW Tab: RPL (Candidate RPL Sample Assessments) -->
                <div id="val-tab-rpl" class="val-tab-content">
                    <section class="space-y-4">
                        <h4 class="font-semibold text-slate-800">Candidate RPL Sample Assessments</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Row 1 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700">RPL Assessment Sample
                                    Size</label>
                                <div class="flex gap-2">
                                    <input type="number" id="rpl-sample-size-input"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        value="3" placeholder="e.g. 1">
                                    <button type="button"
                                        class="mt-1 bg-blue-600 text-white px-3 py-2 rounded-md font-medium text-sm hover:bg-blue-700 transition-colors shadow-sm"
                                        onclick="generateRPLSamples()">
                                        Generate
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Assessors</label>
                                <div id="rpl-assessments-trainers-select" class="multi-select-container mt-1">
                                    <!-- JS Injected Here -->
                                </div>
                            </div>

                            <!-- Row 2 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Sample Size
                                    Rationale</label>
                                <textarea id="rpl-sample-rationale" rows="3"
                                    class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                    placeholder="Rationale for RPL sample size..."></textarea>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Outcome Types</label>
                                    <div id="rpl-outcome-types-select" class="multi-select-container mt-1">
                                        <!-- JS Injected Here -->
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Assessments completed in
                                        the
                                        last (months)</label>
                                    <input type="number"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                                        placeholder="e.g. 12">
                                </div>
                            </div>
                        </div>

                        <div class="border-t border-slate-200 pt-3">
                            <div id="rpl-assessments-list" class="space-y-4"></div>
                        </div>
                    </section>
                </div>

                <!-- Tab: Report (New) -->
                <div id="val-tab-report" class="val-tab-content space-y-4">
                    <div class="col-span-2 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex gap-2">
                                <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-900">Validation Report Guidance</h4>
                                    <p class="text-sm text-blue-800 mt-1" id="report-guidance-text">
                                        The validation report summarizes the findings, recommendations, and actions
                                        arising from the validation session. It serves as formal evidence of the quality
                                        review process.
                                    </p>
                                </div>
                            </div>
                            <button type="button" class="text-blue-500 hover:text-blue-700"
                                onclick="toggleReportGuidance()">
                                <i data-lucide="chevron-up" class="w-5 h-5 transition-transform"
                                    id="report-guidance-chevron"></i>
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Executive Summary</label>
                            <textarea id="val-report-summary"
                                class="w-full border-slate-300 rounded-md shadow-sm px-3 py-2 pb-12 focus:ring-blue-500 focus:border-blue-500"
                                rows="6" placeholder="Summary of findings..."></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Recommendations</label>
                            <textarea id="val-report-recommendations"
                                class="w-full border-slate-300 rounded-md shadow-sm px-3 py-2 pb-12 focus:ring-blue-500 focus:border-blue-500"
                                rows="6" placeholder="Key recommendations..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- Tab: Assessment Tools [DELETED] -->

                <!-- Tab: Agenda (Meeting only) - MERGED FROM MEETING MODAL -->
                <div id="val-tab-agenda" class="val-tab-content" data-category="meeting" style="display:none;">
                    <section>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-slate-800">Agenda Items</h4>
                            <button onclick="addAgendaItem()" type="button"
                                class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-blue-700 flex items-center gap-1"><i
                                    data-lucide="plus" class="w-4 h-4"></i> Add Item</button>
                        </div>
                        <div id="agenda-item-list" class="space-y-4">
                            <!-- Dynamic Items -->
                        </div>
                        <div id="btn-add-another-agenda-container"
                            class="mt-4 flex justify-center border-t border-slate-100 pt-4">
                            <button onclick="addAgendaItem()" type="button"
                                class="w-full border border-dashed border-slate-300 text-slate-500 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 px-3 py-3 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Another Agenda Item
                            </button>
                        </div>
                    </section>
                    <section class="mt-3 border-t border-slate-200 pt-3">
                        <h4 class="font-semibold text-slate-800 mb-3">Meeting Documents</h4>
                        <div class="bg-slate-50 border border-slate-200 border-dashed rounded-lg p-8 text-center hover:bg-slate-100 transition-colors cursor-pointer"
                            onclick="openModal('modal-val-doc-upload')">
                            <i data-lucide="cloud-upload" class="w-10 h-10 mx-auto text-slate-400 mb-2"></i>
                            <span class="text-blue-600 hover:underline text-sm font-medium">Click to upload</span>
                            <span class="text-slate-500 text-sm"> or drag and drop agenda documents here</span>
                        </div>
                    </section>
                </div>

                <!-- Tab: Minutes (Meeting only) - MERGED FROM MEETING MODAL -->
                <div id="val-tab-minutes" class="val-tab-content" data-category="meeting" style="display:none;">
                    <section>
                        <h4 class="font-semibold text-slate-800 mb-3">Minutes</h4>
                        <div id="minutes-agenda-container" class="space-y-4">
                            <p class="text-sm text-slate-500 italic">Add agenda items to populate this section.</p>
                        </div>
                    </section>
                    <section>
                        <h4 class="font-semibold text-slate-800 mb-3">General Minutes</h4>
                        <div class="rich-text-editor border border-slate-300 rounded-md bg-white">
                            <div class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                    data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                    data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                    data-command="insertUnorderedList"><i data-lucide="list"
                                        class="w-4 h-4"></i></button>
                            </div>
                            <div id="general-minutes-editor"
                                class="rich-text-editor-content p-3 min-h-[200px] outline-none" contenteditable="true">
                            </div>
                        </div>
                    </section>
                    <section class="mt-3 border-t border-slate-200 pt-3">
                        <div class="flex items-center gap-6 mb-3">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="minutes-visibility-company"
                                    class="text-blue-600 focus:ring-blue-500 rounded">
                                <span class="ml-2 text-sm text-slate-700 font-medium">Display Minutes to Company
                                    Participants</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="minutes-visibility-student"
                                    class="text-blue-600 focus:ring-blue-500 rounded">
                                <span class="ml-2 text-sm text-slate-700 font-medium">Display Minutes to Student
                                    Participants</span>
                            </label>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-3">Minutes Documents</h4>
                        <div class="bg-slate-50 border border-slate-200 border-dashed rounded-lg p-8 text-center hover:bg-slate-100 transition-colors cursor-pointer"
                            onclick="openModal('modal-val-doc-upload')">
                            <i data-lucide="cloud-upload" class="w-10 h-10 mx-auto text-slate-400 mb-2"></i>
                            <span class="text-blue-600 hover:underline text-sm font-medium">Click to upload</span>
                            <span class="text-slate-500 text-sm"> or drag and drop minutes documents here</span>
                        </div>
                    </section>
                </div>

                <!-- Tab: Actions (Validation) - NEW -->
                <div id="val-tab-actions" class="val-tab-content">
                    <section class="space-y-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-slate-800">Action Items</h4>
                            <button onclick="openAddActionModal('validation')" type="button"
                                class="bg-blue-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-blue-700 flex items-center gap-1">
                                <i data-lucide="plus" class="w-4 h-4"></i> Add Item
                            </button>
                        </div>

                        <!-- Actions Table -->
                        <div class="border rounded-lg border-slate-200 overflow-hidden">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Action Item</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Assigned To</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Due Date</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="validation-action-items-body" class="bg-white divide-y divide-slate-200">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                            <!-- Empty State -->
                            <div id="validation-action-empty-state" class="p-8 text-center text-slate-500 hidden">
                                <p>No action items yet.</p>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- NEW Tab: Validation Report (UPDATED) -->
                <div id="val-tab-validation-report" class="val-tab-content">
                    <section class="space-y-4">

                        <!-- Section 1: Assessment System Finding -->
                        <div class="space-y-3">
                            <h3 class="text-lg font-bold text-slate-800">Assessment System Finding</h3>

                            <!-- Expandable Guidance -->
                            <div class="border border-green-200 rounded-md overflow-hidden bg-green-50">
                                <button type="button" class="w-full flex justify-between items-center p-3 text-left"
                                    data-toggle-guidance="guidance-system">
                                    <div class="flex items-center gap-2 text-green-800 font-semibold text-sm">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                        <span>Guidance: Principles of Assessment</span>
                                    </div>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-green-700 transition-transform"
                                        id="guidance-system-chevron"></i>
                                </button>
                                <div id="guidance-system-content"
                                    class="hidden px-4 pb-4 text-sm text-green-900 border-t border-green-200 space-y-3">
                                    <p class="font-medium">Review your assessment system including assessment tools
                                        against the Principles of Assessment below and record your findings.</p>

                                    <div class="space-y-2">
                                        <p>You can demonstrate how you go about providing clear guidance on what the
                                            assessment task is to both the assessor and the student so that they
                                            both
                                            know:</p>
                                        <ul class="list-disc pl-5">
                                            <li>what is to be assessed</li>
                                            <li>the context and conditions of assessment</li>
                                            <li>how and when assessment is to occur</li>
                                            <li>the environment for the assessment.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Fairness:</strong> You can demonstrate how you apply the principle
                                        of
                                        fairness in assessment  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>considering students needs and making reasonable adjustments to
                                                your
                                                assessment processes or tools</li>
                                            <li>ensuring students are fully informed of the assessment process and
                                                performance expectations before undertaking assessment tasks</li>
                                            <li>considering whether students need further training before being
                                                reassessed (in cases where students are initially unable to complete
                                                the
                                                required task to the level described in the assessment requirements)
                                            </li>
                                            <li>having an appeals process to provide an avenue for students to
                                                challenge
                                                an assessment judgement and to have it reviewed objectively.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Flexibility:</strong> You can demonstrate how you apply the
                                        principle of
                                        flexibility in assessment  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>adjusting your assessment system where a student has already
                                                demonstrated some aspects of the unit of competency through other
                                                means
                                            </li>
                                            <li>recognising that students demonstrate competence in a variety of
                                                ways
                                            </li>
                                            <li>drawing from a range of assessment methods to find those that are
                                                appropriate to your context, the assessment requirements, and the
                                                individual student.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Validity:</strong> You can demonstrate how you apply the principle
                                        of
                                        validity of assessment  for example:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>assessment is based on evidence that demonstrates that a student
                                                could
                                                perform the skills and knowledge across a range of situations</li>
                                            <li>assessment of knowledge and skills is integrated with practical
                                                application  skills are assessed by observing the student carrying
                                                out
                                                the relevant task in an appropriate environment</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Reliability:</strong> You can demonstrate how you apply the
                                        principle of
                                        reliability in assessment  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>having an assessment system that includes sufficient context, detail
                                                and
                                                guidance to enable assessors to make consistent assessment decisions
                                                and
                                                minimises variation between assessors</li>
                                            <li>developing evidence criteria (i.e. decision-making rules) to judge
                                                the
                                                quality of performance</li>
                                            <li>identifying benchmarks for practical activities that are broad
                                                enough to
                                                allow for variations in the task being undertaken and any variations
                                                in
                                                the context, but include sufficiently detailed observable behaviours
                                            </li>
                                            <li>actively assuring assessment practices through monitoring the
                                                reliability and consistency of decisions by your assessors on an
                                                ongoing
                                                basis.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Rich Text Editor -->
                            <div class="rich-text-editor border border-slate-300 rounded-md bg-white">
                                <div
                                    class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="insertUnorderedList"><i data-lucide="list"
                                            class="w-4 h-4"></i></button>
                                </div>
                                <div class="rich-text-editor-content p-3 min-h-[150px] outline-none"
                                    contenteditable="true">
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Assessment Judgements -->
                        <div class="space-y-3">
                            <h3 class="text-lg font-bold text-slate-800">Assessment Judgements</h3>

                            <!-- Expandable Guidance -->
                            <div class="border border-green-200 rounded-md overflow-hidden bg-green-50">
                                <button type="button" class="w-full flex justify-between items-center p-3 text-left"
                                    data-toggle-guidance="guidance-judgements">
                                    <div class="flex items-center gap-2 text-green-800 font-semibold text-sm">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                        <span>Guidance: Rules of Evidence</span>
                                    </div>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-green-700 transition-transform"
                                        id="guidance-judgements-chevron"></i>
                                </button>
                                <div id="guidance-judgements-content"
                                    class="hidden px-4 pb-4 text-sm text-green-900 border-t border-green-200 space-y-3">
                                    <p class="font-medium">Review the student samples and assessor judgements
                                        against
                                        the Rules of Evidence and record your findings.</p>

                                    <div>
                                        <strong>Validity:</strong> You can demonstrate how you ensure validity in
                                        assessment judgements, for example:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>ensuring assessment evidence is adequate, such that the assessor can
                                                be
                                                reasonably assured that the VET student possesses the skills and
                                                knowledge described in the training product</li>
                                            <li>judgement of competence is based on a range of relevant evidence,
                                                ensuring there is a direct relationship between the assessment task
                                                or
                                                activity the student undertakes (including assessment of practical
                                                application of skills), the evidence presented by the student and
                                                the
                                                assessment requirements.</li>
                                            <li>The assessment tasks reflect real world, industry current workplace
                                                tasks and environments.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Sufficiency:</strong> You can demonstrate how you ensure sufficiency
                                        in
                                        assessment judgements  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>ensuring the quality, quantity and relevance of the assessment
                                                evidence
                                                enables the assessor to make an informed judgement of the VET
                                                students
                                                competency in the skills and knowledge described in the training
                                                product
                                            </li>
                                            <li>gathering enough evidence to make a valid assessment judgement</li>
                                            <li>adjusting the quantity of evidence gathered as required  some
                                                students
                                                may take longer or need to complete a greater number of tasks to
                                                demonstrate competence; others may not be able to achieve competence
                                                despite repeated opportunities.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Authenticity:</strong> You can demonstrate how you assure
                                        authenticity
                                        of assessment judgements  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>ensuring the assessor is assured that a VET students assessment
                                                evidence is the original and genuine work of that VET student</li>
                                            <li>considering the potential means by which a student may engage in
                                                academic cheating</li>
                                            <li>validating that evidence belongs to the student being assessed
                                                (e.g.
                                                has not been plagiarised or generated with artificial intelligence
                                                (AI)
                                                tools)</li>
                                            <li>verifying that the person you are enrolling, training and assessing
                                                is
                                                the same person that will be issued with a qualification or
                                                statement of
                                                attainment.</li>
                                        </ul>
                                    </div>

                                    <div>
                                        <strong>Currency:</strong> You can demonstrate how you ensure currency in
                                        assessment judgements  for example by:
                                        <ul class="list-disc pl-5 mt-1">
                                            <li>ensuring the assessment evidence presented to the assessor
                                                demonstrates
                                                the VET students current skills and knowledge</li>
                                            <li>considering the time that has passed since the evidence of the
                                                students
                                                competency was generated.</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Rich Text Editor -->
                            <div class="rich-text-editor border border-slate-300 rounded-md bg-white">
                                <div
                                    class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="insertUnorderedList"><i data-lucide="list"
                                            class="w-4 h-4"></i></button>
                                </div>
                                <div class="rich-text-editor-content p-3 min-h-[150px] outline-none"
                                    contenteditable="true">
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Report Summary -->
                        <div class="space-y-3">
                            <h3 class="text-lg font-bold text-slate-800">Report Summary</h3>

                            <!-- Expandable Guidance -->
                            <div class="border border-green-200 rounded-md overflow-hidden bg-green-50">
                                <button type="button" class="w-full flex justify-between items-center p-3 text-left"
                                    data-toggle-guidance="guidance-summary">
                                    <div class="flex items-center gap-2 text-green-800 font-semibold text-sm">
                                        <i data-lucide="info" class="w-4 h-4"></i>
                                        <span>Guidance: Summary Content</span>
                                    </div>
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-green-700 transition-transform"
                                        id="guidance-summary-chevron"></i>
                                </button>
                                <div id="guidance-summary-content"
                                    class="hidden px-4 pb-4 text-sm text-green-900 border-t border-green-200">
                                    <p class="mb-2 mt-2 font-medium">Summarise your report findings to include the
                                        following:</p>
                                    <ul class="list-disc pl-5 space-y-2">
                                        <li><strong>Gaps in assessment tools</strong> <br> <span
                                                class="text-xs text-green-700">(e.g., missing unit requirements,
                                                unclear
                                                instructions, weak mapping, inconsistent benchmarks)</span></li>
                                        <li><strong>Issues with student evidence</strong> <br> <span
                                                class="text-xs text-green-700">(e.g., evidence not
                                                valid/sufficient/authentic/current, over- or
                                                under-assessment)</span>
                                        </li>
                                        <li><strong>Issues with assessor judgements</strong> <br> <span
                                                class="text-xs text-green-700">(e.g., inconsistent decisions,
                                                incorrect
                                                application of benchmarks, competency awarded without adequate
                                                evidence)</span></li>
                                        <li><strong>Assessment system/process issues</strong> <br> <span
                                                class="text-xs text-green-700">(e.g., outdated versions, poor
                                                industry
                                                relevance, unclear guidance for workplace evidence, inconsistent
                                                reasonable adjustment processes)</span></li>
                                        <li><strong>Risks arising from issues</strong> <br> <span
                                                class="text-xs text-green-700">(e.g., risk of incorrect competency
                                                decisions, non-compliance with Standards, systemic assessment
                                                errors)</span></li>
                                        <li><strong>Impact summary</strong> <br> <span
                                                class="text-xs text-green-700">(e.g.,
                                                how issues affect assessment
                                                quality, consistency, learner outcomes, and compliance
                                                standing)</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>

                            <!-- Rich Text Editor -->
                            <div class="rich-text-editor border border-slate-300 rounded-md bg-white">
                                <div
                                    class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                    <button type="button"
                                        class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600"
                                        data-command="insertUnorderedList"><i data-lucide="list"
                                            class="w-4 h-4"></i></button>
                                </div>
                                <div class="rich-text-editor-content p-3 min-h-[150px] outline-none"
                                    contenteditable="true">
                                </div>
                            </div>
                        </div>

                        <!-- Supporting Documents Section -->
                        <section class="mt-3 border-t border-slate-200 pt-3">
                            <h4 class="font-semibold text-slate-800 mb-3">Supporting Documents</h4>
                            <div class="bg-slate-50 border border-slate-200 border-dashed rounded-lg p-8 text-center hover:bg-slate-100 transition-colors cursor-pointer"
                                onclick="openModal('modal-val-doc-upload')">
                                <i data-lucide="cloud-upload" class="w-10 h-10 mx-auto text-slate-400 mb-2"></i>
                                <span class="text-blue-600 hover:underline text-sm font-medium">Click to
                                    upload</span>
                                <span class="text-slate-500 text-sm"> or drag and drop supporting documents
                                    here</span>
                            </div>
                        </section>
                    </section>
                </div>

                <!-- Tab: Continuous Improvement -->
                <div id="val-tab-ci" class="val-tab-content">
                    <section class="space-y-4">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-semibold text-slate-800">Continuous Improvement</h4>
                            <button
                                class="bg-blue-600 text-white hover:bg-blue-700 w-8 h-8 rounded-full flex items-center justify-center shadow-sm transition-colors"
                                onclick="openAddCIModal('val')" title="Add Record">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- Data Table (Renamed IDs) -->
                        <div id="val-ci-table-container"
                            class="border rounded-lg border-slate-200 overflow-hidden flex-grow overflow-y-auto">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Raised By</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Date Added</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Area for Improvement</th>
                                        <th scope="col"
                                            class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                            Status</th>
                                        <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="val-ci-table-body" class="bg-white divide-y divide-slate-200">
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>

                <!-- Tab: Risk (Validation) -->
                <div id="val-tab-risk" class="val-tab-content hidden h-full flex flex-col">
                    <div class="flex justify-between items-center mb-4 flex-shrink-0">
                        <h4 class="font-semibold text-slate-800">Risk Register</h4>
                        <!-- Add Risk Button -->
                        <button type="button"
                            class="bg-blue-600 text-white hover:bg-blue-700 w-8 h-8 rounded-full flex items-center justify-center shadow-sm transition-colors"
                            onclick="openAddRiskModal('val')" title="Add Risk">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>

                    <!-- Risk Table -->
                    <div id="val-risk-table-container"
                        class="border rounded-lg border-slate-200 overflow-hidden flex-grow overflow-y-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                            <thead class="bg-slate-50 sticky top-0 z-10">
                                <tr>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        Risk</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        Date Identified</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        Area of Operation</th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        Inh. Score <i data-lucide="info" class="w-3 h-3 inline"></i></th>
                                    <th
                                        class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
                                        Res. Score <i data-lucide="info" class="w-3 h-3 inline"></i></th>
                                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                </tr>
                            </thead>
                            <tbody id="val-risk-table-body" class="bg-white divide-y divide-slate-200">
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Tab: Standards (Validation - Moved to End) -->
                <div id="val-tab-standards" class="val-tab-content hidden space-y-4">
                    <section class="bg-slate-50 border border-slate-200 p-4 rounded-lg mt-2">
                        <h4 class="font-semibold text-slate-800 mb-3">2025 RTO Standards</h4>
                        <div class="space-y-4">
                            <!-- Quality Area -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Quality Area</label>
                                <div id="val-standards-quality-area"
                                    class="multi-select-container bg-white border border-slate-300 rounded-md p-2 min-h-[42px]">
                                </div>
                            </div>
                            <!-- Divisions -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Divisions</label>
                                <div id="val-standards-division"
                                    class="multi-select-container bg-white border border-slate-300 rounded-md p-2 min-h-[42px]">
                                </div>
                            </div>
                            <!-- Relevant RTO Standards -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Standards <i
                                        data-lucide="info" class="inline w-3 h-3 text-slate-400 ml-1"
                                        title="Select applicable standards"></i></label>
                                <div id="val-standards-standard"
                                    class="multi-select-container bg-white border border-slate-300 rounded-md p-2 min-h-[42px]">
                                </div>
                            </div>
                            <!-- Performance Indicators -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Performance
                                    Indicators</label>
                                <div id="val-standards-performance-indicator"
                                    class="multi-select-container bg-white border border-slate-300 rounded-md p-2 min-h-[42px]">
                                </div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Modal Footer (Inside modal-content) -->
                <div id="event-modal-footer"
                    class="flex justify-between items-center pt-4 border-t border-slate-200 flex-shrink-0 mt-6">
                    <!-- Left-aligned action buttons -->
                    <div id="footer-action-buttons" class="flex gap-2">
                        <button id="btn-add-action-footer" type="button"
                            class="text-blue-600 hover:bg-blue-50 px-4 py-2 rounded-md border border-blue-200 font-medium hidden"
                            onclick="openAddActionModal()">
                            <i data-lucide="plus-circle" class="w-4 h-4 inline mr-1"></i> Add Action
                        </button>
                        <button id="btn-mark-complete"
                            class="text-green-600 hover:bg-green-50 px-4 py-2 rounded-md border border-green-200 font-medium hidden"
                            onclick="markValidationComplete()">
                            <i data-lucide="check-circle" class="w-4 h-4 inline mr-1"></i> Mark as Complete
                        </button>
                    </div>
                    <div class="flex gap-2 ml-auto items-center">
                        <div id="val-save-error" class="hidden text-red-600 text-sm font-medium mr-4">Please fill in all
                            required fields</div>
                        <button type="button"
                            class="bg-white text-slate-700 px-4 py-2 rounded-md border border-slate-300 hover:bg-slate-50"
                            onclick="closeModal('modal-event-management')">Cancel</button>
                        <button id="save-event-btn" type="submit"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                            onclick="saveEvent()">Save
                            Event</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Action Item Modal (Overlay) -->
        <div id="modal-add-action-item"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 transform scale-95">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Add Action Item</h3>
                <form id="action-item-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Task Description</label>
                        <textarea id="action-task" rows="3"
                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Assign To</label>
                        <div id="action-assign-select" class="multi-select-container mt-1"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Due Date</label>
                            <input type="date" id="action-due-date"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Status</label>
                            <select id="action-status"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                <option>Not Started</option>
                                <option>In Progress</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end gap-2 mt-6">
                        <button type="button"
                            class="bg-white text-slate-700 px-4 py-2 rounded-md border border-slate-300 hover:bg-slate-50"
                            onclick="closeModal('modal-add-action-item')">Cancel</button>
                        <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                            onclick="saveActionItem()">Save Task</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW: Modal for Meeting External Participant -->
        <div id="modal-add-meeting-external"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4 hidden opacity-0">
            <div
                class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-0 transform scale-95 overflow-hidden">
                <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">Add External Participant</h3>
                    <button onclick="closeModal('modal-add-meeting-external')"
                        class="text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <form id="form-meeting-external" class="p-4 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700">First Name <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="meeting-ext-first-name"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Last Name <span
                                    class="text-red-500">*</span></label>
                            <input type="text" id="meeting-ext-last-name"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Email <span
                                class="text-red-500">*</span></label>
                        <input type="email" id="meeting-ext-email"
                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700">Role / Title</label>
                        <input type="text" id="meeting-ext-role"
                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="flex justify-end gap-2 mt-6 border-t border-slate-100 pt-4">
                        <button type="button"
                            class="bg-white text-slate-700 px-4 py-2 rounded-md border border-slate-300 hover:bg-slate-50"
                            onclick="closeModal('modal-add-meeting-external')">Cancel</button>
                        <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                            onclick="saveMeetingExternalParticipant()">Add Participant</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal: Add Meeting Participant (Dynamic Type Selection) -->
        <div id="modal-add-meeting-participant" class="modal-overlay hidden">
            <div class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <!-- Header -->
                    <div class="px-6 py-4 border-b border-slate-200 bg-slate-50 rounded-t-lg">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-slate-900">Add Participants</h2>
                            <button onclick="closeModal('modal-add-meeting-participant')"
                                class="text-slate-400 hover:text-slate-600">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="overflow-visible p-6 flex-1" style="max-height: 70vh; overflow-y: auto;">
                        <!-- All Type Cards Always Visible -->
                        <div class="space-y-4">
                            <!-- Staff Card -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Staff Members</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('staff')">
                                        <div id="staff-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="staff-selected-display" class="text-sm text-slate-500">Select
                                            staff
                                            members...</span>
                                    </div>
                                    <div id="dropdown-staff"
                                        class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div class="p-2">
                                            <input type="text" id="search-staff" placeholder="Type to filter..."
                                                class="w-full border border-slate-300 rounded-md p-2 text-sm mb-2"
                                                oninput="filterParticipantOptions('staff', this.value)">
                                            <div id="select-staff" class="max-h-48 overflow-y-auto">
                                                <!-- Populated by JavaScript with clickable items -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trainers Card -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Trainers</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('trainers')">
                                        <div id="trainers-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="trainers-selected-display" class="text-sm text-slate-500">Select
                                            trainers...</span>
                                    </div>
                                    <div id="dropdown-trainers"
                                        class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div class="p-2">
                                            <input type="text" id="search-trainers" placeholder="Type to filter..."
                                                class="w-full border border-slate-300 rounded-md p-2 text-sm mb-2"
                                                oninput="filterParticipantOptions('trainers', this.value)">
                                            <div id="select-trainers" class="max-h-48 overflow-y-auto">
                                                <!-- Populated by JavaScript with clickable items -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Students Card -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Students</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('students')">
                                        <div id="students-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="students-selected-display" class="text-sm text-slate-500">Select
                                            students...</span>
                                    </div>
                                    <div id="dropdown-students"
                                        class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div class="p-2">
                                            <input type="text" id="search-students" placeholder="Type to filter..."
                                                class="w-full border border-slate-300 rounded-md p-2 text-sm mb-2"
                                                oninput="filterParticipantOptions('students', this.value)">
                                            <div id="select-students" class="max-h-48 overflow-y-auto">
                                                <!-- Populated by JavaScript with checkboxes -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Org Unit Card -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Org Units</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('orgUnit')">
                                        <div id="orgUnit-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="orgUnit-selected-display" class="text-sm text-slate-500">Select
                                            organizational units...</span>
                                    </div>
                                    <div id="dropdown-orgUnit"
                                        class="hidden absolute z-50 mt-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div class="p-2">
                                            <input type="text" id="search-orgUnit" placeholder="Type to filter..."
                                                class="w-full border border-slate-300 rounded-md p-2 text-sm mb-2"
                                                oninput="filterParticipantOptions('orgUnit', this.value)">
                                            <div id="select-orgUnit" class="max-h-48 overflow-y-auto">
                                                <!-- Populated by JavaScript with checkboxes -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Company Selection Card -->
                            <div class="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Company</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('company')">
                                        <div id="company-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="company-selected-display" class="text-sm text-slate-500">Select a
                                            company...</span>
                                    </div>
                                    <!-- Filter input stays in place -->
                                    <div id="company-filter-container" class="hidden mt-1">
                                        <input type="text" id="search-company" placeholder="Type to filter..."
                                            class="w-full border border-slate-300 rounded-md p-2 text-sm"
                                            oninput="filterParticipantOptions('company', this.value)">
                                    </div>
                                    <!-- List opens upward above the filter -->
                                    <div id="dropdown-company"
                                        class="hidden absolute z-50 bottom-full mb-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div id="select-company" class="max-h-48 overflow-y-auto p-2">
                                            <!-- Populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Company Contacts Card (only visible when company selected) -->
                            <div id="card-company-contacts"
                                class="bg-slate-50 border border-slate-200 rounded-lg p-4 hidden">
                                <h4 class="text-sm font-semibold text-slate-900 mb-3">Company Contacts</h4>
                                <div class="relative participant-multiselect">
                                    <div class="w-full border border-slate-300 rounded-md p-2 bg-white cursor-pointer min-h-[42px] flex flex-wrap gap-1 items-center"
                                        onclick="toggleParticipantDropdown('company-contacts')">
                                        <div id="company-contacts-pills" class="flex flex-wrap gap-1"></div>
                                        <span id="company-contacts-selected-display"
                                            class="text-sm text-slate-500">Select
                                            company contacts...</span>
                                    </div>
                                    <!-- Filter input stays in place -->
                                    <div id="company-contacts-filter-container" class="hidden mt-1">
                                        <input type="text" id="search-company-contacts" placeholder="Type to filter..."
                                            class="w-full border border-slate-300 rounded-md p-2 text-sm"
                                            oninput="filterParticipantOptions('company-contacts', this.value)">
                                    </div>
                                    <!-- List opens upward -->
                                    <div id="dropdown-company-contacts"
                                        class="hidden absolute z-50 bottom-full mb-1 w-full bg-white border border-slate-300 rounded-md shadow-lg">
                                        <div id="select-company-contacts" class="max-h-48 overflow-y-auto p-2">
                                            <!-- Populated based on selected company -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Footer -->
                    <div
                        class="flex justify-end items-center px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-lg gap-3">
                        <button type="button"
                            class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-300 font-medium"
                            onclick="closeModal('modal-add-meeting-participant')">Cancel</button>
                        <button type="button"
                            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 font-medium"
                            onclick="saveParticipantsFromModal()">Add Participants</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal: Add Participant Overlay -->
        <div id="modal-add-participant"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[60] flex items-center justify-center p-4 hidden opacity-0">
            <div
                class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-0 transform scale-95 overflow-hidden">
                <div class="bg-slate-50 border-b border-slate-200 p-4 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">Add Participant</h3>
                    <button onclick="closeModal('modal-add-participant')" class="text-slate-400 hover:text-slate-600"><i
                            data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <!-- Tabs -->
                <div class="flex border-b border-slate-200">
                    <button id="add-part-tab-trainer"
                        class="flex-1 py-3 text-sm font-medium text-center bg-blue-600 text-white shadow-sm transition-colors"
                        onclick="switchAddPartTab('trainer')">Trainer</button>
                    <button id="add-part-tab-external"
                        class="flex-1 py-3 text-sm font-medium text-center text-slate-600 hover:text-slate-900 hover:bg-slate-200 transition-colors"
                        onclick="switchAddPartTab('external')">External Expert</button>
                </div>

                <div class="p-6">
                    <!-- Content: Trainer -->
                    <div id="add-part-content-trainer">
                        <label class="block text-sm font-medium text-slate-700 mb-2">Search System User</label>
                        <select id="select-trainer-input"
                            class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 mb-4">
                            <option>David Jones (Trainer)</option>
                            <option>Emily White (Assessor)</option>
                            <option>Michael Brown (Lead Trainer)</option>
                        </select>
                        <div class="bg-blue-50 text-blue-800 text-xs p-3 rounded border border-blue-100">
                            <p class="font-semibold mb-1"><i data-lucide="info" class="w-3 h-3 inline mr-1"></i>
                                Auto-Population</p>
                            <p>Evidence for internal trainers is automatically pulled from the Trainer Matrix.</p>
                        </div>
                    </div>

                    <!-- Content: External -->
                    <div id="add-part-content-external" class="hidden space-y-4">
                        <div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">First Name <span
                                            class="text-red-500">*</span></label>
                                    <input type="text" id="external-first-name"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Last Name <span
                                            class="text-red-500">*</span></label>
                                    <input type="text" id="external-last-name"
                                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700">Email <span
                                        class="text-red-500">*</span></label>
                                <input type="email" id="external-email"
                                    class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700">Role / Title</label>
                            <input type="text" id="external-role"
                                class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <!-- NEW: Credential Evidence Upload -->
                        <div class="border-t border-slate-200 pt-4 mt-2">
                            <label class="block text-sm font-medium text-slate-700 mb-2">Credential
                                Documents</label>
                            <div class="space-y-2" id="external-docs-list">
                                <!-- Uploaded docs appear here -->
                            </div>
                            <button type="button"
                                class="mt-2 w-full flex items-center justify-center gap-2 border border-dashed border-slate-300 rounded-md p-3 text-slate-500 hover:bg-slate-50 text-sm"
                                onclick="document.getElementById('external-doc-upload').click()">
                                <i data-lucide="upload" class="w-4 h-4"></i> Add Credential/PD/Industry Currency
                            </button>
                            <input type="file" id="external-doc-upload" class="hidden" onchange="addExternalDoc(this)">
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 p-4 border-t border-slate-200 flex justify-end">
                    <button type="button"
                        class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 text-sm font-medium"
                        onclick="addParticipantFromModal()">Add to Event</button>
                </div>
            </div>
        </div>

        <!-- Modal: Doc Upload (Generic) -->
        <div id="modal-val-doc-upload"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[70] flex items-center justify-center p-4 hidden opacity-0"
            data-auto-name="false">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-md p-6 transform scale-95">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Upload Document</h3>
                <div class="space-y-4">
                    <div id="doc-name-container">
                        <label class="block text-sm font-medium text-slate-700">Document Name</label>
                        <input type="text"
                            class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="e.g. Assessment Mapping Matrix">
                    </div>
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-6 text-center hover:bg-slate-50 transition-colors cursor-pointer"
                        onclick="document.getElementById('upload-doc-file').click()">
                        <i data-lucide="upload-cloud" class="w-8 h-8 mx-auto text-slate-400 mb-2"></i>
                        <p class="text-sm text-slate-600 font-medium">Click to select file</p>
                        <p class="text-xs text-slate-400 mt-1">PDF, DOCX, XLSX up to 10MB</p>
                        <input type="file" id="upload-doc-file" class="hidden" onchange="handleModalFileSelect(this)">
                    </div>
                    <p id="file-name-display" class="text-sm text-blue-600 text-center font-medium hidden"></p>
                </div>
                <div class="flex justify-end gap-2 mt-6">
                    <button
                        class="bg-white text-slate-700 px-4 py-2 rounded-md border border-slate-300 hover:bg-slate-50"
                        onclick="closeModal('modal-val-doc-upload')">Cancel</button>
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700"
                        onclick="closeModal('modal-val-doc-upload')">Upload</button>
                </div>
            </div>
        </div>

        <!-- Add Continuous Improvement Modal -->
        <div id="modal-add-ci" class="modal fixed inset-0 z-50 hidden" style="z-index: 9999;">
            <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm"
                onclick="closeModal('modal-add-ci')">
            </div>
            <div class="modal-container bg-white w-full max-w-4xl mx-auto mt-10 rounded-lg shadow-2xl relative">
                <!-- Header -->
                <div
                    class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-blue-600 rounded-t-lg">
                    <h3 class="text-lg font-bold text-white">New Continuous Improvement</h3>
                    <button class="text-blue-100 hover:text-white transition-colors"
                        onclick="closeModal('modal-add-ci')">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Body -->
                <!-- Body -->
                <div class="p-6 overflow-y-auto max-h-[80vh]">
                    <form id="form-ci" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Row 1 -->
                            <div>
                                <label for="ci-date" class="block text-sm font-medium text-slate-700 mb-1">Date <span
                                        class="text-red-500">*</span></label>
                                <input type="date" id="ci-date"
                                    class="w-full px-4 py-2 bg-white text-slate-800 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 hover:border-blue-400 text-sm placeholder:text-slate-400">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Area of Operation</label>
                                <select id="ci-area"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="Training and Assessment" selected>Training and Assessment</option>
                                    <option value="Administration">Administration</option>
                                    <option value="Marketing">Marketing</option>
                                </select>
                            </div>

                            <!-- Row 2 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Raised By</label>
                                <select id="ci-raised-by"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="User" selected>User</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">User</label>
                                <select id="ci-user"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="David Jones" selected>David Jones (Trainer)</option>
                                    <option value="Sarah Chen">Sarah Chen (Compliance)</option>
                                    <option value="Michael Brown">Michael Brown (Assessor)</option>
                                </select>
                            </div>

                            <!-- Row 3 -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Relates to:</label>
                                <input type="text" id="ci-relates-to"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    value="Unit Code (Default)" placeholder="Enter Unit Code or Process">
                            </div>

                            <!-- Row 4 (Full Width) -->
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Area for
                                    Improvement</label>
                                <textarea id="ci-improvement-area" rows="4"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Suggested
                                    Improvement</label>
                                <textarea id="ci-suggested" rows="4"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                            </div>

                            <!-- Row 5 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Risk Impact</label>
                                <select id="ci-risk"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option>1 - Negligible</option>
                                    <option>2 - Minor</option>
                                    <option>3 - Moderate</option>
                                    <option>4 - Major</option>
                                    <option>5 - Catastrophic</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Expected
                                    Completion</label>
                                <input type="date" id="ci-completion"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>

                            <!-- Row 7 -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Status <span
                                        class="text-red-500">*</span></label>
                                <select id="ci-status"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option>New</option>
                                    <option>In Progress</option>
                                    <option>Completed</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="flex justify-end items-center px-6 py-4 border-t border-slate-200 bg-white rounded-b-lg">
                    <button type="button"
                        class="flex items-center gap-2 border border-slate-300 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-50 mr-3"
                        onclick="closeModal('modal-add-ci')">
                        <i data-lucide="x" class="w-4 h-4"></i> Cancel
                    </button>
                    <button type="button"
                        class="flex items-center gap-2 bg-blue-700 text-white px-4 py-2 rounded-md hover:bg-blue-800 shadow-sm"
                        onclick="saveCIRecord()">
                        <i data-lucide="save" class="w-4 h-4"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: Delete Confirmation Modal -->
        <div id="modal-delete-confirmation"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[90] flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 transform scale-95">
                <div class="flex items-center justify-center w-12 h-12 mx-auto bg-red-100 rounded-full mb-4">
                    <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                </div>
                <h3 class="text-lg font-bold text-center text-slate-900 mb-2">Delete Event</h3>
                <p id="delete-modal-msg" class="text-sm text-center text-slate-500 mb-6">Are you sure you want to
                    delete
                    this event?</p>

                <!-- Recurrence Options (Hidden by default) -->
                <div id="delete-recurrence-options" class="hidden mb-6 space-y-2">
                    <label
                        class="flex items-center gap-3 p-3 border border-slate-200 rounded-md cursor-pointer hover:bg-slate-50">
                        <input type="radio" name="delete-recurrence-opt" value="this" checked
                            class="text-red-600 focus:ring-red-500">
                        <span class="text-sm text-slate-700 font-medium">This event only</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 border border-slate-200 rounded-md cursor-pointer hover:bg-slate-50">
                        <input type="radio" name="delete-recurrence-opt" value="future"
                            class="text-red-600 focus:ring-red-500">
                        <span class="text-sm text-slate-700 font-medium">This and following events</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 border border-slate-200 rounded-md cursor-pointer hover:bg-slate-50">
                        <input type="radio" name="delete-recurrence-opt" value="past"
                            class="text-red-600 focus:ring-red-500">
                        <span class="text-sm text-slate-700 font-medium">This and past events</span>
                    </label>
                    <label
                        class="flex items-center gap-3 p-3 border border-slate-200 rounded-md cursor-pointer hover:bg-slate-50">
                        <input type="radio" name="delete-recurrence-opt" value="all"
                            class="text-red-600 focus:ring-red-500">
                        <span class="text-sm text-slate-700 font-medium">All events in series</span>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button"
                        class="flex-1 bg-white text-slate-700 px-4 py-2 rounded-md border border-slate-300 hover:bg-slate-50 font-medium"
                        onclick="closeModal('modal-delete-confirmation')">Cancel</button>
                    <button type="button"
                        class="flex-1 bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 font-medium"
                        onclick="executeDeleteEvent()">Delete</button>
                </div>
            </div>
        </div>

        <!-- Add Risk Modal -->
        <div id="modal-add-risk" class="modal fixed inset-0 z-50 hidden" style="z-index: 9999;">
            <div class="modal-overlay absolute inset-0 bg-black/50 backdrop-blur-sm"
                onclick="closeModal('modal-add-risk')">
            </div>
            <div class="modal-container bg-white w-full max-w-4xl mx-auto mt-10 rounded-lg shadow-2xl relative">
                <!-- Header -->
                <div
                    class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-blue-600 rounded-t-lg">
                    <h3 id="modal-risk-title" class="text-lg font-bold text-white">Add New Risk</h3>
                    <button class="text-blue-100 hover:text-white transition-colors"
                        onclick="closeModal('modal-add-risk')">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- Body -->
                <!-- Body -->
                <div class="p-6 overflow-y-auto max-h-[80vh]">
                    <form id="form-risk" class="space-y-6">
                        <!-- Hidden ID Field for Edit -->
                        <input type="hidden" id="risk-id">

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description <span
                                    class="text-red-500">*</span></label>
                            <textarea id="risk-description" rows="3"
                                class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                required placeholder="Describe the risk..."></textarea>
                        </div>

                        <!-- Added By & Source (Read-only) -->
                        <div
                            class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-slate-50 p-4 rounded-md border border-slate-200">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Added By</label>
                                <input type="text" id="risk-added-by" readonly
                                    class="block w-full border-slate-200 bg-slate-50 rounded-md shadow-sm px-3 py-2 text-sm text-slate-600 cursor-not-allowed"
                                    value="David Jones">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Source</label>
                                <input type="text" id="risk-source" readonly
                                    class="block w-full border-slate-200 bg-slate-50 rounded-md shadow-sm px-3 py-2 text-sm text-slate-600 cursor-not-allowed"
                                    placeholder="Meeting/Validation details will appear here">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Owner & Area -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Owner</label>
                                <select id="risk-owner"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                    <option value="David Jones">David Jones</option>
                                    <option value="Sarah Chen">Sarah Chen</option>
                                    <option value="Michael Brown">Michael Brown</option>
                                    <option value="Lois Trainer">Lois Trainer</option>
                                    <option value="Scott Rogers">Scott Rogers</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Area of
                                    Operation</label>
                                <select id="risk-area"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                    <option value="Training and Assessment">Training and Assessment</option>
                                    <option value="Administration">Administration</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Compliance">Compliance</option>
                                    <option value="Finance">Finance</option>
                                </select>
                            </div>

                            <!-- Status & Impact -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Status <i
                                        data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                                <select id="risk-status"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="Active" selected>Active</option>
                                    <option value="Closed">Closed</option>
                                    <option value="Monitored">Monitored</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Inherent Impact <i
                                        data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                                <select id="risk-impact"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                    <option value="1">1 - Negligible</option>
                                    <option value="2">2 - Minor</option>
                                    <option value="3">3 - Moderate</option>
                                    <option value="4">4 - Major</option>
                                    <option value="5">5 - Severe</option>
                                </select>
                            </div>

                            <!-- Likelihood & Review Date -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Inherent Likelihood <i
                                        data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                                <select id="risk-likelihood"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                    <option value="1">1 - Very Low</option>
                                    <option value="2">2 - Low</option>
                                    <option value="3">3 - Medium</option>
                                    <option value="4">4 - High</option>
                                    <option value="5">5 - Very High</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Review Date <i
                                        data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                                <input type="date" id="risk-review-date"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            </div>

                            <!-- Divisions & RTO Standards -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Divisions</label>
                                <select id="risk-division"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Standards <i
                                        data-lucide="info" class="w-3 h-3 text-slate-400 inline ml-1"></i></label>
                                <div id="risk-standards-container">
                                    <select id="risk-standards"
                                        class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                        disabled>
                                        <option value="">Select Division First</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Performance Indicators & link -->
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Performance
                                    Indicators</label>
                                <select id="risk-kpi"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                                    disabled>
                                    <option value="">Select Standard First</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Link System Document <i
                                        data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                                <select id="risk-doc-link"
                                    class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                                    <option value="">Please Select</option>
                                    <option value="Policy 1">Policy 1</option>
                                </select>
                            </div>
                        </div>

                        <!-- Upload -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Upload Document <i
                                    data-lucide="info" class="w-3 h-3 inline text-slate-400"></i></label>
                            <div
                                class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md bg-blue-50/50 hover:bg-blue-50 transition-colors">
                                <div class="space-y-1 text-center">
                                    <div class="text-sm text-slate-600">
                                        <span class="font-medium text-blue-600 hover:text-blue-500">Attach your
                                            supporting
                                            evidence here.</span>
                                        <p class="pl-1 text-xs">Drop file here or click to upload.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-end gap-3 rounded-b-lg">
                    <button type="button"
                        class="px-4 py-2 bg-white text-slate-700 font-medium rounded-lg border border-slate-300 hover:bg-slate-50 transition-colors"
                        onclick="closeModal('modal-add-risk')">
                        Cancel
                    </button>
                    <button type="button"
                        class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-sm"
                        onclick="saveRisk()">
                        <i data-lucide="save" class="w-4 h-4 inline mr-1"></i> Save
                    </button>
                </div>
            </div>
        </div>

        <!-- NEW: Meeting Type Info Modal -->
        <div id="modal-meeting-type-info"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div
                class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl p-0 transform scale-95 flex flex-col max-h-[85vh]">
                <!-- Header -->
                <div
                    class="flex justify-between items-center bg-slate-800 text-white px-6 py-4 rounded-t-lg flex-shrink-0">
                    <h3 class="text-lg font-semibold">Event Type Definitions</h3>
                    <button class="text-white hover:bg-slate-700 rounded-full p-1"
                        onclick="closeModal('modal-meeting-type-info')"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>

                <!-- Content -->
                <div class="overflow-y-auto p-6">
                    <div class="grid grid-cols-1 gap-4 text-sm text-slate-700">
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Appeal Management</strong>
                            Reviewing and adjudicating formal appeals lodged by students regarding assessment
                            decisions
                            or
                            academic outcomes.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Continuous Improvement</strong>
                            Systemic review of feedback (student/industry) and data to identify and implement
                            enhancements
                            to training operations.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Complaint Management</strong>
                            Addressing and resolving formal non-academic grievances raised by students, staff, or
                            external
                            parties.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Data and Reporting</strong>
                            Monitoring data integrity for AVETMISS reporting, quality indicators, and internal
                            compliance
                            metrics.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Executive Management</strong>
                            Strategic planning, governance oversight, and high-level decision-making regarding the
                            RTO's
                            direction.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Financial Management</strong>
                            Monitoring financial viability, fee protection mechanisms, and budget allocation for
                            training
                            resources.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Health, Safety & Wellbeing</strong>
                            Reviewing WHS/OHS compliance, hazard reporting, and ensuring a safe physical and digital
                            learning environment.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">HR Management</strong>
                            Managing recruitment, performance, and specifically ensuring Trainer/Assessor credential
                            compliance (matrices).
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Internal Audit</strong>
                            Conducting self-assurance audits against the Standards for RTOs to ensure ongoing
                            compliance.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Marketing</strong>
                            Reviewing marketing materials to ensure accuracy, transparency, and compliance with
                            consumer
                            protection laws.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Operations and Administration</strong>
                            Coordinating daily logistics, facility management, scheduling, and general
                            administrative
                            workflows.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Professional Development</strong>
                            Planning and tracking activities to ensure trainers maintain their vocational competency
                            and
                            VET
                            currency.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Quality & Compliance</strong>
                            General oversight of adherence to regulatory standards, policies, and legislative
                            requirements.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Regulatory and Registration</strong>
                            Managing scope of registration additions, renewals, and official communication with the
                            regulator (e.g., ASQA).
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Risk Management</strong>
                            Identifying operational or compliance risks and establishing mitigation strategies to
                            protect
                            the RTO.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Stakeholder Engagement</strong>
                            Consultations with industry representatives to ensure training and assessment strategies
                            align
                            with workplace needs.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Student Meeting</strong>
                            Individual or group sessions regarding academic progress, attendance interventions, or
                            disciplinary matters.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Student Support & Engagement</strong>
                            Reviewing support services (LLN), welfare needs, and initiatives to improve student
                            retention
                            and satisfaction.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Technology & Systems</strong>
                            Reviewing the performance, security, and integration of the LMS, SMS, and other IT
                            infrastructure.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Third-Party Management</strong>
                            Monitoring specific agreements and the performance of education agents, brokers, or
                            training
                            partners.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Training & Assessment</strong>
                            Reviewing TAS documents, assessment validation, moderation, and delivery methodologies.
                        </div>
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Pre-Assessment Validation</strong>
                            A quality assurance process undertaken before an assessment tool is used with learners
                            to
                            confirm that the assessment is fit for purpose, aligns with the training product
                            requirements,
                            and complies with the Standards for RTOs, including the Principles of Assessment and the
                            Rules
                            of Evidence.
                        </div>
                        <div>
                            <strong class="text-slate-900 block mb-1">Post-Assessment Validation</strong>
                            A session to validate assessment tools, a valid sample of completed candidate assessment
                            evidence, and assessor judgments against the principles of assessment and rules of
                            evidence
                            after assessment has been conducted.
                        </div>
                    </div>
                </div>

                <div class="flex justify-end items-center px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-lg">
                    <button type="button"
                        class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-300 font-medium"
                        onclick="closeModal('modal-meeting-type-info')">Close</button>
                </div>
            </div>
        </div>
        <!-- NEW: Validation Meeting Type Info Modal -->
        <div id="modal-validation-type-info"
            class="modal fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div
                class="modal-content bg-white rounded-lg shadow-2xl w-full max-w-2xl p-0 transform scale-95 flex flex-col max-h-[85vh]">
                <!-- Header -->
                <div
                    class="flex justify-between items-center bg-slate-800 text-white px-6 py-4 rounded-t-lg flex-shrink-0">
                    <h3 class="text-lg font-semibold">Validation Type Definitions</h3>
                    <button class="text-white hover:bg-slate-700 rounded-full p-1"
                        onclick="closeModal('modal-validation-type-info')"><i data-lucide="x"
                            class="w-5 h-5"></i></button>
                </div>

                <!-- Content -->
                <div class="overflow-y-auto p-6">
                    <div class="grid grid-cols-1 gap-4 text-sm text-slate-700">
                        <div class="border-b border-slate-100 pb-2">
                            <strong class="text-slate-900 block mb-1">Pre-Assessment Validation</strong>
                            A quality assurance process undertaken before an assessment tool is used with learners
                            to
                            confirm that the assessment is fit for purpose, aligns with the training product
                            requirements,
                            and complies with the Standards for RTOs, including the Principles of Assessment and the
                            Rules
                            of Evidence.
                        </div>
                        <div>
                            <strong class="text-slate-900 block mb-1">Post-Assessment Validation</strong>
                            A session to validate assessment tools, a valid sample of completed candidate assessment
                            evidence, and assessor judgments against the principles of assessment and rules of
                            evidence
                            after assessment has been conducted.
                        </div>
                    </div>
                </div>

                <div class="flex justify-end items-center px-6 py-4 border-t border-slate-200 bg-slate-50 rounded-b-lg">
                    <button type="button"
                        class="bg-slate-200 text-slate-700 px-4 py-2 rounded-md hover:bg-slate-300 font-medium"
                        onclick="closeModal('modal-validation-type-info')">Close</button>
                </div>
            </div>
        </div>

        <!-- Hidden Folder Input for dynamic use -->
        <input type="file" id="hidden-folder-input" webkitdirectory directory multiple class="hidden">

        <script>
            console.log("SCRIPT TAG STARTED - Parsing...");
            document.addEventListener('DOMContentLoaded', () => {
                console.log("DOMContentLoaded FIRED");
                window.onerror = function (msg, url, line) {
                    console.error("GLOBAL ERROR CAUGHT: " + msg + " at " + line);
                };


                try {
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        lucide.createIcons();
                    }
                } catch (e) { console.warn('Lucide failed:', e); }
                console.log("Compliance Calendar: DOM Loaded");

                // --- 1. Global Data Definitions (Defined early to prevent TDZ errors) ---
                const filterPrograms = ['CHC33015 - Certificate III in Individual Support', 'SIT30816 - Cert III Commercial Cookery', 'BSB50215 - Diploma of Business', 'TAE40122 - Certificate IV in Training and Assessment'];
                const filterUnits = ['CHCAGE001', 'CHCCCS015', 'HLTAID011', 'TAEDES401', 'BSBSMB401'];
                const filterOrgUnits = ['Commercial Cookery Dept', 'Individual Support Dept', 'Business Faculty', 'First Aid Team'];
                const filterCompanies = ['Acme Hospitality', 'Care Plus', 'Tech Innovations', 'Global Training Solutions'];
                const filterPeople = ['David Jones', 'Sarah Chen', 'Michael Brown', 'Emily White', 'Jessica Davis'];
                const filterContacts = ['John Smith (Acme)', 'Jane Doe (Care Plus)', 'Bob Wilson (Tech)'];
                const filterStudents = ['Student 1', 'Student 2', 'Student 3', 'Student 4', 'Student 5'];


                const filterMeetingTypes = ['Validation', 'General Meeting', 'Moderation', 'Audit Preparation', 'Professional Development'];

                // NEW: Global Event Store and State
                // NEW: Global Event Store and State
                window.allEvents = [
                    {
                        title: 'Validation: CHC33015',
                        start: '2026-01-15T09:00:00',
                        end: '2026-01-15T11:00:00',
                        location: 'Room 304',
                        type: 'Post-Assessment Validation',
                        color: '#F2A7A7',
                        extendedProps: {
                            description: 'Post-assessment validation session for Certificate III in Individual Support focusing on evidence samples from recent cohort assessments. Review of assessment tools, candidate evidence, and assessor judgments against principles of assessment.',
                            unit: 'CHC33015',
                            validationType: 'Post-Assessment Validation',
                            program: 'CHC33015 - Certificate III in Individual Support (Risk: Medium)',
                            units: ['CHCAGE001 - Facilitate empowerment (Risk: Low)'],
                            orgUnit: 'Individual Support Dept',
                            company: 'Care Plus',
                            participants: [
                                { name: 'Sarah Chen', role: 'Compliance Manager', status: 'Confirmed', industryCurrency: true, trainerCredential: true },
                                { name: 'David Jones', role: 'Lead Validator', status: 'Confirmed', industryCurrency: true, professionalDevelopment: true, trainerCredential: true, independent: true },
                                { name: 'Michael Brown', role: 'Quality Officer', status: 'Invited', industryCurrency: true },
                                { name: 'Scott Rogers', role: 'CEO', type: 'external', email: 'scott@eskilled.com.au', organization: 'External Expert', status: 'Pending', independent: true, industryCurrency: true, trainerCredential: true }
                            ],
                            sampleSize: 15,
                            rplSampleSize: 3,
                            uploadAssessmentType: 'lms', // Trigger LMS view
                            cohortSize: 45,
                            reminder: {
                                enabled: true,
                                value: 24,
                                unit: 'hours',
                                type: 'email'
                            },
                            documents: [
                                { name: 'Assessment Tool Package.pdf', size: '2.3 MB', type: 'assessment-tool' },
                                { name: 'Evidence Samples.zip', size: '15.7 MB', type: 'evidence' },
                                { name: 'Validation Checklist.docx', size: '145 KB', type: 'checklist' },
                                { name: 'Validation Report - Draft.pdf', size: '1.2 MB', type: 'report' }
                            ],
                            standards: {
                                selected: ["Standard 1 - Clause 1.1", "Standard 1 - Clause 1.8", "Standard 2 - Clause 2.1"]
                                // In a real app this would map to checkboxes
                            },
                            actions: [
                                { action: 'Review assessment mapping for Unit CHC33015', owner: 'David Jones', dueDate: '2026-02-01', status: 'In Progress', priority: 'High' },
                                { action: 'Update validation policy v2.1', owner: 'Sarah Chen', dueDate: '2026-02-15', status: 'Pending', priority: 'Medium' }
                            ],
                            ci: [
                                { area: 'Training and Assessment', description: 'Streamline evidence collection process using digital portfolio', raisedBy: 'David Jones', date: '2026-01-10', status: 'Proposed', priority: 'Medium' }
                            ],
                            risk: [
                                { description: 'Potential non-compliance in assessment tool versioning', likelihood: 'Likely', impact: 'Moderate', rating: 'High', mitigation: 'Implement strict version control on SharePoint', status: 'Open' }
                            ],
                            report: {
                                executiveSummary: 'This validation session reviewed 15 assessment samples from CHC33015 - Certificate III in Individual Support. Overall compliance was found to be satisfactory with minor recommendations for improvement in evidence collection procedures. Assessment tools were verified as current and mapped to the training package requirements.',
                                recommendations: '1. Implement digital portfolio system for student evidence collection\n2. Update assessment mapping documents to reflect latest training package release\n3. Conduct assessor calibration session within 30 days\n4. Review and update assessment rubrics for clarity'
                            }
                        }
                    },
                    {
                        title: 'Team Meeting',
                        start: '2026-01-16T14:00:00',
                        end: '2026-01-16T15:00:00',
                        location: 'Conference Room A',
                        type: 'General Meeting',
                        color: '#a855f7',
                        extendedProps: {
                            description: 'Weekly team synchronization meeting to discuss ongoing projects, address blockers, and coordinate upcoming validation activities. Review of quality metrics and continuous improvement initiatives.',
                            meetingType: 'General Meeting',
                            chairperson: 'David Jones',
                            minuteTaker: 'Sarah Chen',
                            internalParticipants: [
                                { name: 'David Jones', role: 'Team Lead' },
                                { name: 'Sarah Chen', role: 'Senior Assessor' },
                                { name: 'Michael Brown', role: 'Quality Officer' },
                                { name: 'Emily White', role: 'Assessor' }
                            ],
                            externalParticipants: [
                                {
                                    name: 'Dr. Patricia Martinez',
                                    email: 'p.martinez@asqa.gov.au',
                                    organization: 'ASQA',
                                    role: 'Quality Advisor'
                                }
                            ],
                            agenda: [
                                { item: 'Review previous meeting minutes and actions', duration: 10, description: 'Go through action items from previous week. Status check on item 3.4.' },
                                {
                                    item: 'Quality metrics update for Q4 2025',
                                    duration: 15,
                                    description: 'Presentation of Q4 metrics. Discussion on completion rates and student feedback.',
                                    subItems: [
                                        { item: 'Q3 vs Q4 comparison data', duration: 5 },
                                        { item: 'Student satisfaction survey results', duration: 5 }
                                    ]
                                },
                                {
                                    item: 'Upcoming validation schedule review',
                                    duration: 20,
                                    description: 'Plan validation sessions for Q1 2026. Prioritize high-risk units.',
                                    subItems: [
                                        { item: 'CHC33015 unit validation plan', duration: 10 },
                                        { item: 'Assessor allocation review', duration: 5 }
                                    ]
                                },
                                { item: 'Continuous improvement initiatives', duration: 10, description: 'Discuss implementation of new student portal feedback tool.' },
                                { item: 'Any other business', duration: 5, description: 'Open floor for general questions and announcements.' }
                            ],
                            reminder: {
                                enabled: true,
                                value: 30,
                                unit: 'minutes',
                                type: 'both'
                            },
                            recurrence: {
                                enabled: true,
                                frequency: 'weekly',
                                interval: 1,
                                daysOfWeek: ['Friday'],
                                endType: 'after',
                                occurrences: 12
                            },
                            minutes: {
                                'item-0': 'Minutes from previous meeting approved without amendment. Action items review: Sarah completed the RTO Standards map.',
                                'item-1': 'Q4 2025 metrics show a 15% increase in completion rates. Student satisfaction remains high at 4.8/5.',
                                'item-2': 'Upcoming validation schedule distributed. Focus on CHC33015 units next month.',
                                'item-3': 'Discussed new feedback loop implementation. David to draft procedure.'
                            },
                            standards: [
                                "Standard 1.1 - Training is engaging, well-structured and enables VET students to attain skills and knowledge consistent with the training product.",
                                "Standard 1.2 - Engagement with industry, employer and community representatives effectively informs the industry relevance of training.",
                                "Standard 2.2 - VET students are advised, prior to enrolment, about the suitability of the training product for them."
                            ],
                            actions: [
                                { action: 'Draft new student feedback form', owner: 'David Jones', dueDate: '2026-01-20', status: 'Open' },
                                { action: 'Coordinate external audit dates', owner: 'Sarah Chen', dueDate: '2026-01-25', status: 'In Progress' }
                            ],
                            ci: [
                                { area: 'Student Support', description: 'Implement automated SMS reminders for class attendance', raisedBy: 'Emily White', date: '2026-01-05', status: 'In Progress' }
                            ],
                            risk: [
                                { description: 'Trainer availability for Q1 2026', likelihood: 'Possible', impact: 'Major', rating: 'Medium', mitigation: 'Hire casual trainers for backup' }
                            ]
                        }
                    },
                    {
                        title: 'Audit Prep',
                        start: '2026-01-20T10:00:00',
                        end: '2026-01-20T16:00:00',
                        location: 'Online (Zoom)',
                        type: 'Audit Preparation',
                        color: '#f59e0b',
                        extendedProps: {
                            description: 'Comprehensive preparation session for upcoming ASQA regulatory audit. Review of all compliance documentation, validation records, continuous improvement evidence, and quality assurance processes. Mock audit scenarios and preparation of evidence portfolios.',
                            meetingType: 'Audit Preparation',
                            chairperson: 'David Jones',
                            minuteTaker: 'Michael Brown',
                            internalParticipants: [
                                { name: 'David Jones', role: 'RTO Manager' },
                                { name: 'Sarah Chen', role: 'Compliance Coordinator' },
                                { name: 'Michael Brown', role: 'Quality Assurance Manager' },
                                { name: 'Emily White', role: 'Training Manager' },
                                { name: 'Jessica Davis', role: 'Administration Officer' }
                            ],
                            externalParticipants: [
                                {
                                    name: 'Jennifer Thompson',
                                    email: 'j.thompson@auditconsult.com.au',
                                    organization: 'Audit Consulting Partners',
                                    role: 'Lead Auditor (Mock)'
                                },
                                {
                                    name: 'Robert Chang',
                                    email: 'r.chang@auditconsult.com.au',
                                    organization: 'Audit Consulting Partners',
                                    role: 'Compliance Specialist'
                                }
                            ],
                            agenda: [
                                {
                                    item: 'Overview of ASQA audit scope and requirements',
                                    duration: 30,
                                    description: 'Detailed walkthrough of the audit notification letter and scope of registration to be audited.',
                                    subItems: [
                                        { item: 'Review audit notification letter', completed: true },
                                        { item: 'Identify scope of registration', completed: true },
                                        { item: 'Assign documentation responsibilities', completed: false }
                                    ]
                                },
                                {
                                    item: 'Review of validation documentation and records',
                                    duration: 60,
                                    description: 'Check all validation plans and reports for the last 12 months. Ensure signatures are present.',
                                    subItems: [
                                        { item: 'Check validation plans', completed: true },
                                        { item: 'Verify validation reports', completed: false },
                                        { item: 'Confirm all signatures present', completed: false }
                                    ]
                                },
                                {
                                    item: 'Assessment tool compliance check',
                                    duration: 45,
                                    description: 'Random sampling of assessment tools for HLTAID011 and BSBADM405. Check mapping documents.',
                                    subItems: [
                                        { item: 'Review HLTAID011 assessment tools', completed: true },
                                        { item: 'Review BSBADM405 assessment tools', completed: false }
                                    ]
                                },
                                {
                                    item: 'Quality assurance and continuous improvement evidence',
                                    duration: 45,
                                    description: 'Review CI register. Ensure all closed items have evidence of implementation.',
                                    subItems: [
                                        { item: 'Verify CI register entries', completed: true },
                                        { item: 'Check evidence for closed items', completed: true }
                                    ]
                                },
                                { item: 'Mock audit walkthrough', duration: 90, description: 'Conduct mock interviews with trainers. Simulate file request process.' },
                                { item: 'Action items and final preparations', duration: 30, description: 'Assign tasks for final week before audit. Schedule daily stand-ups.' }
                            ],
                            reminder: {
                                enabled: true,
                                value: 2,
                                unit: 'days',
                                type: 'email'
                            },
                            minutes: {
                                'item-0': 'Reviewed ASQA audit scope. Focus areas identified: Assessment Validation and Trainer Currency.',
                                'item-0-sub-0': 'Audit notification letter reviewed by all parties.',
                                'item-0-sub-1': 'Scope of registration confirmed: CHC33015, SIT30816.',
                                'item-0-sub-2': 'Documentation responsibilities assigned to department heads.',
                                'item-1': 'Validation records for the past 12 months were reviewed. 95% complete. Remaining 5% assigned to Sarah.',
                                'item-1-sub-0': 'All validation plans confirmed complete.',
                                'item-1-sub-1': 'Pending reports to be completed by Friday.',
                                'item-1-sub-2': 'Missing signatures identified on 3 documents.',
                                'item-2': 'Assessment tools for HLTAID011 checked against mapping. Minor gaps found in practical observation checklist.',
                                'item-2-sub-0': 'HLTAID011 tools fully compliant.',
                                'item-2-sub-1': 'BSBADM405 requires minor updates to checklist.',
                                'item-3': 'CI register is up to date. Evidence folders created for recent improvements.',
                                'item-3-sub-0': 'All CI entries verified.',
                                'item-3-sub-1': 'Evidence folders organized by date.',
                                'item-4': 'Mock audit conducted. Result: Satisfactory in 3 standards, minor non-compliance in 1 (rectified during session).'
                            },
                            standards: [
                                "Standard 1.3 - The assessment system is fit-for-purpose and consistent with the training product.",
                                "Standard 1.4 - The assessment system ensures assessment is conducted in a way that is fair and appropriate and enables accurate assessment judgement.",
                                "Standard 1.5 - The assessment system is quality assured by appropriately skilled and credentialled persons through a regular process of validating assessment practices and judgements."
                            ],
                            documents: [
                                { name: 'ASQA Audit Checklist 2025.pdf', size: '890 KB' },
                                { name: 'Compliance Evidence Portfolio.zip', size: '45.2 MB' },
                                { name: 'Previous Audit Report.pdf', size: '1.8 MB' }
                            ],
                            actions: [
                                { action: 'Complete self-assessment checklist', owner: 'David Jones', dueDate: '2026-01-18', status: 'In Progress' },
                                { action: 'Upload finalized validation reports', owner: 'Sarah Chen', dueDate: '2026-01-19', status: 'Pending' }
                            ],
                            ci: [
                                { area: 'Compliance', description: 'New digital evidence storage system fully operational', raisedBy: 'Michael Brown', date: '2026-01-15', status: 'Implemented' }
                            ],
                            risk: [
                                { description: 'Missing signed validation outcomes', likelihood: 'Unlikely', impact: 'Critical', rating: 'High', mitigation: 'Double-check all uploaded PDFs' }
                            ]
                        }
                    },
                ];
                window.selectedDate = null; // To store clicked date


                // NEW: Meeting Type Colors Map
                const meetingTypeColors = {
                    'Appeal Management': '#F4C2C2',
                    'Complaint Management': '#F6D6D6',
                    'Continuous Improvement': '#E9F7EF',
                    'Data and Reporting': '#D9E8F5',
                    'Executive Management': '#DADFF7',
                    'Financial Management': '#E6F0E6',
                    'Health, Safety & Wellbeing': '#B6E6E6',
                    'HR Management': '#E0E6FA',
                    'Internal Audit': '#DDBBF7',
                    'Marketing': '#EAD1DC',
                    'Operations and Administration': '#E7E7E7',
                    'Professional Development': '#FBF3F8',
                    'Quality & Compliance': '#CFE9E4',
                    'Regulatory and Registration': '#B7CDEB',
                    'Risk Management': '#F386B6',
                    'Stakeholder Engagement': '#D6F0E2',
                    'Strategic Planning': '#C9CCF8',
                    'Student Meeting': '#CFF6D6',
                    'Student Support & Engagement': '#D9F2E6',
                    'Technology & Systems': '#D6C4FB',
                    'Third-Party Management': '#F8F6D6',
                    'Training & Assessment': '#F6C1BC',
                    'Post-Assessment Validation': '#F2A7A7',
                    'Pre-Assessment Validation': '#FFF4BD'
                };

                // --- 2. Helper Functions ---

                // RESTORED: Formats options with risk badges
                function formatOptionText(text) {
                    if (!text) return text;
                    const riskMatch = text.match(/\(Risk:\s*(High|Medium|Low)\)/i);
                    if (riskMatch) {
                        const level = riskMatch[1].toLowerCase();
                        let colorClass = 'bg-slate-100 text-slate-800 border-slate-200';
                        if (level === 'high') colorClass = 'bg-red-100 text-red-800 border-red-200';
                        if (level === 'medium') colorClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                        if (level === 'low') colorClass = 'bg-green-100 text-green-800 border-green-200';

                        const badge = `<span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium border ${colorClass} ml-2 uppercase tracking-wide">Risk: ${riskMatch[1]}</span>`;
                        return text.replace(riskMatch[0], '').trim() + badge;
                    }
                    return text;
                }

                // NEW: Get Presenter Options
                function getPresenterOptions() {
                    return filterPeople.map(p => `<option>${p}</option>`).join('');
                }

                // NEW: Get RTE HTML
                function getRTEHtml(heightClass, placeholder, value = '') {
                    return `
                <div class="rich-text-editor border border-slate-300 rounded-md bg-white">
                    <div class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                        <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                        <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                        <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="insertUnorderedList"><i data-lucide="list" class="w-4 h-4"></i></button>
                    </div>
                    <div class="rich-text-editor-content p-3 ${heightClass} outline-none text-sm" contenteditable="true" data-placeholder="${placeholder}">${value}</div>
                </div>`;
                }

                // RESTORED: Handles participant card visibility
                function triggerMeetingParticipantUpdates() {
                    console.log("Entering TriggerUpdates");
                    const meetingPartSelect = document.getElementById('meeting-participant-type-select');
                    const container = document.getElementById('meeting-participant-cards');
                    if (meetingPartSelect && container) {
                        const selected = Array.from(meetingPartSelect.querySelectorAll('.multi-select-tag span')).map(s => s.textContent);

                        const hasStaff = container.querySelector('#card-staff');
                        const hasOrg = container.querySelector('#card-org');
                        const hasCompany = container.querySelector('#card-company');
                        const hasStudent = container.querySelector('#card-student');

                        // Staff
                        if (selected.includes('Staff') && !hasStaff) {
                            const div = document.createElement('div');
                            div.id = 'card-staff';
                            div.className = "participant-card bg-white border border-slate-200 p-4 rounded-lg";
                            div.innerHTML = `
                            <h5 class="font-semibold text-slate-700 mb-2">Invite Staff</h5>
                            <div><label class="block text-sm font-medium text-slate-600">Select From People</label><div id="invite-staff-people-select" class="multi-select-container mt-1"></div></div>`;
                            container.appendChild(div);
                            // Data arrays are now defined at the top, so this is safe
                            createDynamicMultiSelect('invite-staff-people-select', filterPeople);
                        } else if (!selected.includes('Staff') && hasStaff) {
                            hasStaff.remove();
                        }

                        // Org Unit
                        if (selected.includes('Org Unit') && !hasOrg) {
                            const div = document.createElement('div');
                            div.id = 'card-org';
                            div.className = "participant-card bg-white border border-slate-200 p-4 rounded-lg";
                            div.innerHTML = `
                            <h5 class="font-semibold text-slate-700 mb-2">Invite Org Unit</h5>
                            <div><label class="block text-sm font-medium text-slate-600">Select Org Units</label><div id="invite-org-select" class="multi-select-container mt-1"></div></div>`;
                            container.appendChild(div);
                            createDynamicMultiSelect('invite-org-select', filterOrgUnits);
                        } else if (!selected.includes('Org Unit') && hasOrg) {
                            hasOrg.remove();
                        }

                        // Student
                        if (selected.includes('Student') && !hasStudent) {
                            const div = document.createElement('div');
                            div.id = 'card-student';
                            div.className = "participant-card bg-white border border-slate-200 p-4 rounded-lg";
                            div.innerHTML = `
                            <h5 class="font-semibold text-slate-700 mb-2">Invite Students</h5>
                            <div><label class="block text-sm font-medium text-slate-600">Select Students</label><div id="invite-student-select" class="multi-select-container mt-1"></div></div>`;
                            container.appendChild(div);
                            createDynamicMultiSelect('invite-student-select', filterStudents);
                        } else if (!selected.includes('Student') && hasStudent) {
                            hasStudent.remove();
                        }

                        // Company
                        if (selected.includes('Company') && !hasCompany) {
                            const div = document.createElement('div');
                            div.id = 'card-company';
                            div.className = "participant-card bg-white border border-slate-200 p-4 rounded-lg";
                            div.innerHTML = `
                            <h5 class="font-semibold text-slate-700 mb-2">Invite Company</h5>
                            <div class="mb-3"><label class="block text-sm font-medium text-slate-600">Select Company</label><div id="invite-company-select" class="multi-select-container mt-1"></div></div>
                            <div id="company-contact-container" class="hidden border-t border-slate-100 pt-3">
                                <h5 class="font-semibold text-slate-700 mb-2">Company Contacts</h5>
                                <div><label class="block text-sm font-medium text-slate-600">Select Contacts</label><div id="invite-contact-select" class="multi-select-container mt-1"></div></div>
                            </div>
                        `;
                            container.appendChild(div);
                            createDynamicMultiSelect('invite-company-select', filterCompanies);
                            createDynamicMultiSelect('invite-contact-select', filterContacts);

                            const companySelect = document.getElementById('invite-company-select');
                            const contactContainer = document.getElementById('company-contact-container');
                            if (companySelect && contactContainer) {
                                const companyObserver = new MutationObserver(() => {
                                    const companiesSelected = companySelect.querySelectorAll('.multi-select-tag').length > 0;
                                    if (companiesSelected) contactContainer.classList.remove('hidden');
                                    else contactContainer.classList.add('hidden');
                                });
                                companyObserver.observe(companySelect, { childList: true, subtree: true });
                            }
                        } else if (!selected.includes('Company') && hasCompany) {
                            hasCompany.remove();
                        }
                    }
                }

                // Helper to update dropdown options visibility
                function refreshDropdown(dropdown, wrapper, search) {
                    const searchText = search.value.toLowerCase();
                    const selectedTags = Array.from(wrapper.querySelectorAll('.multi-select-tag span')).map(s => s.textContent);

                    Array.from(dropdown.children).forEach(child => {
                        const optionText = child.textContent;
                        const isSelected = selectedTags.includes(optionText);
                        const matchesSearch = optionText.toLowerCase().includes(searchText);

                        if (isSelected) {
                            child.style.display = 'none';
                        } else {
                            child.style.display = matchesSearch ? 'block' : 'none';
                        }
                    });
                }

                // --- 3. Component Initialization Logic ---
                function createDynamicMultiSelect(containerId, options, initialValues = []) {
                    console.log("Entering DMS: " + containerId);
                    const container = document.getElementById(containerId);
                    if (!container) return;
                    if (!Array.isArray(options)) {
                        console.error("DMS Error: Options is not array for " + containerId, options);
                        return;
                    }

                    const wrapper = document.createElement('div');
                    wrapper.className = 'multi-select-input';

                    const search = document.createElement('input');
                    search.className = 'multi-select-search';
                    search.placeholder = 'Select...';

                    const chevron = document.createElement('i');
                    chevron.setAttribute('data-lucide', 'chevron-down');
                    chevron.className = 'select-chevron';

                    wrapper.appendChild(search);
                    container.appendChild(wrapper);
                    container.appendChild(chevron);

                    const dropdown = document.createElement('div');
                    dropdown.className = 'multi-select-dropdown';
                    // Append dropdown to body to escape overflow clipping
                    document.body.appendChild(dropdown);

                    options.forEach(opt => {
                        const item = document.createElement('div');
                        item.innerHTML = formatOptionText(opt);
                        item.onclick = () => addTag(opt, wrapper, search, dropdown, containerId);
                        dropdown.appendChild(item);
                    });

                    // Positioning Logic
                    function positionDropdown() {
                        const rect = wrapper.getBoundingClientRect();
                        dropdown.style.top = (rect.bottom + window.scrollY) + 'px';
                        dropdown.style.left = (rect.left + window.scrollX) + 'px';
                        dropdown.style.width = rect.width + 'px';
                        dropdown.style.position = 'absolute'; // Absolute relative to document body works like fixed but scrolls with page
                    }

                    // Filter logic
                    search.addEventListener('input', (e) => {
                        refreshDropdown(dropdown, wrapper, search);
                        positionDropdown();
                        dropdown.classList.add('show');
                    });

                    search.addEventListener('focus', () => {
                        refreshDropdown(dropdown, wrapper, search);
                        positionDropdown();
                        dropdown.classList.add('show');
                    });

                    // Hide on scroll to prevent detachment issues
                    window.addEventListener('scroll', () => {
                        if (dropdown.classList.contains('show')) {
                            // Optional: reposition or hide
                            positionDropdown();
                        }
                    }, true); // Capture phase to catch modal scrolls

                    document.addEventListener('click', (e) => {
                        if (!container.contains(e.target) && !dropdown.contains(e.target)) dropdown.classList.remove('show');
                    });

                    // Resize listener
                    window.addEventListener('resize', () => {
                        if (dropdown.classList.contains('show')) positionDropdown();
                    });

                    function addTag(text, wrapper, input, dropdown, id) {
                        // Fix: Check data-value for robust duplication check
                        const existingTags = Array.from(wrapper.querySelectorAll('.multi-select-tag')).map(t => t.getAttribute('data-value') || t.textContent);
                        if (existingTags.includes(text)) {
                            input.value = '';
                            refreshDropdown(dropdown, wrapper, input);
                            dropdown.classList.remove('show');
                            return;
                        }

                        const tag = document.createElement('div');
                        tag.className = 'multi-select-tag'; // Base class
                        tag.setAttribute('data-value', text); // Fix: Store raw value

                        // NEW: Apply colors if meeting type
                        if (meetingTypeColors[text]) {
                            tag.style.backgroundColor = meetingTypeColors[text];
                            tag.style.color = '#1e293b'; // slate-800 for contrast
                            tag.classList.add('rounded-full', 'px-3', 'py-1', 'text-xs', 'font-semibold', 'border', 'border-transparent');
                            tag.style.borderColor = 'transparent';
                        }

                        // NEW: Apply colors based on Risk Rating text
                        const riskMatch = text.match(/\(Risk:\s*(High|Medium|Low)\)/i);
                        if (riskMatch) {
                            const riskLevel = riskMatch[1].toLowerCase();
                            // Ensure base styling for risk tags
                            tag.classList.add('rounded-full', 'px-3', 'py-1', 'text-xs', 'font-semibold', 'border');
                            if (riskLevel === 'high') {
                                tag.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
                            } else if (riskLevel === 'medium') {
                                tag.classList.add('bg-amber-100', 'text-amber-800', 'border-amber-200');
                            } else if (riskLevel === 'low') {
                                tag.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
                            }
                        }

                        tag.innerHTML = `<span>${formatOptionText(text)}</span><button type="button"></button>`;

                        tag.querySelector('button').onclick = function (e) {
                            e.stopPropagation();
                            this.parentElement.remove();
                            // Trigger logic for Meeting Modal observer
                            if (id === 'meeting-participant-type-select') {
                                triggerMeetingParticipantUpdates();
                            }

                            // UPDATED: Logic for removing Validation tags
                            if (id === 'validation-meeting-type-select') {
                                // ... (Specific validation logic if needed, currently unused as Validation is Select)
                                const samplesTab = document.querySelector('[data-val-tab="student-assessments"]');
                                const rplTab = document.querySelector('[data-val-tab="rpl"]');
                                if (text === 'Pre-Assessment Validation') {
                                    // If removing Pre-Assessment, Show tabs
                                    if (samplesTab) samplesTab.classList.remove('hidden');
                                    if (rplTab) rplTab.classList.remove('hidden');
                                }

                                // NEW: Update Standards on removal
                                handleValidationTypeAutoPopulation();
                            }
                        };

                        wrapper.insertBefore(tag, input);
                        dropdown.classList.remove('show');
                        input.value = '';

                        if (id === 'meeting-participant-type-select') {
                            triggerMeetingParticipantUpdates();
                        }

                        // UPDATED: Trigger logic for Validation Meeting Type
                        if (id === 'validation-meeting-type-select') {
                            const isPreAssessment = text === 'Pre-Assessment Validation';
                            const samplesTab = document.querySelector('[data-val-tab="student-assessments"]');
                            const rplTab = document.querySelector('[data-val-tab="rpl"]');

                            if (isPreAssessment) {
                                if (samplesTab) samplesTab.classList.add('hidden');
                                if (rplTab) rplTab.classList.add('hidden');
                                // If hiding active tab, switch to details
                                if (samplesTab && samplesTab.classList.contains('active')) switchValTab('details');
                                if (rplTab && rplTab.classList.contains('active')) switchValTab('details');
                            } else {
                                if (samplesTab) samplesTab.classList.remove('hidden');
                                if (rplTab) rplTab.classList.remove('hidden');
                            }

                            // NEW: Auto-populate Standards
                            handleValidationTypeAutoPopulation();
                        }
                    }

                    initialValues.forEach(val => addTag(val, wrapper, search, dropdown, containerId));
                    // if (typeof lucide !== 'undefined') lucide.createIcons();
                    console.log("Exiting DMS: " + containerId);
                }

                // --- 4. Initialize Components ---

                // Mock Data
                const unitOptions = [
                    'HLTAID011 - Provide First Aid (Risk: High)', // High
                    'CHCCCS015 - Provide high quality service (Risk: Medium)', // Medium
                    'CHCAGE001 - Facilitate empowerment (Risk: Low)', // Low
                    'BSBSMB401 - Establish legal and risk management requirements',
                    'TAEDES401 - Design and develop learning programs'
                ];
                createDynamicMultiSelect('units-multi-select', unitOptions);

                const programOptions = [
                    'SIT30816 - Cert III Commercial Cookery (Risk: High)',
                    'CHC33015 - Certificate III in Individual Support (Risk: Medium)',
                    'BSB50215 - Diploma of Business (Risk: Low)',
                    'TAE40122 - Certificate IV in Training and Assessment'
                ];
                createDynamicMultiSelect('event-program-select', programOptions);

                // NEW: Disable Units until Program Selected
                const programSelect = document.getElementById('event-program-select');
                // Assuming 'units-multi-select' matches what createDynamicMultiSelect('units-multi-select'...) created
                const unitSelectWrapper = document.getElementById('units-multi-select');

                if (programSelect && unitSelectWrapper) {
                    const toggleUnitSelect = () => {
                        const tags = programSelect.querySelectorAll('.multi-select-tag');
                        if (tags.length > 0) {
                            unitSelectWrapper.classList.remove('opacity-50', 'pointer-events-none');
                        } else {
                            unitSelectWrapper.classList.add('opacity-50', 'pointer-events-none');
                        }
                    };

                    const observer = new MutationObserver(toggleUnitSelect);
                    observer.observe(programSelect, { childList: true, subtree: true });
                    toggleUnitSelect();
                }

                const meetingTypes = [
                    'Appeal Management', 'Continuous Improvement', 'Complaint Management',
                    'Data and Reporting', 'Executive Management', 'Financial Management',
                    'Health, Safety & Wellbeing', 'HR Management', 'Internal Audit',
                    'Marketing', 'Operations and Administration', 'Pre-Assessment Validation', 'Professional Development',
                    'Post-Assessment Validation', 'Quality & Compliance', 'Regulatory and Registration', 'Risk Management',
                    'Stakeholder Engagement', 'Strategic Planning', 'Student Meeting', 'Student Support & Engagement',
                    'Technology & Systems', 'Third-Party Management', 'Training & Assessment'
                ];
                createDynamicMultiSelect('meeting-type-select', meetingTypes);

                // const validationMeetingTypes = ['Pre-Assessment Validation', 'Post-Assessment Validation'];
                // createDynamicMultiSelect('validation-meeting-type-select', validationMeetingTypes); // Element is now a native Select

                // Validation Scope Init
                // Removed redundant init calls that caused duplication. Relying on lines 4534/4542.
                // if (typeof filterPrograms !== 'undefined') createDynamicMultiSelect('event-program-select', filterPrograms);
                // if (typeof filterUnits !== 'undefined') createDynamicMultiSelect('units-multi-select', filterUnits);

                const trainerOptions = ['David Jones', 'Emily White', 'Michael Brown', 'Sarah Chen', 'Jessica Davis'];
                createDynamicMultiSelect('student-assessments-trainers-select', trainerOptions, ['David Jones', 'Sarah Chen']);
                createDynamicMultiSelect('rpl-assessments-trainers-select', trainerOptions);

                const outcomeOptions = ['Competent', 'Not Yet Competent', 'Withdrawn', 'RPL Granted', 'Credit Transfer'];
                createDynamicMultiSelect('outcome-types-select', outcomeOptions, ['Competent', 'Not Yet Competent']);
                createDynamicMultiSelect('rpl-outcome-types-select', outcomeOptions);

                createDynamicMultiSelect('action-assign-select', trainerOptions);

                // Filter Components
                console.log("FP Type: " + typeof filterPrograms);
                createDynamicMultiSelect('filter-program-select', filterPrograms);
                createDynamicMultiSelect('filter-unit-select', filterUnits);
                createDynamicMultiSelect('filter-org-unit-select', filterOrgUnits);
                createDynamicMultiSelect('filter-company-select', filterCompanies);
                createDynamicMultiSelect('filter-people-select', filterPeople);
                createDynamicMultiSelect('filter-contacts-select', filterContacts);
                createDynamicMultiSelect('filter-students-select', filterStudents);
                createDynamicMultiSelect('filter-meeting-type-select', filterMeetingTypes);
                // Status Filter
                const filterStatuses = ['Scheduled', 'In Progress', 'Completed', 'Cancelled'];
                createDynamicMultiSelect('filter-status-select', filterStatuses);
                console.log("Check 3936 - Filter MT Done");

                // Meeting Modal Init
                console.log("Check 3937");
                const participantTypesUnique = ['Staff', 'Org Unit', 'Student', 'Company'];
                createDynamicMultiSelect('meeting-participant-type-select', participantTypesUnique);
                console.log("Check 3940");

                // NEW: Mark Validation Complete
                window.markValidationComplete = function () {
                    if (!window.currentEvent) {
                        console.error("markValidationComplete: No current event");
                        return;
                    }

                    if (confirm('Are you sure you want to mark this validation as complete?')) {
                        console.log("markValidationComplete: Confirmed");
                        // Update Event Object
                        window.currentEvent.setExtendedProp('status', 'Completed');
                        window.currentEvent.setProp('color', '#22c55e'); // Green

                        // Update Status Field
                        const statusField = document.getElementById('event-status');
                        if (statusField) {
                            statusField.value = 'Completed';
                        }

                        // Update Status Badge in modal
                        const statusBadge = document.getElementById('meeting-status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = 'Completed';
                            statusBadge.className = 'inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                        }

                        // Update validation status display
                        const valStatus = document.getElementById('val-status');
                        if (valStatus) {
                            valStatus.value = 'Completed';
                        }

                        // Hide button
                        const btn = document.getElementById('btn-mark-complete');
                        if (btn) btn.classList.add('hidden');

                        // Show Feedback
                        showNotification('Validation marked as complete.', 'success');

                        // Refresh calendar to show updated color
                        if (window.calendar) {
                            window.calendar.refetchEvents();
                        }
                    }
                };

                // --- 5. Application Logic ---
                console.log("CRASH HUNT 2");

                // NEW: Toggle Logic for Meeting Location
                window.toggleMeetingPhysicalSubtype = function () {
                    const subType = document.querySelector('input[name="meeting-physical-type"]:checked').value;
                    const onsite = document.getElementById('meeting-loc-onsite');
                    const external = document.getElementById('meeting-loc-external');
                    if (subType === 'onsite') {
                        onsite.classList.remove('hidden');
                        external.classList.add('hidden');
                    } else {
                        onsite.classList.add('hidden');
                        external.classList.remove('hidden');
                    }
                };

                // NEW: Toggle Logic for Event Location
                window.toggleEventPhysicalSubtype = function () {
                    const subType = document.querySelector('input[name="event-physical-type"]:checked').value;
                    const onsite = document.getElementById('event-loc-onsite');
                    const external = document.getElementById('event-loc-external');
                    if (subType === 'onsite') {
                        onsite.classList.remove('hidden');
                        external.classList.add('hidden');
                    } else {
                        onsite.classList.add('hidden');
                        external.classList.remove('hidden');
                    }
                };

                // Track last click position for modal positioning in embeds
                console.log("Check 3990");
                window.lastClickY = 0;
                document.addEventListener('mousedown', (e) => {
                    window.lastClickY = e.pageY;
                }, true);

                window.openModal = function (modalId, context, options = {}) {
                    const modal = document.getElementById(modalId);
                    if (!modal) return;

                    // EMBED FIX: Position modal absolute if Y coordinate is provided or available
                    // This prevents the modal from opening out of view in tall iframes
                    const clickY = options.y || window.lastClickY;
                    const autoPositionIds = [
                        'modal-select-event-type', 'modal-event-management', 'modal-add-action-item',
                        'modal-add-meeting-participant', 'modal-val-doc-upload', 'modal-add-risk',
                        'modal-add-ci', 'modal-delete-confirmation', 'modal-meeting-type-info',
                        'modal-validation-type-info'
                    ];

                    if (clickY && autoPositionIds.includes(modalId)) {
                        modal.classList.remove('fixed', 'items-center');
                        modal.classList.add('absolute', 'items-start');

                        // FIX 2: Ensure backdrop covers the entire document height
                        const docHeight = Math.max(
                            document.body.scrollHeight,
                            document.documentElement.scrollHeight,
                            document.documentElement.offsetHeight,
                            window.innerHeight
                        );
                        modal.style.height = `${docHeight}px`;
                        modal.style.minHeight = '100vh';

                        // FIX 1: Pin to Top (Fixed Position)
                        modal.style.paddingTop = '50px';
                    } else if (modal.classList.contains('absolute')) {
                        // Revert handling if needed
                    }

                    // FIX: Reset scroll position to top
                    const scrollContainer = modal.querySelector('.overflow-y-auto');
                    if (scrollContainer) {
                        scrollContainer.scrollTop = 0;
                    }

                    // Switch tabs to Details by default for event modals
                    if (modalId === 'modal-event-management') {
                        switchValTab('details');
                    }

                    // Populate participant lists for the participant modal
                    if (modalId === 'modal-add-meeting-participant') {
                        setTimeout(() => {
                            populateParticipantDropdown('staff');
                            populateParticipantDropdown('students');
                            populateParticipantDropdown('orgUnit');
                            populateParticipantDropdown('company');
                        }, 100);
                    }

                    if (modalId === 'modal-event-management') {
                        const startSelect = modal.querySelector('select[id$="start-time"]');
                        if (startSelect && !startSelect.value) {
                            startSelect.value = '09:00';
                            if (typeof adjustEndTime === 'function') adjustEndTime(startSelect);
                        }

                        // NEW: Pre-fill Date if selected from Calendar
                        if (window.selectedDate) {
                            const dateInput = modal.querySelector('input[type="date"]');
                            if (dateInput) {
                                dateInput.value = window.selectedDate;
                            }
                            window.selectedDate = null;
                        }
                    }

                    if (modalId === 'modal-val-doc-upload') {
                        const nameInputContainer = document.getElementById('doc-name-container');
                        const fileDisplay = document.getElementById('file-name-display');
                        const fileInput = document.getElementById('upload-doc-file');

                        fileInput.value = '';
                        fileDisplay.classList.add('hidden');
                        fileDisplay.textContent = '';

                        if (context === 'auto-name') {
                            nameInputContainer.classList.add('hidden');
                            modal.dataset.autoName = 'true';
                        } else {
                            nameInputContainer.classList.remove('hidden');
                            modal.dataset.autoName = 'false';
                        }
                    }

                    modal.classList.remove('hidden');
                    setTimeout(() => {
                        modal.classList.remove('opacity-0');
                        const content = modal.querySelector('.modal-content');
                        if (content) content.classList.remove('scale-95');
                    }, 10);
                };

                window.closeModal = function (modalId) {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.classList.add('opacity-0');
                        const content = modal.querySelector('.modal-content');
                        if (content) content.classList.add('scale-95');
                        setTimeout(() => {

                            modal.classList.add('hidden');
                        }, 250);
                    }
                };


                window.saveEvent = function () {
                    const title = document.getElementById('event-title').value;
                    const date = document.getElementById('event-date').value;
                    const startTime = document.getElementById('event-start-time').value;
                    const endTime = document.getElementById('event-end-time').value;
                    const colorInput = document.querySelector('input[name="event-color"]:checked');
                    const color = colorInput ? colorInput.value : '#3b82f6';

                    if (!title || !date) { alert('Please fill in Title and Date'); return; }

                    // Mode Detection
                    const isMeeting = !document.getElementById('meeting-description-section').classList.contains('hidden');

                    if (isMeeting) {
                        // --- MEETING SAVE ---
                        const description = document.getElementById('meeting-description').value;

                        if (window.currentEvent) {
                            // Update Existing
                            const evt = window.currentEvent;
                            evt.setProp('title', title);
                            evt.setStart(`${date}T${startTime}`);
                            evt.setEnd(endTime ? `${date}T${endTime}` : null);
                            evt.setProp('color', color);
                            evt.setExtendedProp('description', description);

                            // Save Type safely
                            const currentType = evt.extendedProps.type;
                            if (!currentType || (!currentType.includes('Meeting'))) {
                                evt.setExtendedProp('type', 'General Meeting');
                            }

                            // Handle Mark Complete status update
                            if (window.tempStatus) evt.setExtendedProp('status', window.tempStatus);
                        } else {
                            // Create New
                            const newEvent = {
                                id: 'meet-' + Date.now(),
                                title: title,
                                start: `${date}T${startTime}:00`,
                                end: `${date}T${endTime}:00`,
                                type: 'General Meeting',
                                color: color,
                                extendedProps: {
                                    description: description,
                                    creator: 'System Admin',
                                    dateCreated: new Date().toISOString(),
                                    status: window.tempStatus || 'Scheduled'
                                }
                            };
                            window.allEvents.push(newEvent);
                            if (typeof calendar !== 'undefined') calendar.addEvent(newEvent);
                        }
                    } else {
                        // --- VALIDATION SAVE ---
                        const programs = getMultiSelectValues('event-program-select');
                        const units = getMultiSelectValues('units-multi-select');
                        const meetingType = document.getElementById('validation-meeting-type-select') ? document.getElementById('validation-meeting-type-select').value : '';

                        // Validation Logic for Required Fields
                        const requiredFields = [
                            { id: 'event-title', value: title },
                            { id: 'event-date', value: date },
                            { id: 'event-start-time', value: startTime },
                            { id: 'event-end-time', value: endTime }
                        ];

                        let isValid = true;
                        // Reset Error State
                        const errEl = document.getElementById('val-save-error');
                        if (errEl) errEl.classList.add('hidden');
                        document.querySelectorAll('.border-red-500').forEach(el => el.classList.remove('border-red-500'));

                        requiredFields.forEach(field => {
                            const el = document.getElementById(field.id);
                            if (el && !field.value) { el.classList.add('border-red-500'); isValid = false; }
                        });

                        if (!isValid) {
                            if (errEl) errEl.classList.remove('hidden');
                            return;
                        }

                        // --- Stub for Object Creation ---
                        console.log("Validation Declarations Passed");

                        if (window.currentEvent) {
                            // Update Existing
                            const evt = window.currentEvent;
                            evt.setProp('title', title);
                            evt.setStart(`${date}T${startTime}`);
                            evt.setEnd(endTime ? `${date}T${endTime}` : null);
                            evt.setProp('color', color);
                            evt.setExtendedProp('program', programs.length > 0 ? programs[0] : null);
                            evt.setExtendedProp('units', units);
                            evt.setExtendedProp('actions', scrapeActionItems());
                            evt.setExtendedProp('ci', scrapeCIItems());
                            evt.setExtendedProp('risk', scrapeRiskItems());
                            if (window.tempStatus) evt.setExtendedProp('status', window.tempStatus);
                        } else {
                            // Create New
                            const newEvent = {
                                id: 'val-' + Date.now(),
                                title: title,
                                start: `${date}T${startTime}:00`,
                                end: `${date}T${endTime}:00`,
                                type: 'Post-Assessment Validation',
                                color: color,
                                extendedProps: {
                                    program: programs.length > 0 ? programs[0] : null,
                                    units: units,
                                    creator: 'System Admin',
                                    actions: scrapeActionItems(),
                                    ci: scrapeCIItems(),
                                    risk: scrapeRiskItems(),
                                    status: window.tempStatus || (window.currentEvent?.extendedProps?.status) || 'Scheduled'
                                }
                            };
                            window.allEvents.push(newEvent);
                            if (typeof calendar !== 'undefined') calendar.addEvent(newEvent);
                        }
                    }

                    // Reset temp status
                    window.tempStatus = null;

                    // Success
                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50';
                    notification.innerText = 'Event Saved!';
                    document.body.appendChild(notification);
                    setTimeout(() => notification.remove(), 3000);

                    closeModal('modal-event-management');
                    if (typeof renderListView === 'function') renderListView();
                };


                // NEW: Mark as Complete Function
                window.markEventComplete = function () {
                    if (confirm('Are you sure you want to mark this event as Complete?')) {
                        window.tempStatus = 'Completed';
                        saveEvent();
                    }
                };

                // NEW: Scraping Helper Functions for Persistence
                function scrapeActionItems() {
                    console.log("Check 4260");
                    const rows = document.querySelectorAll('#validation-action-items-body tr');
                    return Array.from(rows).map(row => {
                        const cols = row.querySelectorAll('td');
                        // Handle Empty State/No Data
                        if (cols.length < 4) return null;
                        return {
                            action: cols[0].innerText.trim(),
                            owner: cols[1].innerText.trim(),
                            dueDate: cols[2].innerText.trim(),
                            status: cols[3].innerText.trim()
                        };
                    }).filter(i => i);
                }

                function scrapeCIItems() {
                    const rows = document.querySelectorAll('#val-ci-table-body tr');
                    return Array.from(rows).map(row => {
                        const cols = row.querySelectorAll('td');
                        if (cols.length < 4) return null;
                        return {
                            raisedBy: cols[0].innerText.trim(),
                            area: cols[1].innerText.trim(),
                            status: cols[2].innerText.trim()
                        };
                    }).filter(i => i);
                }

                function scrapeRiskItems() {
                    const rows = document.querySelectorAll('#val-risk-table-body tr');
                    return Array.from(rows).map(row => {
                        const cols = row.querySelectorAll('td');
                        if (cols.length < 6) return null;
                        return {
                            description: cols[0].innerText.trim(),
                            date: cols[1].innerText.trim(),
                            category: cols[2].innerText.trim(),
                            likelihood: cols[3].innerText.trim(), // Will grab the text inside
                            impact: cols[4].innerText.trim()
                        };
                    }).filter(i => i);
                }

                window.adjustEndTime = function (startInput) {
                    const modal = startInput.closest('.modal');
                    const endInput = modal.querySelector('input[id$="end-time"]');
                    if (startInput.value && endInput) {
                        const [hours, minutes] = startInput.value.split(':').map(Number);
                        const date = new Date();
                        date.setHours(hours);
                        date.setMinutes(minutes);
                        date.setHours(date.getHours() + 1);

                        const endHours = String(date.getHours()).padStart(2, '0');
                        const endMinutes = String(date.getMinutes()).padStart(2, '0');
                        endInput.value = `${endHours}:${endMinutes}`;
                    }
                };

                // --- Calendar Initialization ---
                console.log("Check 4309");
                try {
                    console.log("Attempting to initialize calendar...");
                    var calendarEl = document.getElementById('calendar');
                    if (calendarEl) console.log("Calendar Height Before Init:", calendarEl.offsetHeight);
                    var calendarEl = document.getElementById('calendar');
                    if (calendarEl) {
                        console.log("Found #calendar element. Initializing...");
                        var calendar = new FullCalendar.Calendar(calendarEl, {
                            initialView: 'dayGridMonth',
                            headerToolbar: {
                                left: 'prev,next today',
                                center: 'title',
                                right: 'dayGridMonth,timeGridWeek,timeGridDay'
                            },
                            eventDisplay: 'block', // Force block display for month view
                            contentHeight: 'auto', // Fix for excessive row height
                            height: 'auto', // Fix for persistent extra spacing
                            dayMaxEvents: true, // Allow "more" link when too many events
                            eventContent: function (arg) {
                                let timeText = '';
                                if (arg.event.start) {
                                    const start = arg.event.start;
                                    const end = arg.event.end;

                                    // Format: 09:00 - 11:00
                                    const startStr = start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
                                    const endStr = end ? end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                                    timeText = `${startStr} - ${endStr}`;
                                }

                                let location = arg.event.extendedProps.location || arg.event.extendedProps.Location || '';
                                if (!location && arg.event._def.extendedProps.location) location = arg.event._def.extendedProps.location;

                                if (!location && arg.event.extendedProps && arg.event.extendedProps.location) {
                                    location = arg.event.extendedProps.location;
                                }

                                let unit = arg.event.extendedProps.unit || '';

                                // Create container
                                let customHtml = document.createElement('div');
                                // Ensure container is relative for absolute positioning of delete icon
                                customHtml.className = 'w-full p-1 overflow-hidden relative group';

                                let html = `
                                            <div class="font-bold text-xs truncate pr-4">${arg.event.title}</div>
                                            <div class="text-xs truncate">${timeText}</div>
                                        `;

                                if (location) {
                                    html += `<div class="text-xs truncate italic">${location}</div>`;
                                }

                                if (unit) {
                                    html += `<div class="text-xs font-bold mt-1 bg-white/30 rounded px-1 inline-block">${unit}</div>`;
                                }

                                customHtml.innerHTML = html;

                                // Add click handler to open edit modal
                                customHtml.addEventListener('click', (e) => {
                                    // Don't open modal if clicking on delete button
                                    if (!e.target.closest('.delete-event-btn')) {
                                        openEditModalForEvent(arg.event);
                                    }
                                });
                                customHtml.style.cursor = 'pointer';

                                // Delete Icon
                                const deleteBtn = document.createElement('div');
                                deleteBtn.className = 'delete-event-btn absolute bottom-1 right-1 w-5 h-5 flex items-center justify-center bg-white/20 hover:bg-red-500 hover:text-white rounded cursor-pointer transition-colors z-10';

                                // Use Inline SVG
                                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>`;
                                deleteBtn.title = "Delete Event";

                                // Attach Click Listener to Stop Propagation and Confirm Delete
                                deleteBtn.addEventListener('click', (e) => {
                                    window.confirmDeleteEvent(e, arg.event);
                                });

                                customHtml.appendChild(deleteBtn);

                                return { domNodes: [customHtml] };
                            },
                            eventClick: function (info) {
                                openEditModalForEvent(info.event);
                            },
                            events: function (fetchInfo, successCallback, failureCallback) {
                                successCallback(allEvents);
                            },
                            dateClick: function (info) {
                                window.selectedDate = info.dateStr;
                                // Pass click Y to position modal
                                openModal('modal-select-event-type', null, { y: info.jsEvent.pageY });
                            }
                        });
                        window.calendar = calendar; // Make global for other functions
                        calendar.render();
                        console.log("Calendar initialized successfully");
                    } else {
                        console.error("Critical Error: #calendar element not found in DOM");
                    }
                } catch (e) {
                    console.error("Critical Error initializing FullCalendar:", e);
                }

                // NEW: Render List View Function
                window.renderListView = function () {
                    const limit = parseInt(document.getElementById('list-view-limit').value) || 100;
                    const sortedEvents = [...allEvents].sort((a, b) => new Date(a.start) - new Date(b.start));
                    const displayEvents = sortedEvents.slice(0, limit);

                    const container = document.getElementById('list-view-content');
                    if (!container) return;

                    let html = `<table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Event Title</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Start</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">End</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Location</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Meeting Type</th>
                                        <th class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-slate-200">`;

                    displayEvents.forEach((ev) => {
                        const dateStr = ev.start ? new Date(ev.start).toLocaleDateString('en-AU') : 'TBD';
                        const startTime = ev.start ? new Date(ev.start).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                        const endTime = ev.end ? new Date(ev.end).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
                        const type = ev.extendedProps?.type || 'General Meeting';
                        const loc = ev.extendedProps?.location || 'Virtual';

                        // Badge colors based on type
                        let badgeClass = 'bg-blue-100 text-blue-800';
                        if (type.includes('Validation')) badgeClass = 'bg-pink-100 text-pink-800';
                        else if (type.includes('Audit')) badgeClass = 'bg-amber-100 text-amber-800';

                        html += `<tr class="hover:bg-slate-50">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <a href="#" onclick="openEditModalForEvent(allEvents.find(e => e.id === '${ev.id}')); return false;" class="text-sm font-medium text-blue-600 hover:text-blue-900">${ev.title}</a>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${dateStr}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${startTime}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${endTime}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${loc}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${badgeClass}">${type}</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <div class="action-menu-container relative">
                                            <button onclick="toggleActionMenu(this)" class="text-slate-400 hover:text-slate-600 p-1">
                                                <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                            </button>
                                            <div class="action-menu-dropdown">
                                                <a href="#" onclick="openEditModalForEvent(allEvents.find(e => e.id === '${ev.id}')); return false;" class="action-menu-item flex items-center gap-2">
                                                    <i data-lucide="edit" class="w-4 h-4"></i> Edit
                                                </a>
                                                <a href="#" onclick="window.confirmDeleteEvent(event, allEvents.find(e => e.id === '${ev.id}')); return false;" class="action-menu-item delete flex items-center gap-2">
                                                    <i data-lucide="trash-2" class="w-4 h-4"></i> Delete
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>`;
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                };

                // Toggle action menu dropdown
                window.toggleActionMenu = function (btn) {
                    // Close all other open menus
                    document.querySelectorAll('.action-menu-dropdown.show').forEach(m => {
                        if (m !== btn.nextElementSibling) m.classList.remove('show');
                    });
                    btn.nextElementSibling.classList.toggle('show');
                };

                // Close menus when clicking outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.action-menu-container')) {
                        document.querySelectorAll('.action-menu-dropdown.show').forEach(m => m.classList.remove('show'));
                    }
                });

                // Reusable function for opening edit modals
                window.openEditModalForEvent = function (event) {
                    if (!event) return;
                    window.currentEvent = event;
                    const props = event.extendedProps || {};

                    // Determine Category
                    let category = 'validation';
                    const meetingTypes = ['Meeting', 'General Meeting', 'Audit Preparation', 'Professional Development', 'Moderation'];
                    if (meetingTypes.includes(props.type) || props.meetingType || (event.title && event.title.includes('Meeting'))) {
                        category = 'meeting';
                    }

                    // Open Unified Modal
                    openModal("modal-event-management");
                    setEventCategory(category);

                    // Show footer action buttons when editing an existing event
                    const btnAddAction = document.getElementById('btn-add-action-footer');
                    const btnMarkComplete = document.getElementById('btn-mark-complete');
                    if (btnAddAction) btnAddAction.classList.remove('hidden');
                    if (btnMarkComplete) btnMarkComplete.classList.remove('hidden');

                    // Common Hydration
                    const titleEl = document.getElementById('event-title');
                    if (titleEl) titleEl.value = event.title;

                    const dateEl = document.getElementById('event-date');
                    if (dateEl && event.start) {
                        const d = new Date(event.start);
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        dateEl.value = `${year}-${month}-${day}`;
                    }

                    // Ensure time options are populated before hydration
                    if (typeof populateTimeSelects === 'function') {
                        populateTimeSelects();
                    }

                    // Time Hydration
                    if (event.start) {
                        const startH = new Date(event.start).getHours().toString().padStart(2, '0');
                        const startM = new Date(event.start).getMinutes().toString().padStart(2, '0');
                        const startTimeEl = document.getElementById('event-start-time');
                        if (startTimeEl) startTimeEl.value = `${startH}:${startM}`;
                    }
                    if (event.end) {
                        const endH = new Date(event.end).getHours().toString().padStart(2, '0');
                        const endM = new Date(event.end).getMinutes().toString().padStart(2, '0');
                        const endTimeEl = document.getElementById('event-end-time');
                        if (endTimeEl) endTimeEl.value = `${endH}:${endM}`;
                    }

                    // Status Badge Logic
                    const statusDisplay = document.getElementById('meeting-status-display');
                    const statusBadge = document.getElementById('meeting-status-badge');
                    if (statusDisplay && statusBadge) {
                        const status = props.status || 'Scheduled';
                        statusBadge.textContent = status;
                        statusBadge.className = `inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${status === 'Completed' ? 'bg-green-100 text-green-800' : 'bg-slate-100 text-slate-800'}`;
                        statusDisplay.classList.remove('hidden');
                    } else if (statusDisplay) {
                        statusDisplay.classList.add('hidden');
                    }

                    // Metadata
                    const creatorEl = document.getElementById('event-creator');
                    if (creatorEl) creatorEl.value = props.creator || "System Admin";
                    const dateCreatedEl = document.getElementById('event-date-created');
                    if (dateCreatedEl) dateCreatedEl.value = props.dateCreated || new Date().toLocaleDateString('en-AU');

                    if (category === 'validation') {
                        // --- VALIDATION SPECIFIC HYDRATION ---
                        if (props.program) {
                            // Assuming getMultiSelect logic exists
                        }

                        // Sample Data Injection for "Validation: CHC33015"
                        if (event.title.includes('Validation') || event.id.includes('val')) {

                            // === ISSUE #1 & #8: Validation Event Type Hydration ===
                            const valTypeSelect = document.getElementById('validation-meeting-type-select');
                            if (valTypeSelect && props.validationType) {
                                valTypeSelect.value = props.validationType;
                                // Trigger auto-population based on validation type (Issue #9)
                                if (typeof handleValidationTypeAutoPopulation === 'function') {
                                    setTimeout(() => handleValidationTypeAutoPopulation(), 300);
                                }
                            }

                            // === ISSUE #5: Program & Unit Selection ===
                            if (props.program) {
                                setTimeout(() => {
                                    setMultiSelectValues('event-program-select', [props.program]);
                                }, 150);
                            }
                            if (props.units && props.units.length > 0) {
                                setTimeout(() => {
                                    setMultiSelectValues('units-multi-select', props.units);
                                }, 200);
                            }

                            // === ISSUE #4: Reminder Hydration with Display ===
                            if (props.reminder && props.reminder.enabled) {
                                const reminderCheckbox = document.getElementById('val-reminder-enable');
                                if (reminderCheckbox) {
                                    reminderCheckbox.checked = true;
                                }
                                // Show reminder settings and type container
                                const reminderSettings = document.getElementById('val-reminder-settings');
                                if (reminderSettings) reminderSettings.classList.remove('hidden');
                                const reminderTypeContainer = document.getElementById('val-reminder-type-container');
                                if (reminderTypeContainer) reminderTypeContainer.classList.remove('hidden');

                                // Populate reminder values
                                const reminderValue = document.getElementById('val-reminder-value');
                                if (reminderValue && props.reminder.value) reminderValue.value = props.reminder.value;

                                const reminderUnit = document.getElementById('val-reminder-unit');
                                if (reminderUnit && props.reminder.unit) reminderUnit.value = props.reminder.unit;

                                // Set reminder type radio
                                if (props.reminder.type) {
                                    const reminderTypeRadio = document.querySelector(`input[name="val-reminder-type"][value="${props.reminder.type}"]`);
                                    if (reminderTypeRadio) reminderTypeRadio.checked = true;
                                }
                            }

                            // Location Hydration for Validation
                            const valLocation = event.location || props.location || '';
                            if (valLocation) {
                                if (valLocation.toLowerCase().includes('online') || valLocation.toLowerCase().includes('zoom') || valLocation.toLowerCase().includes('teams') || valLocation.toLowerCase().includes('virtual')) {
                                    const virtualRadio = document.querySelector('input[name="event-location-type"][value="virtual"]');
                                    if (virtualRadio) {
                                        virtualRadio.checked = true;
                                        if (typeof toggleEventLocationFields === 'function') toggleEventLocationFields();
                                    }
                                } else {
                                    const physicalRadio = document.querySelector('input[name="event-location-type"][value="physical"]');
                                    if (physicalRadio) {
                                        physicalRadio.checked = true;
                                        if (typeof toggleEventLocationFields === 'function') toggleEventLocationFields();
                                    }
                                    const onsiteRadio = document.querySelector('input[name="event-physical-type"][value="onsite"]');
                                    if (onsiteRadio) {
                                        onsiteRadio.checked = true;
                                        if (typeof toggleEventPhysicalSubtype === 'function') toggleEventPhysicalSubtype();
                                    }
                                    // Set room location
                                    const roomField = document.getElementById('val-location-room');
                                    if (roomField) roomField.value = valLocation;
                                }
                            }

                            // Inject Participants using function
                            if (props.participants) {
                                renderParticipantList(props.participants);
                            } else {
                                // Default sample participants if missing
                                const samples = [
                                    { name: 'Sarah Chen', role: 'Compliance Manager', status: 'Confirmed', industryCurrency: true, trainerCredential: true },
                                    { name: 'David Jones', role: 'Lead Validator', status: 'Confirmed', industryCurrency: true, professionalDevelopment: true, trainerCredential: true, independent: true }
                                ];
                                renderParticipantList(samples);
                            }

                            // Risk Hydration for Validation - initialize risks from props
                            if (props.risk && props.risk.length > 0) {
                                window.risks = props.risk.map((r, idx) => ({
                                    id: `R${String(idx + 100).padStart(3, '0')}`,
                                    description: r.description,
                                    owner: r.mitigation ? 'Assigned' : 'Unassigned',
                                    status: 'Active',
                                    impact: r.impact || 'Medium',
                                    likelihood: r.likelihood || 'Possible',
                                    date: new Date().toISOString().split('T')[0]
                                }));
                                window.currentRiskContext = 'val';
                                renderRisksTable('val');
                            }

                            // Inject CI sample data
                            const ciBody = document.getElementById('val-ci-table-body');
                            const ciEmpty = document.getElementById('val-ci-empty-state');
                            const ciContainer = document.getElementById('val-ci-table-container');
                            if (ciBody && ciBody.children.length === 0) {
                                if (ciEmpty) ciEmpty.classList.add('hidden');
                                if (ciContainer) ciContainer.classList.remove('hidden');
                                ciBody.innerHTML = `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">Assessment Tools Review</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 max-w-xs truncate">Update rubrics to align with new unit requirements</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">In Progress</span></td>
                                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-slate-400 hover:text-slate-600 p-1"><i data-lucide="more-vertical" class="w-5 h-5"></i></button></td>
                                            </tr>`;
                            }

                            // Inject Standards sample data (Quality Areas selected)
                            setTimeout(() => {
                                const qaContainer = document.getElementById('val-standards-quality-area');
                                if (qaContainer) {
                                    const checkboxes = qaContainer.querySelectorAll('input[type="checkbox"]');
                                    checkboxes.forEach(cb => {
                                        if (cb.value.includes('Quality Area 1') || cb.value.includes('Quality Area 4')) {
                                            cb.checked = true;
                                        }
                                    });
                                    // Trigger change to populate divisions
                                    const selected = Array.from(qaContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                                    if (selected.length > 0) {
                                        handleStandardsFilterChange('val', 'quality-area', selected);
                                    }
                                }
                            }, 200);

                            // LMS Samples Hydration - show sample assessments in expandable format
                            if (props.uploadAssessmentType === 'lms') {
                                setTimeout(() => {
                                    const samplesList = document.getElementById('student-assessments-list');
                                    if (samplesList) {
                                        const sampleStudents = [
                                            {
                                                id: 'sample-1',
                                                name: 'Student 1 (LMS)',
                                                assessor: 'David Jones',
                                                outcome: 'Competent',
                                                status: 'Incomplete',
                                                activities: [
                                                    { dateSubmitted: '15/08/2025 10:32:42', activity: 'BSBSMB401 Learner Assessment', dateCompleted: '27/10/2025' },
                                                    { dateSubmitted: '15/08/2025 10:28:20', activity: 'Chapter 1: Learning Quiz', dateCompleted: '27/10/2025' },
                                                    { dateSubmitted: '15/08/2025 10:26:44', activity: 'Chapter 1: Learning Quiz', dateCompleted: '27/10/2025' }
                                                ]
                                            },
                                            {
                                                id: 'sample-2',
                                                name: 'Student 2 (LMS)',
                                                assessor: 'David Jones',
                                                outcome: 'Competent',
                                                status: 'Incomplete',
                                                activities: [
                                                    { dateSubmitted: '15/08/2025 10:32:42', activity: 'BSBSMB401 Learner Assessment', dateCompleted: '27/10/2025' },
                                                    { dateSubmitted: '15/08/2025 10:28:20', activity: 'Chapter 1: Learning Quiz', dateCompleted: '27/10/2025' },
                                                    { dateSubmitted: '15/08/2025 10:26:44', activity: 'Chapter 1: Learning Quiz', dateCompleted: '27/10/2025' }
                                                ]
                                            }
                                        ];

                                        samplesList.innerHTML = sampleStudents.map((s, idx) => `
                                            <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                                <!-- Collapsible Header -->
                                                <div class="flex justify-between items-center px-4 py-3 cursor-pointer hover:bg-slate-50" data-toggle-sample-row="${s.id}">
                                                    <div class="flex items-center gap-2">
                                                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-500 transition-transform" id="${s.id}-chevron"></i>
                                                        <span class="font-semibold text-slate-800">Sample ${idx + 1}</span>
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800">${s.status}</span>
                                                        <button type="button" class="text-slate-400 hover:text-slate-600">
                                                            <i data-lucide="more-horizontal" class="w-4 h-4"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <!-- Expandable Content -->
                                                <div id="${s.id}-content" class="border-t border-slate-200 px-4 py-3">
                                                    <!-- Student Info Fields -->
                                                    <div class="grid grid-cols-3 gap-4 mb-4">
                                                        <div>
                                                            <label class="block text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Student Name</label>
                                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm" value="${s.name}" readonly>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Assessor</label>
                                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm" value="${s.assessor}" readonly>
                                                        </div>
                                                        <div>
                                                            <label class="block text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Outcome</label>
                                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm" value="${s.outcome}" readonly>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Activities Table -->
                                                    <div class="overflow-x-auto">
                                                        <table class="min-w-full">
                                                            <thead class="bg-slate-700 text-white">
                                                                <tr>
                                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Date Submitted</th>
                                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Activity</th>
                                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Date Completed</th>
                                                                    <th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">Action</th>
                                                                </tr>
                                                            </thead>
                                                            <tbody class="divide-y divide-slate-200">
                                                                ${s.activities.map(a => `
                                                                    <tr>
                                                                        <td class="px-4 py-3 text-sm text-slate-600">${a.dateSubmitted}</td>
                                                                        <td class="px-4 py-3 text-sm text-slate-600">${a.activity}</td>
                                                                        <td class="px-4 py-3 text-sm text-slate-800 font-medium">${a.dateCompleted}</td>
                                                                        <td class="px-4 py-3 text-sm text-blue-600 hover:text-blue-800 cursor-pointer font-medium">View</td>
                                                                    </tr>
                                                                `).join('')}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('');
                                        lucide.createIcons();
                                    }
                                }, 300);
                            }

                            // === ISSUE #7: Report Data Hydration ===
                            if (props.report) {
                                const summaryField = document.getElementById('val-report-summary');
                                if (summaryField && props.report.executiveSummary) {
                                    summaryField.value = props.report.executiveSummary;
                                }
                                const recommendationsField = document.getElementById('val-report-recommendations');
                                if (recommendationsField && props.report.recommendations) {
                                    recommendationsField.value = props.report.recommendations;
                                }
                            }
                        }

                    } else {
                        // --- MEETING HYDRATION ---
                        const descEl = document.getElementById('meeting-description');
                        if (descEl) descEl.value = props.description || '';

                        // Event Type Hydration
                        const meetingTypeSelect = document.getElementById('meeting-type-select');
                        if (meetingTypeSelect && props.meetingType) {
                            setTimeout(() => {
                                setMultiSelectValues('meeting-type-select', [props.meetingType]);
                            }, 200);
                        }

                        // Location Type Hydration (physical/virtual)
                        const location = event.location || props.location || '';
                        if (location) {
                            if (location.toLowerCase().includes('online') || location.toLowerCase().includes('zoom') || location.toLowerCase().includes('teams') || location.toLowerCase().includes('virtual')) {
                                // Select virtual radio
                                const virtualRadio = document.querySelector('input[name="event-location-type"][value="virtual"]');
                                if (virtualRadio) {
                                    virtualRadio.checked = true;
                                    if (typeof toggleEventLocationFields === 'function') toggleEventLocationFields();
                                }
                            } else {
                                // Select physical radio and onsite subtype
                                const physicalRadio = document.querySelector('input[name="event-location-type"][value="physical"]');
                                if (physicalRadio) {
                                    physicalRadio.checked = true;
                                    if (typeof toggleEventLocationFields === 'function') toggleEventLocationFields();
                                }
                                const onsiteRadio = document.querySelector('input[name="event-physical-type"][value="onsite"]');
                                if (onsiteRadio) {
                                    onsiteRadio.checked = true;
                                    if (typeof toggleEventPhysicalSubtype === 'function') toggleEventPhysicalSubtype();
                                }
                            }
                        }

                        // Text location field
                        const locationEl = document.getElementById('event-location');
                        if (locationEl && location) locationEl.value = location;

                        // Reminder Hydration
                        if (props.reminder && props.reminder.enabled) {
                            const reminderCheckbox = document.getElementById('val-reminder-enable');
                            if (reminderCheckbox) reminderCheckbox.checked = true;

                            const reminderValue = document.getElementById('val-reminder-value');
                            if (reminderValue && props.reminder.value) reminderValue.value = props.reminder.value;

                            const reminderUnit = document.getElementById('val-reminder-unit');
                            if (reminderUnit && props.reminder.unit) reminderUnit.value = props.reminder.unit;

                            const reminderType = document.getElementById('val-reminder-type');
                            if (reminderType && props.reminder.type) reminderType.value = props.reminder.type;
                        }

                        // Internal Participants Hydration - use global array and existing render function
                        if (props.internalParticipants && props.internalParticipants.length > 0) {
                            meetingInternalParticipants = props.internalParticipants.map(p => ({
                                name: p.name,
                                role: p.role,
                                status: p.status || 'pending',
                                type: p.type || ''
                            }));
                            renderMeetingInternalParticipants();
                        }

                        // External Participants Hydration - use global array and existing render function
                        if (props.externalParticipants && props.externalParticipants.length > 0) {
                            meetingExternalParticipants = props.externalParticipants.map(p => ({
                                name: p.name,
                                role: p.role,
                                email: p.email || '',
                                organization: p.organization || '',
                                status: p.status || 'pending'
                            }));
                            renderMeetingExternalParticipants();
                        }

                        // Agenda Hydration - populate from extendedProps.agenda
                        const agendaList = document.getElementById('agenda-item-list');
                        if (agendaList && props.agenda && props.agenda.length > 0) {
                            agendaList.innerHTML = ''; // Clear existing
                            props.agenda.forEach(item => {
                                if (typeof addAgendaItem === 'function') {
                                    addAgendaItem(item);
                                }
                            });
                        }

                        // Minutes Hydration - populate from extendedProps.minutes with agenda item titles
                        const minutesContainer = document.getElementById('minutes-agenda-container');
                        if (minutesContainer && props.agenda && props.minutes && Object.keys(props.minutes).length > 0) {
                            let minutesHtml = '';
                            props.agenda.forEach((agendaItem, index) => {
                                const itemKey = `item-${index}`;
                                const minuteText = props.minutes[itemKey] || '';

                                // Build sub-item minutes if agenda has sub-items - with rich text editor
                                let subMinutesHtml = '';
                                if (agendaItem.subItems && agendaItem.subItems.length > 0) {
                                    subMinutesHtml = '<div class="mt-3 pl-4 border-l-2 border-slate-200 space-y-3">';
                                    agendaItem.subItems.forEach((sub, subIdx) => {
                                        const subKey = `${itemKey}-sub-${subIdx}`;
                                        const subMinuteText = props.minutes[subKey] || '';
                                        subMinutesHtml += `
                                            <div class="bg-slate-50 rounded-lg overflow-hidden border border-slate-200">
                                                <div class="bg-slate-100 px-3 py-1.5 border-b border-slate-200">
                                                    <h6 class="font-medium text-slate-700 text-xs">${sub.item}</h6>
                                                </div>
                                                <div class="rich-text-editor border-0">
                                                    <div class="rich-text-editor-toolbar bg-slate-100 border-b border-slate-200 p-1 flex gap-1">
                                                        <button type="button" class="rte-btn w-6 h-6 rounded hover:bg-slate-200 text-slate-600" data-command="bold"><i data-lucide="bold" class="w-3 h-3"></i></button>
                                                        <button type="button" class="rte-btn w-6 h-6 rounded hover:bg-slate-200 text-slate-600" data-command="italic"><i data-lucide="italic" class="w-3 h-3"></i></button>
                                                        <button type="button" class="rte-btn w-6 h-6 rounded hover:bg-slate-200 text-slate-600" data-command="insertUnorderedList"><i data-lucide="list" class="w-3 h-3"></i></button>
                                                    </div>
                                                    <div class="rich-text-editor-content p-2 min-h-[60px] outline-none text-sm" contenteditable="true">${subMinuteText}</div>
                                                </div>
                                            </div>`;
                                    });
                                    subMinutesHtml += '</div>';
                                }

                                minutesHtml += `
                                    <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
                                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200">
                                            <h5 class="font-medium text-slate-800 text-sm">${agendaItem.item || 'Agenda Item ' + (index + 1)}</h5>
                                        </div>
                                        <div class="rich-text-editor border-0">
                                            <div class="rich-text-editor-toolbar bg-slate-50 border-b border-slate-300 p-1 flex gap-1">
                                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="bold"><i data-lucide="bold" class="w-4 h-4"></i></button>
                                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="italic"><i data-lucide="italic" class="w-4 h-4"></i></button>
                                                <button type="button" class="rte-btn w-8 h-8 rounded hover:bg-slate-200 text-slate-600" data-command="insertUnorderedList"><i data-lucide="list" class="w-4 h-4"></i></button>
                                            </div>
                                            <div class="rich-text-editor-content p-3 min-h-[100px] outline-none" contenteditable="true">${minuteText}</div>
                                        </div>
                                        ${subMinutesHtml}
                                    </div>`;
                            });
                            minutesContainer.innerHTML = minutesHtml;
                            lucide.createIcons();
                        }

                        // Actions Hydration for Meeting
                        const meetingActionsBody = document.getElementById('validation-action-items-body');
                        if (meetingActionsBody && props.actions && props.actions.length > 0) {
                            meetingActionsBody.innerHTML = '';
                            props.actions.forEach(a => {
                                const statusClass = a.status === 'Open' ? 'bg-red-100 text-red-800' : (a.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800');
                                meetingActionsBody.innerHTML += `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-4 text-sm text-slate-900">${a.action}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.owner}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${a.dueDate}</td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${a.status}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-slate-400 hover:text-slate-600 p-1"><i data-lucide="more-vertical" class="w-5 h-5"></i></button></td>
                                    </tr>`;
                            });
                        }

                        // CI Hydration for Meeting
                        const meetingCIBody = document.getElementById('val-ci-table-body');
                        if (meetingCIBody && props.ci && props.ci.length > 0) {
                            meetingCIBody.innerHTML = '';
                            props.ci.forEach(c => {
                                const statusClass = c.status === 'In Progress' ? 'bg-yellow-100 text-yellow-800' : (c.status === 'Implemented' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800');
                                meetingCIBody.innerHTML += `
                                    <tr class="hover:bg-slate-50">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${c.raisedBy}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${c.date || ''}</td>
                                        <td class="px-6 py-4 text-sm text-slate-500 max-w-xs truncate">${c.description}</td>
                                        <td class="px-6 py-4 whitespace-nowrap"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">${c.status}</span></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium"><button class="text-slate-400 hover:text-slate-600 p-1"><i data-lucide="more-vertical" class="w-5 h-5"></i></button></td>
                                    </tr>`;
                            });
                        }

                        // Risk Hydration for Meeting - initialize risks from props
                        if (props.risk && props.risk.length > 0) {
                            window.risks = props.risk.map((r, idx) => ({
                                id: `R${String(idx + 100).padStart(3, '0')}`,
                                description: r.description,
                                owner: r.mitigation ? 'Assigned' : 'Unassigned',
                                status: 'Active',
                                impact: r.impact || 'Medium',
                                likelihood: r.likelihood || 'Possible',
                                date: new Date().toISOString().split('T')[0]
                            }));
                            window.currentRiskContext = 'meeting';
                            renderRisksTable('meeting');
                        }
                    }

                    // Refresh Icons
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                };
                // NEW: Delete Event Logic
                let eventToDelete = null;

                window.confirmDeleteEvent = function (clickEvent, eventObj) {
                    // Prevent bubbling to Avoid `eventClick` (Edit Modal)
                    clickEvent.stopPropagation();

                    eventToDelete = eventObj;

                    // Show/Hide recurrence options
                    // Check if event has a groupId (our custom prop for recurrences) 
                    // OR if it's a FullCalendar recurring event (not using RRule plugin here, but logic remains)
                    const groupId = eventObj.groupId || eventObj.extendedProps.groupId;
                    const isRecurring = !!groupId;

                    const recOptions = document.getElementById('delete-recurrence-options');
                    if (isRecurring) {
                        recOptions.classList.remove('hidden');
                    } else {
                        recOptions.classList.add('hidden');
                    }

                    document.getElementById('delete-modal-msg').innerText = `Are you sure you want to delete '${eventObj.title}'?`;
                    openModal('modal-delete-confirmation');
                };

                // Limit change listener
                document.addEventListener('change', function (e) {
                    if (e.target && e.target.id === 'list-view-limit') {
                        renderListView();
                    }
                });

                window.executeDeleteEvent = function () {
                    if (!eventToDelete) return;

                    const notification = document.createElement('div');
                    notification.className = 'fixed bottom-4 right-4 bg-slate-800 text-white px-4 py-2 rounded shadow-lg z-50 transition-opacity duration-500';

                    // Check recurrence selection
                    let mode = 'single';
                    const recOptions = document.getElementById('delete-recurrence-options');
                    if (recOptions && !recOptions.classList.contains('hidden')) {
                        const selected = document.querySelector('input[name="delete-recurrence-opt"]:checked');
                        if (selected) mode = selected.value;
                    }

                    notification.innerText = `Event '${eventToDelete.title}' deleted (${mode} mode).`;
                    document.body.appendChild(notification);

                    // Fade out
                    setTimeout(() => {
                        notification.classList.add('opacity-0');
                        setTimeout(() => notification.remove(), 500);
                    }, 3000);

                    // Deletion Logic
                    // Note: In a real app, strict date comparison for recurring instances would require more robust handling
                    // Here we use simple string/date comparison on the global allEvents array.

                    if (mode === 'single' || !eventToDelete.groupId) {
                        // Remove by ID
                        // If it's a recurring instance expanded by FullCalendar, it might share ID with others if we provided them that way,
                        // but in this local setup, valid events have unique IDs. recurring meeting series might share groupId.
                        // Ideally for 'single' instance of a recurring event, we'd need to add an exception date to the rule.
                        // For this prototype, 'single' delete on a generated occurrence removes just that object if it exists in allEvents,
                        // OR if it's dynamic (RRule), we can't easily 'delete' one instance without modifying RRule.
                        // SIMPLIFICATION: We will assume we are filtering the main array.
                        window.allEvents = window.allEvents.filter(e => e.id !== eventToDelete.id);
                    } else {
                        const groupId = eventToDelete.groupId;
                        const currentStart = new Date(eventToDelete.start);

                        if (mode === 'future') {
                            window.allEvents = window.allEvents.filter(e => {
                                if (e.groupId !== groupId) return true;
                                const eStart = new Date(e.start);
                                return eStart < currentStart;
                            });
                        } else if (mode === 'past') {
                            window.allEvents = window.allEvents.filter(e => {
                                if (e.groupId !== groupId) return true;
                                const eStart = new Date(e.start);
                                return eStart > currentStart;
                            });
                        } else if (mode === 'all') {
                            window.allEvents = window.allEvents.filter(e => e.groupId !== groupId);
                        } else {
                            window.allEvents = window.allEvents.filter(e => e.id !== eventToDelete.id);
                        }
                    }

                    // Update Calendar
                    if (window.calendar) {
                        window.calendar.removeAllEvents();
                        window.calendar.addEventSource(window.allEvents);
                    }

                    // Update List View if active
                    if (!document.getElementById('content-list-view').classList.contains('hidden')) {
                        renderListView();
                    }

                    closeModal('modal-delete-confirmation');
                    eventToDelete = null;
                };

                // --- NEW: Populate Time Select Options ---
                window.populateTimeSelects = function () {
                    const startSelect = document.getElementById('event-start-time');
                    const endSelect = document.getElementById('event-end-time');

                    if (!startSelect || !endSelect) return;

                    // Only populate if empty
                    if (startSelect.options.length > 1) return;

                    // Clear existing options
                    startSelect.innerHTML = '<option value="">Select time...</option>';
                    endSelect.innerHTML = '<option value="">Select time...</option>';

                    // Generate time options from 06:00 to 23:30 in 30-min intervals
                    for (let hour = 6; hour <= 23; hour++) {
                        for (let min = 0; min < 60; min += 30) {
                            const timeStr = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                            const display = `${hour.toString().padStart(2, '0')}:${min.toString().padStart(2, '0')}`;
                            startSelect.add(new Option(display, timeStr));
                            endSelect.add(new Option(display, timeStr));
                        }
                    }
                };

                // Populate time selects on page load
                populateTimeSelects();

                // --- NEW: Unified Reset Function ---
                window.resetUnifiedModalState = function () {
                    // 1. Clear Global Context & Arrays
                    window.currentEvent = null;
                    if (typeof risks !== 'undefined') risks = [];
                    if (typeof meetingInternalParticipants !== 'undefined') meetingInternalParticipants = [];
                    if (typeof meetingExternalParticipants !== 'undefined') meetingExternalParticipants = [];

                    // 2. Clear Participant DOMs
                    const pLists = ['participant-list', 'meeting-internal-participants-list', 'meeting-external-participants-list'];
                    pLists.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = '';
                    });

                    // 3. Clear Risk & CI DOMs
                    ['val', 'meeting'].forEach(ctx => {
                        const riskBody = document.getElementById(`${ctx}-risk-table-body`);
                        if (riskBody) riskBody.innerHTML = '';
                        const ciBody = document.getElementById(`${ctx}-ci-table-body`);
                        if (ciBody) ciBody.innerHTML = '';

                        const riskEmpty = document.getElementById(`${ctx}-risk-empty-state`);
                        if (riskEmpty) riskEmpty.classList.remove('hidden');
                        const ciEmpty = document.getElementById(`${ctx}-ci-empty-state`);
                        if (ciEmpty) ciEmpty.classList.remove('hidden');
                    });

                    // 4. Reset Forms (Generic) & Specific Inputs
                    document.querySelectorAll('form').forEach(f => {
                        if (f.id !== 'form-save-view') f.reset();
                    });

                    // Clear specific multi-select containers if needed
                    ['event-program-select', 'units-multi-select'].forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.innerHTML = '';
                    });

                    // 5. Explicitly clear event fields that may not be in a form
                    const eventTitle = document.getElementById('event-title');
                    if (eventTitle) eventTitle.value = '';
                    const eventDate = document.getElementById('event-date');
                    if (eventDate) eventDate.value = '';
                    const eventStartTime = document.getElementById('event-start-time');
                    if (eventStartTime) eventStartTime.value = '';
                    const eventEndTime = document.getElementById('event-end-time');
                    if (eventEndTime) eventEndTime.value = '';
                    const meetingTitle = document.getElementById('meeting-title');
                    if (meetingTitle) meetingTitle.value = '';

                    // 6. Clear meeting description textarea
                    const meetingDescription = document.getElementById('meeting-description');
                    if (meetingDescription) meetingDescription.value = '';

                    // 7. Clear agenda items list (dynamically added items)
                    const agendaList = document.getElementById('agenda-item-list');
                    if (agendaList) agendaList.innerHTML = '';

                    // 8. Clear minutes content (RTE editor)
                    const minutesContent = document.getElementById('meeting-minutes-content');
                    if (minutesContent) minutesContent.innerHTML = '';

                    // 9. Clear minutes-agenda-container
                    const minutesAgenda = document.getElementById('minutes-agenda-container');
                    if (minutesAgenda) minutesAgenda.innerHTML = '<p class="text-sm text-slate-500 italic">Add agenda items to populate this section.</p>';

                    // 10. Hide footer action buttons (for new events only)
                    const btnAddAction = document.getElementById('btn-add-action-footer');
                    const btnMarkComplete = document.getElementById('btn-mark-complete');
                    if (btnAddAction) btnAddAction.classList.add('hidden');
                    if (btnMarkComplete) btnMarkComplete.classList.add('hidden');

                    // 11. Clear meeting internal/external participant arrays
                    meetingInternalParticipants = [];
                    meetingExternalParticipants = [];

                    // 12. Clear Actions table
                    const actionsBody = document.getElementById('validation-action-items-body');
                    if (actionsBody) actionsBody.innerHTML = '';

                    // 13. Clear CI table
                    const ciBody = document.getElementById('val-ci-table-body');
                    if (ciBody) ciBody.innerHTML = '';

                    // 14. Clear Risk table and reset risks array
                    const riskBody = document.getElementById('val-risk-table-body');
                    if (riskBody) riskBody.innerHTML = '';
                    window.risks = [];

                    // 15. Clear student assessments list
                    const samplesList = document.getElementById('student-assessments-list');
                    if (samplesList) samplesList.innerHTML = '';

                    // 16. Clear validation participant list
                    const valParticipants = document.getElementById('participant-list');
                    if (valParticipants) valParticipants.innerHTML = '';

                    // 17. Clear meeting participant lists
                    const intList = document.getElementById('meeting-internal-participants-list');
                    if (intList) intList.innerHTML = '';
                    const extList = document.getElementById('meeting-external-participants-list');
                    if (extList) extList.innerHTML = '';

                    // 18. Reset Event Type dropdown (Issue #4) - should be empty on new events
                    const eventTypeSelect = document.getElementById('validation-meeting-type-select');
                    if (eventTypeSelect) eventTypeSelect.selectedIndex = 0; // Reset to "Select Event Type..."

                    // 19. Hide reminder fields (Issue #4) - should not be populated on new events
                    const reminderEnable = document.getElementById('val-reminder-enable');
                    if (reminderEnable) {
                        reminderEnable.checked = false;
                        // Hide reminder settings
                        const reminderSettings = document.getElementById('val-reminder-settings');
                        if (reminderSettings) reminderSettings.classList.add('hidden');
                        const reminderTypeContainer = document.getElementById('val-reminder-type-container');
                        if (reminderTypeContainer) reminderTypeContainer.classList.add('hidden');
                    }

                    // 20. Set Physical location as default (Issue #5)
                    const physicalRadio = document.querySelector('input[name="event-location-type"][value="physical"]');
                    if (physicalRadio) {
                        physicalRadio.checked = true;
                        if (typeof toggleEventLocationFields === 'function') toggleEventLocationFields();
                    }
                    // Set Onsite as default physical subtype
                    const onsiteRadio = document.querySelector('input[name="event-physical-type"][value="onsite"]');
                    if (onsiteRadio) {
                        onsiteRadio.checked = true;
                        if (typeof toggleEventPhysicalSubtype === 'function') toggleEventPhysicalSubtype();
                    }
                };

                // --- NEW: Add Risk Modal Function ---
                window.openAddRiskModal = function (context = 'val') {
                    window.currentRiskContext = context;
                    const fo = document.getElementById('form-risk');
                    if (fo) fo.reset();

                    const rid = document.getElementById('risk-id');
                    if (rid) rid.value = '';

                    const title = document.getElementById('modal-risk-title');
                    if (title) title.innerText = 'Add Risk';

                    openModal('modal-add-risk');
                };

                // --- Modal Event Selection Logic ---
                const btnVal = document.getElementById('select-event-validation');
                if (btnVal) {
                    btnVal.addEventListener('click', (e) => {
                        closeModal('modal-select-event-type');
                        // Pass click Y to next modal
                        openModal('modal-event-management', null, { y: e.pageY });
                        setEventCategory('validation'); // Set category for conditional content

                        // FIX: Explicitly Clean Up Form for New Validation Event
                        resetUnifiedModalState(); // CALL UNIFIED RESET

                        // Re-initialize Dropdowns for Validation
                        const rplOut = document.getElementById('rpl-outcome-types-select');
                        if (rplOut) {
                            createDynamicMultiSelect('rpl-outcome-types-select', outcomeOptions);
                        }
                        const rplTrainers = document.getElementById('rpl-assessments-trainers-select');
                        if (rplTrainers) {
                            const trainerOptions = ['David Jones', 'Emily White', 'Michael Brown', 'Sarah Chen', 'Jessica Davis'];
                            createDynamicMultiSelect('rpl-assessments-trainers-select', trainerOptions);
                        }

                        // Re-initialize Sample Trainers
                        const sampTrainers = document.getElementById('student-assessments-trainers-select');
                        if (sampTrainers) {
                            const trainerOptions = ['David Jones', 'Emily White', 'Michael Brown', 'Sarah Chen', 'Jessica Davis'];
                            createDynamicMultiSelect('student-assessments-trainers-select', trainerOptions);
                        }

                        // Re-initialize Program & Units
                        const progSelect = document.getElementById('event-program-select');
                        if (progSelect) {
                            createDynamicMultiSelect('event-program-select', programOptions);
                        }
                        const unitSelect = document.getElementById('units-multi-select');
                        if (unitSelect) {
                            createDynamicMultiSelect('units-multi-select', unitOptions);
                        }

                        // Clear Standards (Validation specific)
                        ['val-standards-quality-area', 'val-standards-division', 'val-standards-standard', 'val-standards-performance-indicator'].forEach(id => {
                            const c = document.getElementById(id);
                            if (c) c.innerHTML = '';
                        });

                        // Restore Quality Area Options (Validation)
                        if (typeof RTO_STANDARDS_2025 !== 'undefined') {
                            renderStandardsMultiSelect('val-standards-quality-area', Object.keys(RTO_STANDARDS_2025), (vals) => {
                                handleStandardsFilterChange('val', 'quality-area', vals);
                            });
                        }

                        // Reset Dependent Fields to Empty (triggers Placeholders)
                        renderStandardsMultiSelect('val-standards-division', [], (vals) => {
                            handleStandardsFilterChange('val', 'division', vals);
                        });
                        renderStandardsMultiSelect('val-standards-standard', [], (vals) => {
                            handleStandardsFilterChange('val', 'standard', vals);
                        });
                        renderStandardsMultiSelect('val-standards-performance-indicator', [], (vals) => { });

                        setTimeout(() => {
                            lucide.createIcons();
                            checkCompliance();
                        }, 50);
                    });
                }

                const btnMeeting = document.getElementById('select-event-meeting');
                if (btnMeeting) {
                    btnMeeting.addEventListener('click', (e) => {
                        closeModal('modal-select-event-type');

                        // Unified Modal
                        openModal('modal-event-management', null, { y: e.pageY });
                        setEventCategory('meeting');

                        // Reset Form via Unified Function
                        resetUnifiedModalState();

                        // 3. Reset Time
                        document.getElementById('event-start-time').value = '09:00';
                        if (typeof adjustEndTime === 'function') adjustEndTime(document.getElementById('event-start-time'));

                        // Standards - Fix: Use proper cascade callbacks (matching validation event)
                        if (typeof renderStandardsMultiSelect === 'function') {
                            const standards = typeof RTO_STANDARDS_2025 !== 'undefined' ? RTO_STANDARDS_2025 : {};
                            renderStandardsMultiSelect('val-standards-quality-area', Object.keys(standards), (vals) => {
                                handleStandardsFilterChange('val', 'quality-area', vals);
                            });
                            renderStandardsMultiSelect('val-standards-division', [], (vals) => {
                                handleStandardsFilterChange('val', 'division', vals);
                            });
                            renderStandardsMultiSelect('val-standards-standard', [], (vals) => {
                                handleStandardsFilterChange('val', 'standard', vals);
                            });
                            renderStandardsMultiSelect('val-standards-performance-indicator', [], () => { });
                        }

                        // Reset Tab to Details
                        switchValTab('details');

                        setTimeout(() => {
                            if (typeof lucide !== 'undefined') lucide.createIcons();
                        }, 50);
                    });
                }

                // --- Saved Views Logic ---
                const btnSaveView = document.getElementById('btn-save-view');
                const confirmSaveViewBtn = document.getElementById('confirm-save-view-btn');
                const viewNameInput = document.getElementById('view-name-input');
                const savedViewsSelect = document.getElementById('saved-views-select');

                const filterInputs = [
                    'filter-program-select', 'filter-unit-select', 'filter-org-unit-select',
                    'filter-company-select', 'filter-people-select', 'filter-contacts-select',
                    'filter-students-select', 'filter-meeting-type-select', 'filter-status-select'
                ];

                window.getMultiSelectValues = function (containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return [];
                    // Fix: Prefer data-value to preserve formatting
                    return Array.from(container.querySelectorAll('.multi-select-tag')).map(tag => tag.getAttribute('data-value') || tag.textContent.trim());
                };

                window.setMultiSelectValues = function (containerId, values) {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    const inputWrapper = container.querySelector('.multi-select-input');
                    if (inputWrapper) {
                        const input = inputWrapper.querySelector('.multi-select-search');
                        const existingTags = inputWrapper.querySelectorAll('.multi-select-tag');
                        existingTags.forEach(t => t.remove());

                        if (values && Array.isArray(values)) {
                            values.forEach(text => {
                                const tag = document.createElement('div');
                                tag.className = 'multi-select-tag';
                                tag.setAttribute('data-value', text);

                                // Apply risk-based coloring (same as addTag function)
                                const riskMatch = text.match(/\(Risk:\s*(High|Medium|Low)\)/i);
                                if (riskMatch) {
                                    const riskLevel = riskMatch[1].toLowerCase();
                                    tag.classList.add('rounded-full', 'px-3', 'py-1', 'text-xs', 'font-semibold', 'border');
                                    if (riskLevel === 'high') {
                                        tag.classList.add('bg-red-100', 'text-red-800', 'border-red-200');
                                    } else if (riskLevel === 'medium') {
                                        tag.classList.add('bg-amber-100', 'text-amber-800', 'border-amber-200');
                                    } else if (riskLevel === 'low') {
                                        tag.classList.add('bg-green-100', 'text-green-800', 'border-green-200');
                                    }
                                }

                                tag.innerHTML = `<span>${text}</span><button type="button"></button>`;
                                tag.querySelector('button').onclick = function () { this.parentElement.remove(); };
                                inputWrapper.insertBefore(tag, input);
                            });
                        }
                    }
                };

                if (btnSaveView && viewNameInput) {
                    btnSaveView.addEventListener('click', () => {
                        viewNameInput.value = '';
                        openModal('modal-save-view');
                        setTimeout(() => viewNameInput.focus(), 100);
                    });
                }

                if (confirmSaveViewBtn && viewNameInput && savedViewsSelect) {
                    confirmSaveViewBtn.addEventListener('click', () => {
                        const name = viewNameInput.value.trim();
                        if (name) {
                            const currentFilters = {};
                            filterInputs.forEach(id => {
                                const container = document.getElementById(id);
                                if (container) {
                                    currentFilters[id] = getMultiSelectValues(id);
                                }
                            });

                            const opt = document.createElement('option');
                            opt.textContent = name;
                            opt.value = name.toLowerCase().replace(/\s/g, '_');
                            opt.dataset.filters = JSON.stringify(currentFilters);

                            savedViewsSelect.appendChild(opt);
                            savedViewsSelect.value = opt.value;
                            closeModal('modal-save-view');
                        }
                    });
                }

                if (savedViewsSelect) {
                    savedViewsSelect.addEventListener('change', (e) => {
                        const selectedOption = e.target.options[e.target.selectedIndex];
                        if (selectedOption.dataset.filters) {
                            const filters = JSON.parse(selectedOption.dataset.filters);
                            filterInputs.forEach(id => {
                                setMultiSelectValues(id, filters[id] || []);
                            });
                        } else if (e.target.value === 'default') {
                            filterInputs.forEach(id => setMultiSelectValues(id, []));
                        }
                    });
                }

                // --- Filter Toggle Logic ---
                const btnToggleFilters = document.getElementById('btn-toggle-filters');
                const filterPanel = document.getElementById('filter-panel');
                const filterToggleText = document.getElementById('filter-toggle-text');

                if (btnToggleFilters && filterPanel && filterToggleText) {
                    btnToggleFilters.addEventListener('click', () => {
                        filterPanel.classList.toggle('collapsed');
                        const isHidden = filterPanel.classList.contains('collapsed');
                        filterToggleText.textContent = isHidden ? "Show Filters" : "Hide Filters";
                    });
                }

                window.switchValTab = function (tabName) {
                    document.querySelectorAll('.val-tab-content').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('#modal-event-management .tab-nav-item').forEach(el => el.classList.remove('active'));

                    document.getElementById(`val-tab-${tabName}`).classList.add('active');
                    document.querySelector(`[data-val-tab="${tabName}"]`).classList.add('active');
                    lucide.createIcons();

                    if (tabName === 'risk') {
                        renderRisksTable('val');
                    }

                    // Issue #1 Fix: Sync agenda items (including sub-items) to minutes when switching to Minutes tab
                    if (tabName === 'minutes') {
                        if (typeof syncAgendaToMinutes === 'function') {
                            syncAgendaToMinutes();
                        }
                    }

                    // FIX: Scroll to top of content when switching tabs
                    const modal = document.getElementById('modal-event-management');
                    if (modal) {
                        const scrollContainer = modal.querySelector('.overflow-y-auto');
                        if (scrollContainer) scrollContainer.scrollTop = 0;
                    }
                };

                // NEW: Set Event Category to toggle Meeting/Validation content visibility
                window.setEventCategory = function (category) {
                    const isMeeting = category === 'meeting';
                    const isValidation = category === 'validation';

                    // Tab buttons visibility
                    document.querySelectorAll('[data-category="meeting"]').forEach(el => {
                        el.style.display = isMeeting ? '' : 'none';
                    });
                    document.querySelectorAll('[data-category="validation"]').forEach(el => {
                        el.style.display = isValidation ? '' : 'none';
                    });

                    // Participants tab - show correct version
                    const partVal = document.getElementById('participants-validation');
                    const partMeet = document.getElementById('participants-meeting');
                    if (partVal) partVal.style.display = isValidation ? '' : 'none';
                    if (partMeet) partMeet.style.display = isMeeting ? '' : 'none';

                    // Details tab conditional fields (if they exist)
                    const scopeCtx = document.getElementById('scope-context-section');
                    const valTypeSection = document.getElementById('validation-type-section');
                    const meetingTypeSection = document.getElementById('meeting-type-section');
                    const meetingDescSection = document.getElementById('meeting-description-section');

                    if (scopeCtx) scopeCtx.style.display = isValidation ? '' : 'none';
                    if (valTypeSection) valTypeSection.style.display = isValidation ? '' : 'none';
                    if (meetingTypeSection) meetingTypeSection.style.display = isMeeting ? '' : 'none';
                    if (meetingDescSection) meetingDescSection.style.display = isMeeting ? '' : 'none';

                    // Update modal title
                    const title = document.getElementById('event-modal-title');
                    if (title) {
                        title.textContent = isMeeting ? 'Schedule a Meeting Event' : 'Schedule New Validation Event';
                    }

                    // Store current category for save functions
                    window.currentEventCategory = category;

                    // If switching category and on a hidden tab, switch to Details
                    const activeTab = document.querySelector('.val-tab-content.active');
                    if (activeTab) {
                        const tabCategory = activeTab.getAttribute('data-category');
                        if (tabCategory && tabCategory !== category) {
                            switchValTab('details');
                        }
                    }

                    // Re-create icons
                    lucide.createIcons();
                    console.log('Event category set to:', category);
                };



                window.syncAgendaToMinutes = function () {
                    const agendaList = document.getElementById('agenda-item-list');
                    const minutesContainer = document.getElementById('minutes-agenda-container');

                    if (agendaList.children.length === 0) {
                        minutesContainer.innerHTML = '<p class="text-sm text-slate-500 italic">No agenda items added yet.</p>';
                        return;
                    }

                    minutesContainer.innerHTML = '';

                    // Get stored minutes if available
                    const storedMinutes = (window.currentEvent && window.currentEvent.extendedProps.minutes) || {};

                    Array.from(agendaList.children).forEach((item, index) => {
                        // 1. Process Main Item
                        const titleInput = item.querySelector('input[placeholder="Agenda Item Title"]');
                        const title = titleInput ? titleInput.value : `Agenda Item ${index + 1} `;
                        const descInput = item.querySelector('textarea');
                        const desc = descInput ? descInput.value : '';

                        // Extract ID to find sub-items
                        const itemId = item.id.replace('agenda-item-', '');

                        // Look up minutes for this item (using index as fallback key if needed, or title?)
                        // ideally we used ID but IDs are random. Index is likely more stable for this simple mock.
                        // Let's rely on index for the main items in the sample data.
                        const minutesContent = storedMinutes[`item-${index}`] || '';

                        const itemHtml = `
                                <div class="border-l-4 border-indigo-200 pl-4 py-1">
                                    <h5 class="font-bold text-slate-800 text-sm">${title || '(Untitled Item)'}</h5>
                                    <p class="text-xs text-slate-500 mb-2">${desc}</p>
                                    ${getRTEHtml('min-h-[100px]', 'Record minutes for this item...', minutesContent)}
                                </div>`;
                        minutesContainer.insertAdjacentHTML('beforeend', itemHtml);

                        // 2. Process Sub-Items
                        const subContainer = document.getElementById(`agenda-subs-${itemId}`);
                        if (subContainer && subContainer.children.length > 0) {
                            Array.from(subContainer.children).forEach(sub => {
                                const subTitleInput = sub.querySelector('input'); // Grab first input, usually title
                                const subTitle = subTitleInput ? subTitleInput.value : '(Untitled Sub-item)';

                                const subHtml = `
                            <div class="ml-8 border-l-2 border-slate-200 pl-4 py-1 mt-2">
                                <h6 class="font-bold text-slate-800 text-sm flex items-center gap-1">
                                    <i data-lucide="corner-down-right" class="w-4 h-4 text-slate-400"></i>
                                    ${subTitle}
                                </h6>
                                            ${getRTEHtml('min-h-[80px]', 'Record minutes for sub-item...')}
                                        </div>`;
                                minutesContainer.insertAdjacentHTML('beforeend', subHtml);
                            });
                        }
                    });
                    lucide.createIcons(); // Render icons for the newly added RTEs
                };

                window.toggleRecurrenceOptions = function () {
                    const val = document.getElementById('meeting-recurrence-type').value;
                    const panel = document.getElementById('recurrence-options-panel');
                    const daily = document.getElementById('rec-daily');
                    const weekly = document.getElementById('rec-weekly');
                    const fortnightly = document.getElementById('rec-fortnightly');
                    const monthly = document.getElementById('rec-monthly');
                    const yearly = document.getElementById('rec-yearly');

                    if (val === 'none') {
                        panel.classList.add('hidden');
                    } else {
                        panel.classList.remove('hidden');
                        daily.classList.add('hidden');
                        weekly.classList.add('hidden');
                        fortnightly.classList.add('hidden');
                        monthly.classList.add('hidden');
                        yearly.classList.add('hidden');

                        if (val === 'daily') daily.classList.remove('hidden');
                        if (val === 'weekly') weekly.classList.remove('hidden');
                        if (val === 'fortnightly') fortnightly.classList.remove('hidden');
                        if (val === 'monthly') monthly.classList.remove('hidden');
                        if (val === 'yearly') yearly.classList.remove('hidden');
                    }
                };

                // NEW: Recurrence logic for Validation Modal
                window.toggleEventRecurrenceOptions = function () {
                    const val = document.getElementById('event-recurrence-type').value;
                    const panel = document.getElementById('event-recurrence-options-panel');
                    const daily = document.getElementById('val-rec-daily');
                    const weekly = document.getElementById('val-rec-weekly');
                    const fortnightly = document.getElementById('val-rec-fortnightly');
                    const monthly = document.getElementById('val-rec-monthly');
                    const yearly = document.getElementById('val-rec-yearly');

                    if (val === 'none') {
                        panel.classList.add('hidden');
                    } else {
                        panel.classList.remove('hidden');
                        daily.classList.add('hidden');
                        weekly.classList.add('hidden');
                        fortnightly.classList.add('hidden');
                        monthly.classList.add('hidden');
                        yearly.classList.add('hidden');

                        if (val === 'daily') daily.classList.remove('hidden');
                        if (val === 'weekly') weekly.classList.remove('hidden');
                        if (val === 'fortnightly') fortnightly.classList.remove('hidden');
                        if (val === 'monthly') monthly.classList.remove('hidden');
                        if (val === 'yearly') yearly.classList.remove('hidden');
                    }
                };

                window.toggleLocationFields = function () {
                    const type = document.querySelector('input[name="meeting-location-type"]:checked').value;
                    const virtual = document.getElementById('location-field-virtual');
                    const physical = document.getElementById('location-field-physical');

                    if (type === 'virtual') {
                        virtual.classList.remove('hidden');
                        physical.classList.add('hidden');
                    } else {
                        virtual.classList.add('hidden');
                        physical.classList.remove('hidden');
                    }
                };

                window.populateRooms = function () {
                    const campus = document.getElementById('meeting-location').value;
                    const roomSelect = document.getElementById('meeting-room');
                    roomSelect.innerHTML = '<option value="">Select a room...</option>';

                    if (campus === 'Boardroom A') {
                        roomSelect.disabled = false;
                        roomSelect.innerHTML += '<option>Main Boardroom</option><option>Meeting Room 1</option>';
                    } else if (campus === 'Main Campus') {
                        roomSelect.disabled = false;
                        roomSelect.innerHTML += '<option>Room 101</option><option>Room 102</option><option>Auditorium</option>';
                    } else {
                        roomSelect.disabled = true;
                        roomSelect.innerHTML = '<option value="">Select a campus first...</option>';
                    }
                };

                window.populateEventRooms = function () {
                    const campus = document.getElementById('event-location-select').value;
                    const roomSelect = document.getElementById('event-room-select');
                    roomSelect.innerHTML = '<option value="">Select a room...</option>';

                    if (campus === 'Boardroom A') {
                        roomSelect.disabled = false;
                        roomSelect.innerHTML += '<option>Main Boardroom</option><option>Meeting Room 1</option>';
                    } else if (campus === 'Main Campus') {
                        roomSelect.disabled = false;
                        roomSelect.innerHTML += '<option>Room 101</option><option>Room 102</option><option>Auditorium</option>';
                    } else {
                        roomSelect.disabled = true;
                        roomSelect.innerHTML = '<option value="">Select a location first...</option>';
                    }
                };

                window.toggleEventLocationFields = function () {
                    const type = document.querySelector('input[name="event-location-type"]:checked').value;
                    const virtual = document.getElementById('event-location-virtual');
                    const physical = document.getElementById('event-location-physical');

                    if (type === 'virtual') {
                        virtual.classList.remove('hidden');
                        physical.classList.add('hidden');
                    } else {
                        virtual.classList.add('hidden');
                        physical.classList.remove('hidden');
                    }
                };

                window.handleProgramChange = function (input) {
                    const val = input.value;
                    const badge = document.getElementById('program-risk-badge');
                    if (!badge) return;

                    if (val.includes('Risk: High')) {
                        badge.innerHTML = ` <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800 border border-red-200"> High Risk</span> `;
                        badge.classList.remove('hidden');
                        document.getElementById('sample-size-input').value = '3';
                    } else if (val.includes('Risk: Medium')) {
                        badge.innerHTML = ` <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200"> Medium Risk</span> `;
                        badge.classList.remove('hidden');
                        document.getElementById('sample-size-input').value = '1';
                    } else {
                        badge.classList.add('hidden');
                    }
                };

                window.updateAgendaButtonVisibility = function () {
                    const list = document.getElementById('agenda-item-list');
                    const btnContainer = document.getElementById('btn-add-another-agenda-container');
                    if (!list || !btnContainer) return;

                    // If list has 0 items, Hide "Add Another". Button is only for adding *subsequent* items via the bottom area.
                    // Wait, if list is empty, user needs a way to add FIRST item.
                    // Ah, there is a Top button "Add Item" (Line 2638).
                    // So if list is empty, top button is sufficient (or visible).
                    // Bottom button is explicitly "Add Another".

                    const count = list.children.length;
                    if (count > 0) {
                        btnContainer.classList.remove('hidden');
                    } else {
                        btnContainer.classList.add('hidden');
                    }
                };

                window.addAgendaItem = function (data = null) {
                    const list = document.getElementById('agenda-item-list');
                    const id = Date.now() + Math.floor(Math.random() * 1000); // Ensure unique ID
                    const presenterOptions = getPresenterOptions();

                    const titleValue = data && data.item ? data.item : '';
                    const durationValue = data && data.duration ? data.duration : '';
                    // For presenter, we might need more logic if we want to pre-select, but simple for now

                    // Get RTE HTML with potential initial value (we'll implement value injection in getRTEHtml later if needed for agenda notes, 
                    // but usually agenda notes start empty. If we want pre-filled description:
                    const descValue = data && data.description ? data.description : '';

                    const notesRTE = getRTEHtml('min-h-[100px]', 'Item description and notes...', descValue);

                    const html = `
                            <div class="agenda-item bg-white border border-slate-200 rounded-lg p-4 shadow-sm" id="agenda-item-${id}">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-grow grid grid-cols-1 md:grid-cols-12 gap-3 mr-4">
                                        <div class="md:col-span-6">
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Item Title</label>
                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm font-semibold text-slate-800" placeholder="Agenda Item Title" value="${titleValue}">
                                        </div>
                                        <div class="md:col-span-2">
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Duration</label>
                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="e.g. 15m" value="${durationValue}">
                                        </div>
                                        <div class="md:col-span-4">
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Presenter</label>
                                            <select class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                                ${presenterOptions}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="flex items-center mt-6">
                                        <button type="button" class="text-slate-400 hover:text-red-500 p-1 transition-colors" data-action="remove-closest" data-target=".agenda-item" title="Remove Item">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Description & Notes</label>
                                    ${notesRTE}
                                </div>
            
                                <div id="agenda-subs-${id}" class="space-y-3 pl-4 border-l-2 border-slate-100"></div>
                                
                                <button type="button" class="mt-3 ml-1 text-xs flex items-center text-blue-600 hover:text-blue-800 font-medium transition-colors border border-transparent hover:bg-blue-50 px-2 py-1 rounded" data-action="add-agenda-sub-item" data-id="${id}">
                                    <i data-lucide="plus" class="w-3 h-3 mr-1"></i> Add Sub-item
                                </button>
                            </div>`;

                    list.insertAdjacentHTML('beforeend', html);
                    lucide.createIcons();
                    updateAgendaButtonVisibility();

                    // If sub-items exist in data, add them using STANDARD format
                    if (data && data.subItems && data.subItems.length > 0) {
                        const container = document.getElementById(`agenda-subs-${id}`);
                        if (container) {
                            const presenterOptions = getPresenterOptions();
                            data.subItems.forEach(sub => {
                                const subTitle = sub.item || '';
                                const subPresenter = sub.presenter || '';
                                const subNotes = sub.notes || '';
                                const notesRTE = getRTEHtml('min-h-[60px]', 'Sub-item notes...', subNotes);

                                // Use exact same format as add-agenda-sub-item handler (Title + Presenter + Notes RTE)
                                const subHtml = `
                                    <div class="agenda-sub-item bg-slate-50 border border-slate-200 rounded-md p-3 relative group mt-2">
                                        <button type="button" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-action="remove-closest" data-target=".agenda-sub-item">
                                            <i data-lucide="x" class="w-4 h-4"></i>
                                        </button>
                                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-2">
                                            <div class="md:col-span-8">
                                                <label class="block text-xs font-medium text-slate-500 mb-1">Sub-item Title</label>
                                                <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm" value="${subTitle}" placeholder="Sub-item title...">
                                            </div>
                                            <div class="md:col-span-4">
                                                <label class="block text-xs font-medium text-slate-500 mb-1">Presenter</label>
                                                <select class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                                    ${presenterOptions}
                                                </select>
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Notes</label>
                                            ${notesRTE}
                                        </div>
                                    </div>`;
                                container.insertAdjacentHTML('beforeend', subHtml);
                            });
                            lucide.createIcons();
                        }
                    }
                };



                window.openAddActionModal = function (context = 'meeting') {
                    window.activeActionContext = context;
                    openModal('modal-add-action-item');
                    document.getElementById('action-item-form').reset();
                };

                window.saveActionItem = function () {
                    const task = document.getElementById('action-task').value;
                    const dueDate = document.getElementById('action-due-date').value || '-';
                    const status = document.getElementById('action-status').value;

                    if (!task.trim()) {
                        alert('Please enter a task description.');
                        return;
                    }

                    const assignees = getMultiSelectValues('action-assign-select').join(', ') || 'Unassigned';

                    const tableBodyId = 'validation-action-items-body';
                    const emptyStateId = 'validation-action-empty-state';

                    const tableBody = document.getElementById(tableBodyId);
                    const emptyState = document.getElementById(emptyStateId);

                    if (emptyState) emptyState.classList.add('hidden');

                    // Add Row (Table Format)
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0';
                    row.innerHTML = `
                                 <td class="px-4 py-3 text-sm text-slate-900 font-medium">${task}</td>
                                 <td class="px-4 py-3 text-sm text-slate-600">${assignees}</td>
                                 <td class="px-4 py-3 text-sm text-slate-600">${dueDate}</td>
                                 <td class="px-4 py-3">
                                     <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(status)}">
                                         ${status}
                                     </span>
                                 </td>
                                 <td class="px-4 py-3 text-right">
                                     <div class="flex justify-end gap-2">
                                        <button class="text-slate-400 hover:text-blue-600 p-1 transition-colors"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                        <button class="text-slate-400 hover:text-red-500 p-1" onclick="this.closest('tr').remove()"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                     </div>
                                 </td>
                            `;

                    if (tableBody) tableBody.appendChild(row);

                    // Close modal
                    closeModal('modal-add-action-item');
                    lucide.createIcons();
                };



                window.addActionItem = function () {
                    openAddActionModal();
                };

                // Validation Participant Edit/Remove functions
                window.editValidationParticipant = function (index) {
                    alert('Edit validation participant: index ' + index);
                };

                window.removeValidationParticipant = function (index) {
                    if (confirm('Are you sure you want to remove this participant?')) {
                        // Placeholder - in production this would remove from array and re-render
                        alert('Participant removed');
                    }
                };

                window.checkCompliance = function () {
                    const banner = document.getElementById('compliance-banner');
                    const bannerText = document.getElementById('compliance-banner-text');

                    const requirements = ["Industry Currency", "Professional Development", "Trainer Credential"];
                    let missingEvidence = [];

                    requirements.forEach(req => {
                        const hasCoverage = document.querySelector(`.compliance - checkbox[data - type="${req}"]: checked`);
                        if (!hasCoverage) {
                            missingEvidence.push(req);
                        }
                    });

                    if (missingEvidence.length > 0) {
                        const missingList = missingEvidence.join(', ');
                        bannerText.textContent = `Compliance Pending: The team is collectively missing evidence for '${missingList}'.`;
                        banner.classList.remove('hidden');
                    } else {
                        banner.classList.add('hidden');
                    }
                };

                let currentAddPartTab = 'trainer';

                window.switchAddPartTab = function (tab) {
                    currentAddPartTab = tab;
                    const trainerBtn = document.getElementById('add-part-tab-trainer');
                    const externalBtn = document.getElementById('add-part-tab-external');
                    const trainerContent = document.getElementById('add-part-content-trainer');
                    const externalContent = document.getElementById('add-part-content-external');

                    if (tab === 'trainer') {
                        trainerBtn.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                        trainerBtn.classList.remove('text-slate-600', 'hover:text-slate-900', 'hover:bg-slate-200');

                        externalBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
                        externalBtn.classList.add('text-slate-600', 'hover:text-slate-900', 'hover:bg-slate-200');

                        trainerContent.classList.remove('hidden');
                        externalContent.classList.add('hidden');
                    } else {
                        externalBtn.classList.add('bg-blue-600', 'text-white', 'shadow-sm');
                        externalBtn.classList.remove('text-slate-600', 'hover:text-slate-900', 'hover:bg-slate-200');

                        trainerBtn.classList.remove('bg-blue-600', 'text-white', 'shadow-sm');
                        trainerBtn.classList.add('text-slate-600', 'hover:text-slate-900', 'hover:bg-slate-200');

                        externalContent.classList.remove('hidden');
                        trainerContent.classList.add('hidden');
                    }
                };

                window.addExternalDoc = function (input) {
                    if (input.files.length > 0) {
                        const list = document.getElementById('external-docs-list');
                        const file = input.files[0];
                        const item = document.createElement('div');
                        item.className = "flex items-center justify-between p-2 bg-slate-50 border border-slate-200 rounded text-sm";
                        item.innerHTML = `
                            <span class="text-slate-700 flex items-center gap-2"> <i data-lucide="file-check" class="w-4 h-4 text-green-600"></i> ${file.name}</span>
                                <button type="button" class="text-red-500 hover:text-red-700" onclick="this.parentElement.remove()"><i data-lucide="x" class="w-4 h-4"></i></button>
                        `;
                        list.appendChild(item);
                        lucide.createIcons();
                        input.value = '';
                    }
                };

                window.addParticipantFromModal = function () {
                    let name = '';
                    let role = '';
                    let initials = '';
                    let isExternal = currentAddPartTab !== 'trainer';
                    let externalFiles = [];

                    if (!isExternal) {
                        const val = document.getElementById('select-trainer-input').value;
                        const parts = val.split(' (');
                        name = parts[0];
                        role = parts[1] ? parts[1].replace(')', '') : 'Trainer';
                    } else {
                        const firstName = document.getElementById('external-first-name').value.trim();
                        const lastName = document.getElementById('external-last-name').value.trim();
                        const email = document.getElementById('external-email').value.trim();

                        if (!firstName || !lastName || !email) {
                            alert("Please enter First Name, Last Name, and Email for the external expert.");
                            return;
                        }

                        name = `${firstName} ${lastName} (External Expert)`;
                        role = document.getElementById('external-role').value || 'External Expert';

                        // Capture uploaded files for External
                        const list = document.getElementById('external-docs-list');
                        if (list) {
                            externalFiles = Array.from(list.querySelectorAll('span.text-slate-700')).map(el => el.innerText.trim());
                        }

                        // Store email for display
                        role += `  ${email}`;
                    }

                    initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                    const list = document.getElementById('participant-list');

                    // Conditional HTML segments
                    // Conditional HTML segments
                    const viewEvidenceLink = isExternal ?
                        `<div class="mt-1 text-xs text-slate-500 italic">Review Credential Evidence and Tag Evidence Present Below</div>` :
                        `<div class="flex flex-col mt-1">
                                    <span class="text-xs text-slate-500 italic">Credential Evidence From Trainer Matrix</span>
                                    <button type="button" class="text-xs text-blue-600 font-medium hover:underline text-left">View Linked Evidence</button>
                                 </div>`;

                    let credentialEvidenceSection = '';
                    if (isExternal) {
                        const filesHtml = externalFiles.map(f => `
                            <div class="flex items-center gap-2 text-xs text-slate-600 mt-1">
                                <i data-lucide="file-check" class="w-3 h-3 text-green-600"></i> ${f}
                                    </div>`).join('');

                        credentialEvidenceSection = `
                            <div class="mt-2 text-xs">
                                        <p class="font-semibold text-slate-800">Credential Evidence:</p>
                                        <div class="pl-1">${filesHtml || '<span class="text-slate-400 italic">No documents uploaded</span>'}</div>
                                    </div>
                            `;
                    }

                    const editButton = isExternal ?
                        `<button class="p-1 text-slate-400 hover:text-blue-600" onclick="openModal('modal-add-participant')"> <i data-lucide="pencil" class="w-4 h-4"></i></button>` : '';

                    const cardHtml = `
                            <div class="bg-white border border-slate-200 rounded-md shadow-sm participant-card">
                                <div class="p-4 flex items-start justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">
                                            ${initials}
                                        </div>
                                        <div>
                                            <p class="text-sm font-bold text-slate-900">${name}</p>
                                            <p class="text-xs text-slate-500">${role}</p>
                                            ${credentialEvidenceSection}
                                            ${viewEvidenceLink}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="flex flex-col items-end">
                                            <span class="text-[10px] text-slate-500 font-semibold mb-0.5">Attendance</span>
                                            <select class="text-xs border-slate-300 rounded shadow-sm focus:ring-blue-500 focus:border-blue-500 py-1" onclick="event.stopPropagation()">
                                                <option value="pending">Pending</option>
                                                <option value="accepted">Accepted</option>
                                                <option value="tentative">Tentative</option>
                                                <option value="declined">Declined</option>
                                            </select>
                                        </div>
                                        <label class="flex items-center text-xs text-slate-600 gap-1 cursor-pointer">
                                            <input type="checkbox" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                            Independent
                                        </label>
                                        <div class="flex gap-1">
                                                ${editButton}
                                                <button class="p-1 text-slate-400 hover:text-red-600" onclick="this.closest('.bg-white').remove(); checkCompliance();"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-3 border-t border-slate-100 rounded-b-md">
                                    <p class="text-xs font-semibold text-slate-700 mb-2">Tag evidence against requirements:</p>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Industry Currency" checked onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Industry Currency</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Professional Development" onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Professional Development</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Trainer Credential" checked onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Trainer Credential</span>
                                        </label>
                                    </div>
                                </div>
                            </div > `;

                    list.insertAdjacentHTML('beforeend', cardHtml);
                    lucide.createIcons();

                    checkCompliance();
                    closeModal('modal-add-participant');
                };

                const sampleSizeInput = document.getElementById('sample-size-input');
                const studentAssessmentsList = document.getElementById('student-assessments-list');
                const uploadAssessmentType = document.getElementById('upload-assessment-type');
                const btnDisplaySamples = document.getElementById('btn-display-samples');

                const rplSampleSizeInput = document.getElementById('rpl-sample-size-input');
                const rplAssessmentsList = document.getElementById('rpl-assessments-list');

                const hiddenFolderInput = document.getElementById('hidden-folder-input');
                let currentSampleContextId = null;

                if (hiddenFolderInput) {
                    hiddenFolderInput.addEventListener('change', (e) => {
                        if (e.target.files.length > 0 && currentSampleContextId) {
                            const row = document.getElementById(currentSampleContextId);
                            const fileListContainer = row.querySelector('.sample-files-list');

                            for (const file of e.target.files) {
                                const fileHtml = `
                            <div class="flex items-center justify-between bg-slate-50 p-2 rounded border border-slate-200 text-xs mt-2">
                                            <span class="truncate text-slate-700 font-medium">${file.name}</span>
                                            <button type="button" class="text-red-500 hover:text-red-700" onclick="this.parentElement.remove()">
                                                <i data-lucide="x" class="w-3 h-3"></i>
                                            </button>
                                        </div > `;
                                fileListContainer.insertAdjacentHTML('beforeend', fileHtml);
                            }
                            lucide.createIcons();
                        }
                        hiddenFolderInput.value = '';
                    });
                }

                window.handleModalFileSelect = function (input) {
                    const modal = document.getElementById('modal-val-doc-upload');
                    document.getElementById('file-name-display').textContent = input.files[0].name;
                    document.getElementById('file-name-display').classList.remove('hidden');

                    if (modal.dataset.autoName === 'true') {
                        console.log("Auto-naming document:", input.files[0].name);
                    }
                };

                window.triggerFolderUpload = function (rowId) {
                    currentSampleContextId = rowId;
                    if (hiddenFolderInput) hiddenFolderInput.click();
                }



                // Function to check and validate student assessment fields for Display Samples button
                window.checkStudentAssessmentFields = function () {
                    const btnDisplaySamples = document.getElementById('btn-display-samples');
                    const displaySamplesError = document.getElementById('display-samples-error');
                    if (!btnDisplaySamples) return;

                    const size = document.getElementById('sample-size-input')?.value;
                    const months = document.getElementById('assessments-months')?.value;

                    const assessorContainer = document.getElementById('student-assessments-trainers-select');
                    const hasAssessors = assessorContainer && assessorContainer.querySelectorAll('.multi-select-tag').length > 0;

                    const outcomeContainer = document.getElementById('outcome-types-select');
                    const hasOutcomes = outcomeContainer && outcomeContainer.querySelectorAll('.multi-select-tag').length > 0;

                    // Enable button if required fields are filled
                    const isValid = size && months;
                    btnDisplaySamples.disabled = !isValid;

                    if (displaySamplesError) {
                        displaySamplesError.classList.toggle('hidden', isValid);
                        if (!isValid) {
                            displaySamplesError.textContent = 'Please fill in Sample Size and Collection Period';
                        }
                    }
                };

                const inputs = ['sample-size-input', 'sample-rationale', 'assessments-months'];
                inputs.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', checkStudentAssessmentFields);
                });

                setTimeout(checkStudentAssessmentFields, 100);

                if (btnDisplaySamples) {
                    btnDisplaySamples.addEventListener('click', () => {
                        // Validation Check
                        const size = document.getElementById('sample-size-input').value;
                        const rationale = document.getElementById('sample-rationale').value;
                        const months = document.getElementById('assessments-months').value;

                        const assessorContainer = document.getElementById('student-assessments-trainers-select');
                        const hasAssessors = assessorContainer && assessorContainer.querySelectorAll('.multi-select-tag').length > 0;

                        const outcomeContainer = document.getElementById('outcome-types-select');
                        const hasOutcomes = outcomeContainer && outcomeContainer.querySelectorAll('.multi-select-tag').length > 0;

                        const errorSpan = document.getElementById('display-samples-error');

                        if (!size || !rationale || !months || !hasAssessors || !hasOutcomes) {
                            if (errorSpan) {
                                errorSpan.textContent = "Please complete all required fields:\n- Sample Size\n- Collection Period\n- Rationale\n- Assessors (Select at least one)\n- Outcomes (Select at least one)";
                                errorSpan.classList.remove('hidden');
                            }
                            return;
                        }

                        // Hide error if valid
                        if (errorSpan) errorSpan.classList.add('hidden');

                        const count = parseInt(sampleSizeInput.value) || 0;
                        const type = uploadAssessmentType.value;
                        renderSampleRows(count, type);
                    });
                }

                if (rplSampleSizeInput && rplAssessmentsList) {
                    rplSampleSizeInput.addEventListener('input', (e) => {
                        const val = parseInt(e.target.value) || 0;
                        renderRPLRows(val);
                    });
                    renderRPLRows(parseInt(rplSampleSizeInput.value) || 0);
                }

                function renderSampleRows(count, type) {
                    studentAssessmentsList.innerHTML = '';

                    const mockActivities = [
                        { submitted: '15/08/2025 10:32:42', activity: 'BSBSMB401 Learner Assessment', completed: '27/10/2025' },
                        { submitted: '15/08/2025 10:28:20', activity: 'Chapter 1: Learning Quiz', completed: '27/10/2025' },
                        { submitted: '15/08/2025 10:26:44', activity: 'Chapter 1: Learning Quiz', completed: '27/10/2025' }
                    ];

                    for (let i = 1; i <= count; i++) {
                        const rowId = `sample-row-${i}`;

                        let contentHtml = '';

                        if (type === 'lms') {
                            const activityRows = mockActivities.map(act => `
                            <tr>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-slate-500 border-r border-slate-200">${act.submitted}</td>
                                            <td class="px-3 py-2 text-xs text-slate-700 border-r border-slate-200">${act.activity}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs font-bold text-slate-900 border-r border-slate-200 text-center">${act.completed}</td>
                                            <td class="px-3 py-2 whitespace-nowrap text-xs text-center">
                                                <button type="button" class="text-blue-600 hover:text-blue-800 font-medium">View</button>
                                            </td>
                                        </tr>
                            `).join('');

                            contentHtml = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Student Name</label>
                                                <input type="text" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm bg-slate-50" value="Student ${i} (LMS)" readonly>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Assessor</label>
                                                <input type="text" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm bg-slate-50" value="David Jones" readonly>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Outcome</label>
                                                <input type="text" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm bg-slate-50" value="Competent" readonly>
                                            </div>
                                        </div>
                            <div class="mt-4 border rounded overflow-hidden border-slate-300">
                                <table class="min-w-full divide-y divide-slate-300">
                                    <thead class="bg-slate-600 text-white">
                                        <tr>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-semibold uppercase tracking-wider border-r border-slate-500">Date Submitted</th>
                                            <th scope="col" class="px-3 py-2 text-left text-xs font-semibold uppercase tracking-wider border-r border-slate-500">Activity</th>
                                            <th scope="col" class="px-3 py-2 text-center text-xs font-semibold uppercase tracking-wider border-r border-slate-500">Date Completed</th>
                                            <th scope="col" class="px-3 py-2 text-center text-xs font-semibold uppercase tracking-wider">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-slate-200">
                                        ${activityRows}
                                    </tbody>
                                </table>
                            </div>
                        `;
                        } else {
                            contentHtml = `
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Student Name</label>
                                                <input type="text" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm" placeholder="Search student...">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Assessor</label>
                                                <select class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm">
                                                    <option value="">Select Assessor</option>
                                                    <option>David Jones</option>
                                                    <option>Emily White</option>
                                                    <option>Michael Brown</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 uppercase">Outcome</label>
                                                <select class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm">
                                                    <option>Competent</option>
                                                    <option>Not Yet Competent</option>
                                                </select>
                                            </div>
                                        </div>
                            <div class="mt-3">
                                <label class="block text-xs font-medium text-slate-500 uppercase mb-1">Evidence</label>
                                <div class="flex gap-2">
                                    <button type="button" class="flex-1 flex items-center justify-center gap-2 border border-slate-300 rounded p-2 text-xs font-medium text-slate-600 hover:bg-slate-50 transition-colors" onclick="openModal('modal-val-doc-upload', 'auto-name')">
                                        <i data-lucide="file" class="w-4 h-4"></i> Upload File
                                    </button>
                                    <button type="button" class="flex-1 flex items-center justify-center gap-2 border border-dashed border-blue-300 bg-blue-50 rounded p-2 text-xs font-medium text-blue-700 hover:bg-blue-100 transition-colors" onclick="triggerFolderUpload('${rowId}')">
                                        <i data-lucide="folder-up" class="w-4 h-4"></i> Upload Folder
                                    </button>
                                </div>
                                <div class="sample-files-list mt-2">
                                </div>
                            </div>
                        `;
                        }

                        const rowHtml = `
                            <div class="border rounded-md bg-white shadow-sm transition-all" id="${rowId}">
                                    <div class="flex justify-between items-center p-4 cursor-pointer bg-slate-100 hover:bg-slate-200 rounded-t-md border-b border-slate-200" data-toggle-sample-row="${rowId}">
                                        <div class="flex items-center gap-2">
                                            <i data-lucide="chevron-down" class="w-5 h-5 text-slate-700 transition-transform duration-200" id="${rowId}-chevron"></i>
                                            <h5 class="font-bold text-slate-700">Sample ${i}</h5>
                                        </div>
                                        <div class="flex items-center gap-3">
                                             <span class="text-xs font-medium text-slate-500">Incomplete</span>
                                             <div class="action-menu-container relative" onclick="event.stopPropagation()">
                                                <button type="button" class="text-slate-400 hover:text-slate-600 p-1 action-menu-trigger" onclick="toggleActionMenu(this)">
                                                    <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                                                </button>
                                                <div class="action-menu-dropdown text-left shadow-lg rounded-md border border-slate-200 bg-white right-0 w-40">
                                                    <div class="action-menu-item flex items-center gap-2" onclick="openModal('modal-val-doc-upload')">
                                                        <i data-lucide="upload" class="w-4 h-4"></i> Upload
                                                    </div>
                                                    <div class="action-menu-item delete flex items-center gap-2 text-red-600">
                                                        <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="${rowId}-content" class="px-4 pb-4 border-t border-slate-100">
                                        ${contentHtml}
                                    </div>
                                </div> `;
                        studentAssessmentsList.insertAdjacentHTML('beforeend', rowHtml);
                    }
                    lucide.createIcons();
                }

                // NEW: Explicit RPL Generator
                window.generateRPLSamples = function () {
                    const rplInput = document.getElementById('rpl-sample-size-input');
                    const val = parseInt(rplInput.value) || 0;
                    renderRPLRows(val);
                };

                function renderRPLRows(count) {
                    const rplAssessmentsList = document.getElementById('rpl-assessments-list');
                    if (!rplAssessmentsList) return;

                    rplAssessmentsList.innerHTML = '';
                    for (let i = 1; i <= count; i++) {
                        const rowId = `rpl-row-${i}`;
                        const rowHtml = `
                    <div class="border rounded-md bg-white shadow-sm transition-all" id="${rowId}">
                            <div class="flex justify-between items-center p-4 cursor-pointer bg-slate-100 hover:bg-slate-200 rounded-t-md border-b border-slate-200" data-toggle-sample-row="${rowId}">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="chevron-down" class="w-5 h-5 text-slate-700 transition-transform duration-200" id="${rowId}-chevron"></i>
                                    <h5 class="font-bold text-slate-700">RPL Sample ${i}</h5>
                                </div>
                                <div class="flex items-center gap-3">
                                     <span class="text-xs font-medium text-slate-500">Incomplete</span>
                                     <div class="action-menu-container relative" onclick="event.stopPropagation()">
                                        <button type="button" class="text-slate-400 hover:text-slate-600 p-1 action-menu-trigger" onclick="toggleActionMenu(this)">
                                            <i data-lucide="more-horizontal" class="w-5 h-5"></i>
                                        </button>
                                        <div class="action-menu-dropdown text-left shadow-lg rounded-md border border-slate-200 bg-white right-0 w-40">
                                            <div class="action-menu-item flex items-center gap-2" onclick="openModal('modal-val-doc-upload')">
                                                <i data-lucide="upload" class="w-4 h-4"></i> Upload
                                            </div>
                                            <div class="action-menu-item delete flex items-center gap-2 text-red-600">
                                                <i data-lucide="trash-2" class="w-4 h-4"></i> Clear
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div id="${rowId}-content" class="px-4 pb-4 border-t border-slate-100">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 uppercase">Candidate Name</label>
                                        <input type="text" class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm" placeholder="Search candidate...">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 uppercase">Assessor</label>
                                        <select class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm">
                                            <option value="">Select Assessor</option>
                                            <option>David Jones</option>
                                            <option>Emily White</option>
                                            <option>Michael Brown</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-slate-500 uppercase">Outcome</label>
                                        <select class="mt-1 block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 text-sm">
                                            <option>Competent</option>
                                            <option>Not Yet Competent</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mt-3">
                                     <label class="block text-xs font-medium text-slate-500 uppercase mb-1">RPL Evidence</label>
                                     <div class="flex gap-2">
                                        <button type="button" class="flex-1 flex items-center justify-center gap-2 border border-slate-300 rounded p-2 text-xs font-medium text-slate-600 hover:bg-slate-50 transition-colors" onclick="openModal('modal-val-doc-upload', 'auto-name')">
                                            <i data-lucide="file" class="w-4 h-4"></i> Upload File
                                         </button>
                                         <button type="button" class="flex-1 flex items-center justify-center gap-2 border border-dashed border-blue-300 bg-blue-50 rounded p-2 text-xs font-medium text-blue-700 hover:bg-blue-100 transition-colors" onclick="triggerFolderUpload('${rowId}')">
                                            <i data-lucide="folder-up" class="w-4 h-4"></i> Upload Folder
                                         </button>
                                     </div>
                                     <div class="sample-files-list mt-2">
                                     </div>
                                </div>
                            </div>
                        </div> `;
                        rplAssessmentsList.insertAdjacentHTML('beforeend', rowHtml);
                    }
                    lucide.createIcons();
                }



                let activeCIContext = 'val';

                window.openAddRiskModal = function (context) {
                    currentRiskContext = context;
                    document.getElementById('form-risk').reset();
                    document.getElementById('risk-id').value = ''; // Clear ID for new
                    document.getElementById('modal-risk-title').innerText = 'New Risk';
                    document.getElementById('risk-review-date').valueAsDate = new Date();

                    // Populate Added By (hardcoded user for now)
                    document.getElementById('risk-added-by').value = 'David Jones';

                    // Populate Source based on context
                    const sourceField = document.getElementById('risk-source');
                    if (context === 'val') {
                        // For validation context, get program/unit info
                        const programs = getMultiSelectValues('program-multi-select');
                        const units = getMultiSelectValues('units-multi-select');
                        const programText = programs.length > 0 ? programs[0] : 'Validation';
                        const unitText = units.length > 0 ? ` - ${units[0].split(' - ')[0]}` : '';
                        sourceField.value = `Validation Event: ${programText}${unitText}`;
                    } else if (context === 'meeting') {
                        // For meeting context, get meeting title
                        const title = document.getElementById('meeting-title')?.value || 'General Meeting';
                        const types = getMultiSelectValues('meeting-type-select');
                        const typeText = types.length > 0 ? types[0] : 'Meeting';
                        sourceField.value = `${typeText}: ${title}`;
                    } else {
                        sourceField.value = 'General Risk Register';
                    }

                    // Initialize Dropdowns
                    populateDivisions();
                    document.getElementById('risk-standards').innerHTML = '<option value="">Select Division First</option>';
                    document.getElementById('risk-standards').disabled = true;
                    document.getElementById('risk-kpi').innerHTML = '<option value="">Select Standard First</option>';
                    document.getElementById('risk-kpi').disabled = true;

                    openModal('modal-add-risk');
                };

                // --- Cascading RTO Dropdown Logic ---



                // --- 2025 RTO Standards Data & Logic ---
                const RTO_STANDARDS_2025 = {
                    "Quality Area 1: Training and Assessment": {
                        "Training": {
                            "Standard 1.1 - Training is engaging, well-structured and enables VET students to attain skills and knowledge consistent with the training product.": [
                                "1.1.a - Training is consistent with the requirements of the training product;",
                                "1.1.b - The modes of delivery enable VET students to attain skills and knowledge consistent with the training product;",
                                "1.1.c - Training is structured and paced to support VET students to progress, providing sufficient time for instruction, practice, feedback and assessment;",
                                "1.1.d - Training techniques, activities and resources engage VET students and support their understanding;",
                                "1.1.e - Where the training product requires work placements or other community-based learning, necessary skills and knowledge are able to be attained in that environment."
                            ],
                            "Standard 1.2 - Engagement with industry, employer and community representatives effectively informs the industry relevance of training.": [
                                "1.2.a - How it identifies relevant industry, employer and community representatives and seeks meaningful advice and feedback from those representatives;",
                                "1.2.b - It uses relevant advice and feedback to inform changes to training and assessment strategies and practices;",
                                "1.2.c - Training reflects current industry practice."
                            ]
                        },
                        "Assessment": {
                            "Standard 1.3 - The assessment system is fit-for-purpose and consistent with the training product.": [
                                "1.3.a - The assessment is consistent with the requirements of the training product;",
                                "1.3.b - Assessment tools are reviewed prior to use to ensure assessment can be conducted in a way that is consistent with the principles of assessment and rules of evidence set out under Standard 1.4;",
                                "1.3.c - The outcomes of any such reviews inform any necessary changes to assessment tools."
                            ],
                            "Standard 1.4 - The assessment system ensures assessment is conducted in a way that is fair and appropriate and enables accurate assessment judgement.": [
                                "1.4.a - The assessment system facilitates assessment which must be conducted in accordance with the principles of fairness, flexibility, validity and reliability;",
                                "1.4.b - Assessors make individual assessment judgements that are justified based on the rules of evidence: validity, sufficiency, authenticity and currency."
                            ],
                            "Standard 1.5 - The assessment system is quality assured by appropriately skilled and credentialled persons through a regular process of validating assessment practices and judgements.": [
                                "1.5.a - Validation of assessment practices and judgements ensure the assessment system produces assessment judgements that are consistent with the training product and comply with the requirements set out in this instrument;",
                                "1.5.b - Every training product on the organisations scope of registration is validated at least once every five years and on a more frequent basis where risks are identified;",
                                "1.5.c - It utilises a risk-based approach to determine the components of the assessment system to be validated and the sample size;",
                                "1.5.d - The assessment system for an AQF qualification from the Training and Education Training Package is validated once the first cohort has completed training, by an independent person;",
                                "1.5.e - Validation is undertaken by one or more people who collectively have industry competencies, practical understanding, and validation credentials;",
                                "1.5.f - The outcome of an assessment validation is not solely determined by a person who has designed or delivered the training or assessment;",
                                "1.5.g - Outcomes of an assessment validation are used to inform changes to the assessment system."
                            ]
                        }
                    },
                    "Quality Area 2: VET Student Support": {
                        "Information": {
                            "Standard 2.1 - VET students have access to clear and accurate information concerning the organisation and the relevant training product.": [
                                "2.1.a - All information provided to VET students by the organisation or any third parties is clear, accurate and current;",
                                "2.1.b - How it identifies which information VET students require prior to their enrolment and how that information is communicated;",
                                "2.1.c - The following information is easily accessible: training product code/title, modes of delivery, support services, fees/costs, and obligations;",
                                "2.1.d - The organisation provides all VET students with documentation prior to enrolment setting out training services, fees, and obligations;",
                                "2.1.e - It informs VET students, as soon as practicable, of any changes to training products or the organisations operations that may affect them."
                            ],
                            "Standard 2.2 - VET students are advised, prior to enrolment, about the suitability of the training product for them.": [
                                "2.2.a - Taking into account the requirements of the training product, it has procedures in place to review the skills and competencies of prospective VET students;",
                                "2.2.b - Based upon the outcome of the review, it provides advice to each prospective VET student about whether the training product is suitable for them."
                            ]
                        },
                        "Training support": {
                            "Standard 2.3 - VET students have access to support services, trainers and assessors and other staff to support their progress throughout the training product.": [
                                "2.3.a - How it determines the training support services to be provided to each VET student and how it makes these services available;",
                                "2.3.b - VET students have access to trainers, assessors and other staff who are responsible for supporting the VET student;",
                                "2.3.c - It identifies, by reference to the training product content, the wellbeing needs of the VET student cohort and appropriate wellbeing support services;",
                                "2.3.d - It advises the VET student cohort of the availability of wellbeing support services and additional action students can take to support their wellbeing."
                            ]
                        },
                        "Feedback, complaints and appeals": {
                            "Standard 2.7 - Feedback and complaints management addresses concerns and informs continuous improvement.": [
                                "2.7.a - It operates a complaints management system that allows feedback, ensures procedural fairness, identifies timeframes, and provides avenues for further action;",
                                "2.7.b - Information about how to provide feedback and make complaints is publicly available and easily accessible;",
                                "2.7.c - VET students are supported to provide feedback and make complaints;",
                                "2.7.d - Outcomes of complaints are documented and communicated to all parties;",
                                "2.7.e - Feedback and complaints are used by the organisation to inform continuous improvement."
                            ],
                            "Standard 2.8 - Effective appeal processes are available to VET students.": [
                                "2.8.a - It operates an appeals management system that allows appeals, ensures procedural fairness, specifies timeframes, and provides avenues for independent review;",
                                "2.8.b - Information about how to appeal an adverse decision is publicly available and easily accessible;",
                                "2.8.c - Outcomes of appeals are documented by the organisation and communicated to the appellant;",
                                "2.8.d - The outcomes of appeals are used by the organisation to inform continuous improvement."
                            ]
                        }
                    },
                    "Quality Area 3: VET Workforce": {
                        "VET workforce management": {
                            "Standard 3.1 - The workforce is effectively managed to ensure appropriate staffing to deliver services.": [
                                "3.1.a - How it ensures the number of trainers, assessors and other staff are appropriate for the delivery of the services it offers;",
                                "3.1.b - It facilitates access to continuing professional development opportunities to enable staff to effectively perform their role."
                            ]
                        },
                        "Trainer and assessor competencies": {
                            "Standard 3.2 - Training and assessment is delivered to VET students by credentialled people with current skills and knowledge in training and assessment.": [
                                "3.2.a - Training and assessment is only delivered by persons who hold the appropriate credentials for the delivery of training and assessment as specified in the Credential Policy;",
                                "3.2.b - Where the Credential Policy permits a person to deliver any training or assessment under direction  the organisation has systems in place that ensure the person does not make assessment judgments and is delivering quality training and assessment;",
                                "3.2.c - How it ensures all trainers and assessors undertake continuing professional development to maintain current skills and knowledge in training and assessment."
                            ],
                            "Standard 3.3 - Training and assessment is delivered by persons with current industry skills and knowledge relevant to the training product.": [
                                "3.3.a - All persons delivering training or assessment: (i) have industry competencies, skills and knowledge that are relevant to the training product; and (ii) maintain an understanding of current industry practices."
                            ]
                        }
                    },
                    "Quality Area 4: Governance": {
                        "Leadership and accountability": {
                            "Standard 4.1 - An NVR registered training organisation operates with integrity and maintains accountability for the delivery of quality services.": [
                                "4.1.a - The organisation and its governing persons are fit and proper persons;",
                                "4.1.b - Its governing persons are suitable persons to oversee the operation of the organisation;",
                                "4.1.c - Its governing persons act diligently and make informed decisions which facilitate compliance;",
                                "4.1.d - Its governing persons lead a culture of integrity, fairness and transparency."
                            ],
                            "Standard 4.2 - Roles and responsibilities of NVR registered training organisation staff and third parties are clearly defined and understood.": [
                                "4.2.a - It supports staff members to understand the components of this instrument relevant to their role;",
                                "4.2.b - It informs staff members of any changes to regulatory or legislative requirements;",
                                "4.2.c - It has a system in place for ensuring any third parties meet the requirements of this instrument;",
                                "4.2.d - The roles and responsibilities of persons engaged by the organisation are well-understood and documented."
                            ]
                        },
                        "Risk management": {
                            "Standard 4.3 - Any risks to VET students, staff and the organisation itself are identified and managed.": [
                                "4.3.a - It identifies, manages and reviews risks to VET students, staff and the organisation;",
                                "4.3.b - How the financial position, financial performance and cashflows are managed, monitored and understood;",
                                "4.3.c - It has a system for identifying, managing and disclosing any real or apparent conflicts of interest;",
                                "4.3.d - Where it offers training to VET students under 18, risks to their safety and wellbeing are identified and managed in accordance with National Principles."
                            ]
                        },
                        "Continuous improvement": {
                            "Standard 4.4 - Systematic monitoring and evaluation supports quality delivery and continuous improvement.": [
                                "4.4.a - It has a system in place for monitoring and evaluating its performance with the requirements set out in this instrument;",
                                "4.4.b - How outcomes derived from monitoring and evaluating its performance are used to inform continuous improvement;",
                                "4.4.c - It has mechanisms in place to lawfully collect and analyse data including feedback."
                            ]
                        }
                    }
                };

                function initStandardsFilters() {
                    // Both Meeting and Validation modals share the same val-standards-* containers
                    ['val'].forEach(prefix => {
                        // Start from Quality Area (Root)
                        setupStandardsFilter(prefix, 'quality-area', Object.keys(RTO_STANDARDS_2025));
                    });
                }

                function setupStandardsFilter(prefix, level, data, parentKey = null) {
                    const containerId = `${prefix}-standards-${level}`;
                    renderStandardsMultiSelect(containerId, data, (selectedValues) => {
                        handleStandardsFilterChange(prefix, level, selectedValues);
                    });
                }

                function handleStandardsFilterChange(prefix, level, selectedValues) {
                    // Clear downstream
                    const levels = ['quality-area', 'division', 'standard', 'performance-indicator'];
                    const currentIndex = levels.indexOf(level);

                    // Clear all levels below current
                    for (let i = currentIndex + 1; i < levels.length; i++) {
                        const nextLevel = levels[i];
                        renderStandardsMultiSelect(`${prefix}-standards-${nextLevel}`, [], () => { });
                    }

                    if (selectedValues.length === 0) return;

                    // Populate next level based on selection
                    if (level === 'quality-area') {
                        // Update Divisions
                        let divisions = [];
                        selectedValues.forEach(qa => {
                            if (RTO_STANDARDS_2025[qa]) {
                                divisions = [...divisions, ...Object.keys(RTO_STANDARDS_2025[qa])];
                            }
                        });
                        setupStandardsFilter(prefix, 'division', [...new Set(divisions)]);

                    } else if (level === 'division') {
                        // Update Standards
                        let standards = [];
                        const selectedQAs = getSelectedValues(`${prefix}-standards-quality-area`);

                        selectedQAs.forEach(qa => {
                            const qaData = RTO_STANDARDS_2025[qa];
                            if (qaData) {
                                selectedValues.forEach(div => {
                                    if (qaData[div]) {
                                        standards = [...standards, ...Object.keys(qaData[div])];
                                    }
                                });
                            }
                        });
                        setupStandardsFilter(prefix, 'standard', [...new Set(standards)]);

                    } else if (level === 'standard') {
                        // Update PIs
                        let indicators = [];
                        const selectedQAs = getSelectedValues(`${prefix}-standards-quality-area`);
                        const selectedDivs = getSelectedValues(`${prefix}-standards-division`);

                        selectedQAs.forEach(qa => {
                            const qaData = RTO_STANDARDS_2025[qa];
                            if (qaData) {
                                selectedDivs.forEach(div => {
                                    const divData = qaData[div];
                                    if (divData) {
                                        selectedValues.forEach(std => {
                                            if (divData[std]) {
                                                indicators = [...indicators, ...divData[std]];
                                            }
                                        });
                                    }
                                });
                            }
                        });
                        setupStandardsFilter(prefix, 'performance-indicator', [...new Set(indicators)]);
                    }
                }

                // NEW: Handle Auto-Population of Standards for Validation
                window.handleValidationTypeAutoPopulation = function () {
                    const typeContainer = document.getElementById('validation-meeting-type-select');
                    if (!typeContainer) return;

                    // Get selected type (Single select now)
                    const selectedType = typeContainer.value;

                    // Define Mapping Data
                    const MAPPING = {
                        "Pre-Assessment Validation": {
                            qas: ["Quality Area 1: Training and Assessment", "Quality Area 4: Governance"],
                            divs: ["Assessment", "Continuous improvement"],
                            stds: [
                                "Standard 1.3 - The assessment system is fit-for-purpose and consistent with the training product.",
                                "Standard 1.4 - The assessment system ensures assessment is conducted in a way that is fair and appropriate and enables accurate assessment judgement.",
                                "Standard 4.4 - Systematic monitoring and evaluation supports quality delivery and continuous improvement."
                            ],
                            pis: [
                                "1.3.a - The assessment is consistent with the requirements of the training product;",
                                "1.3.b - Assessment tools are reviewed prior to use to ensure assessment can be conducted in a way that is consistent with the principles of assessment and rules of evidence set out under Standard 1.4;",
                                "1.3.c - The outcomes of any such reviews inform any necessary changes to assessment tools.",
                                "1.4.a - The assessment system facilitates assessment which must be conducted in accordance with the principles of fairness, flexibility, validity and reliability;",
                                "1.4.b - Assessors make individual assessment judgements that are justified based on the rules of evidence: validity, sufficiency, authenticity and currency.",
                                "4.4.a - It has a system in place for monitoring and evaluating its performance with the requirements set out in this instrument;",
                                "4.4.b - How outcomes derived from monitoring and evaluating its performance are used to inform continuous improvement;"
                            ]
                        },
                        "Post-Assessment Validation": {
                            qas: ["Quality Area 1: Training and Assessment", "Quality Area 4: Governance"],
                            divs: ["Assessment", "Continuous improvement"],
                            stds: [
                                "Standard 1.3 - The assessment system is fit-for-purpose and consistent with the training product.",
                                "Standard 1.4 - The assessment system ensures assessment is conducted in a way that is fair and appropriate and enables accurate assessment judgement.",
                                "Standard 1.5 - The assessment system is quality assured by appropriately skilled and credentialled persons through a regular process of validating assessment practices and judgements.",
                                "Standard 4.4 - Systematic monitoring and evaluation supports quality delivery and continuous improvement."
                            ],
                            pis: [
                                "1.3.a - The assessment is consistent with the requirements of the training product;",
                                "1.3.b - Assessment tools are reviewed prior to use to ensure assessment can be conducted in a way that is consistent with the principles of assessment and rules of evidence set out under Standard 1.4;",
                                "1.3.c - The outcomes of any such reviews inform any necessary changes to assessment tools.",
                                "1.4.a - The assessment system facilitates assessment which must be conducted in accordance with the principles of fairness, flexibility, validity and reliability;",
                                "1.4.b - Assessors make individual assessment judgements that are justified based on the rules of evidence: validity, sufficiency, authenticity and currency.",
                                "1.5.a - Validation of assessment practices and judgements ensure the assessment system produces assessment judgements that are consistent with the training product and comply with the requirements set out in this instrument;",
                                "1.5.b - Every training product on the organisations scope of registration is validated at least once every five years and on a more frequent basis where risks are identified;",
                                "1.5.c - It utilises a risk-based approach to determine the components of the assessment system to be validated and the sample size;",
                                "1.5.d - The assessment system for an AQF qualification from the Training and Education Training Package is validated once the first cohort has completed training, by an independent person;",
                                "1.5.e - Validation is undertaken by one or more people who collectively have industry competencies, practical understanding, and validation credentials;",
                                "1.5.f - The outcome of an assessment validation is not solely determined by a person who has designed or delivered the training or assessment;",
                                "1.5.g - Outcomes of an assessment validation are used to inform changes to the assessment system.",
                                "4.4.a - It has a system in place for monitoring and evaluating its performance with the requirements set out in this instrument;",
                                "4.4.b - How outcomes derived from monitoring and evaluating its performance are used to inform continuous improvement;"
                            ]
                        }
                    };

                    let shouldLock = false;
                    let targetData = null;

                    if (selectedType && MAPPING[selectedType]) {
                        shouldLock = true;
                        targetData = MAPPING[selectedType];
                    }

                    // Helper to render and lock
                    const renderLockedLevel = (level, items) => {
                        const containerId = `val-standards-${level}`;
                        const container = document.getElementById(containerId);
                        if (!container) return;

                        // Render specifically the target items, passing them as initialSelection to ensure CHECKED
                        renderStandardsMultiSelect(containerId, items, () => { }, items);

                        // Lock visuals
                        container.classList.add('pointer-events-none', 'bg-slate-50', 'text-slate-500');
                    };

                    // Unlock helper
                    const unlockAndReset = (level) => {
                        const containerId = `val-standards-${level}`;
                        const container = document.getElementById(containerId);
                        if (container) container.classList.remove('pointer-events-none', 'bg-slate-50', 'text-slate-500');
                    };

                    if (shouldLock && targetData) {
                        renderLockedLevel('quality-area', targetData.qas);
                        renderLockedLevel('division', targetData.divs);
                        renderLockedLevel('standard', targetData.stds);
                        renderLockedLevel('performance-indicator', targetData.pis);
                    } else {
                        // Unlock and Reset logic
                        // 1. Reset Quality Area to ALL
                        unlockAndReset('quality-area');
                        renderStandardsMultiSelect('val-standards-quality-area', Object.keys(RTO_STANDARDS_2025), (selected) => {
                            handleStandardsFilterChange('val', 'quality-area', selected);
                        });

                        // 2. Clear others (unlocking them first to look normal, but they will be empty)
                        unlockAndReset('division');
                        unlockAndReset('standard');
                        unlockAndReset('performance-indicator');

                        renderStandardsMultiSelect('val-standards-division', [], () => { });
                        renderStandardsMultiSelect('val-standards-standard', [], () => { });
                        renderStandardsMultiSelect('val-standards-performance-indicator', [], () => { });
                    }
                }


                function getSelectedValues(containerId) {
                    const container = document.getElementById(containerId);
                    if (!container) return [];
                    return Array.from(container.querySelectorAll('input:checked')).map(cb => cb.value);
                }

                function renderStandardsMultiSelect(containerId, options, onChangeCallback, initialSelection = []) {
                    const container = document.getElementById(containerId);
                    if (!container) return;

                    container.innerHTML = ''; // Clear existing

                    if (!options || options.length === 0) {
                        let msg = 'No options available';
                        // Custom placeholders for specific fields
                        if (containerId.includes('quality-area')) msg = 'Select Your Quality Area e.g., "Training and Assessment"';
                        else if (containerId.includes('division')) msg = 'Select A Quality Area First';
                        else if (containerId.includes('performance-indicator')) msg = 'Select A Standard First';
                        else if (containerId.includes('standard')) msg = 'Select A Division First';

                        container.innerHTML = `<span class="text-xs text-slate-400 italic p-1">${msg}</span>`;
                        return;
                    }

                    const list = document.createElement('div');
                    list.className = 'flex flex-col gap-1 max-h-32 overflow-y-auto p-1'; // Limit height for UX

                    options.forEach(opt => {
                        const label = document.createElement('label');
                        label.className = 'inline-flex items-center gap-2 cursor-pointer hover:bg-slate-50 p-1 rounded';

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.value = opt;
                        checkbox.className = 'rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4';

                        if (initialSelection.includes(opt)) {
                            checkbox.checked = true;
                        }

                        const span = document.createElement('span');
                        span.className = 'text-xs text-slate-700';
                        span.textContent = opt;

                        checkbox.addEventListener('change', () => {
                            const selected = getSelectedValues(containerId);
                            onChangeCallback(selected);
                        });

                        label.appendChild(checkbox);
                        label.appendChild(span);
                        list.appendChild(label);
                    });

                    container.appendChild(list);
                }

                // Initialize on load
                // Initialize on load
                initStandardsFilters();

                // NOTE: Legacy RTO_STANDARDS_2025 object removed - duplicate declaration
                // The main RTO_STANDARDS_2025 is declared at line ~6012

                function populateDivisions() {
                    const divisionSelect = document.getElementById('risk-division');
                    divisionSelect.innerHTML = '<option value="">Please Select</option>';
                    Object.keys(RTO_STANDARDS_2025).forEach(div => {
                        const opt = document.createElement('option');
                        opt.value = div;
                        opt.textContent = div;
                        divisionSelect.appendChild(opt);
                    });
                }

                // Event Listeners for Cascading Logic
                document.getElementById('risk-division').addEventListener('change', function () {
                    const division = this.value;
                    const standardSelect = document.getElementById('risk-standards');
                    const kpiSelect = document.getElementById('risk-kpi');

                    // Reset downstream
                    standardSelect.innerHTML = '<option value="">Please Select</option>';
                    kpiSelect.innerHTML = '<option value="">Select Standard First</option>';
                    kpiSelect.disabled = true;

                    if (division && RTO_STANDARDS_2025[division]) {
                        standardSelect.disabled = false;
                        Object.keys(RTO_STANDARDS_2025[division]).forEach(std => {
                            const opt = document.createElement('option');
                            opt.value = std;
                            opt.textContent = std;
                            standardSelect.appendChild(opt);
                        });
                    } else {
                        standardSelect.disabled = true;
                        standardSelect.innerHTML = '<option value="">Select Division First</option>';
                    }
                });

                document.getElementById('risk-standards').addEventListener('change', function () {
                    const division = document.getElementById('risk-division').value;
                    const standard = this.value;
                    const kpiSelect = document.getElementById('risk-kpi');

                    // Reset downstream
                    kpiSelect.innerHTML = '<option value="">Please Select</option>';

                    if (division && standard && RTO_STANDARDS_2025[division][standard]) {
                        kpiSelect.disabled = false;
                        Object.keys(RTO_STANDARDS_2025[division][standard]).forEach(kpi => {
                            const opt = document.createElement('option');
                            opt.value = kpi;
                            opt.textContent = kpi;
                            kpiSelect.appendChild(opt);
                        });
                    } else {
                        kpiSelect.disabled = true;
                        kpiSelect.innerHTML = '<option value="">Select Standard First</option>';
                    }
                });
                window.openAddCIModal = function (context = 'val') {
                    console.log('Opening CI Modal with context:', context);
                    window.activeCIContext = context;

                    const dateInput = document.getElementById('ci-date');
                    if (dateInput) dateInput.valueAsDate = new Date();

                    const raisedByInput = document.getElementById('ci-raised-by');
                    if (raisedByInput) raisedByInput.value = 'User';

                    const userInput = document.getElementById('ci-user');
                    if (userInput) userInput.value = 'David Jones'; // Mock user

                    const statusInput = document.getElementById('ci-status');
                    if (statusInput) statusInput.value = 'New';

                    const relatesToInput = document.getElementById('ci-relates-to');
                    if (relatesToInput) {
                        if (context === 'val') {
                            const units = typeof getMultiSelectValues === 'function' ? getMultiSelectValues('units-multi-select') : [];
                            const unitText = units.length > 0 ? units.map(u => u.split(' - ')[0]).join(', ') : 'No Unit Selected';
                            relatesToInput.value = `Validation Meeting - ${unitText} `;
                        } else if (context === 'meeting') {
                            const types = typeof getMultiSelectValues === 'function' ? getMultiSelectValues('meeting-type-select') : [];
                            const typeText = types.length > 0 ? types.join(', ') : 'General Meeting';
                            const titleInput = document.getElementById('meeting-title');
                            const title = titleInput ? titleInput.value : 'Untitled Meeting';
                            relatesToInput.value = `${typeText} - ${title} `;
                        } else {
                            relatesToInput.value = '';
                        }
                    }

                    if (typeof openModal === 'function') {
                        openModal('modal-add-ci');
                    } else {
                        console.error('openModal function not found');
                    }
                };

                window.generateAssessmentSamples = function () {
                    const list = document.getElementById('student-assessments-list');
                    if (!list) return;
                    list.innerHTML = '';

                    const samples = [
                        { student: 'Student 1', result: 'Competent', assessor: 'David Jones', date: '2025-11-01' },
                        { student: 'Student 2', result: 'Competent', assessor: 'Sarah Chen', date: '2025-11-02' },
                        { student: 'Student 3', result: 'Not Yet Competent', assessor: 'Michael Brown', date: '2025-11-03' }
                    ];

                    samples.forEach(s => {
                        const row = document.createElement('div');
                        row.className = 'flex justify-between items-center p-3 bg-white border rounded shadow-sm mb-2';
                        row.innerHTML = `<div><p class="font-bold text-sm text-slate-800">${s.student}</p><p class="text-xs text-slate-500">${s.date} - ${s.assessor}</p></div>
                                                     <span class="px-2 py-1 rounded text-xs font-bold ${s.result === 'Competent' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${s.result}</span>`;
                        list.appendChild(row);
                    });
                };

                window.saveCIRecord = function () {
                    const raisedBy = document.getElementById('ci-raised-by').value === 'User' ? document.getElementById('ci-user').value : 'Other';
                    const area = document.getElementById('ci-improvement-area').value || 'No details provided';
                    const status = document.getElementById('ci-status').value;

                    let tableBodyId, emptyStateId, tableContainerId;
                    if (activeCIContext === 'meeting') {
                        tableBodyId = 'meeting-ci-table-body';
                        emptyStateId = 'meeting-ci-empty-state';
                        tableContainerId = 'meeting-ci-table-container';
                    } else {
                        tableBodyId = 'val-ci-table-body';
                        emptyStateId = 'val-ci-empty-state';
                        tableContainerId = 'val-ci-table-container';
                    }

                    const tableBody = document.getElementById(tableBodyId);
                    const emptyState = document.getElementById(emptyStateId);
                    const tableContainer = document.getElementById(tableContainerId);

                    if (emptyState) emptyState.classList.add('hidden');
                    if (tableContainer) tableContainer.classList.remove('hidden');

                    const row = document.createElement('tr');
                    const today = new Date().toISOString().split('T')[0];
                    row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900"> ${raisedBy}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${today}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500 max-w-xs truncate">${area}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(status)}">
                                        ${status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <div class="action-menu-container relative inline-block text-left">
                                        <button type="button" class="text-slate-400 hover:text-slate-600 p-1" onclick="toggleActionMenu(this)">
                                            <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                        </button>
                                        <div class="action-menu-dropdown absolute right-0 bottom-full mb-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                            <div class="py-1">
                                                <a href="#" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center gap-2"><i data-lucide="eye" class="w-4 h-4"></i> View</a>
                                                <a href="#" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center gap-2"><i data-lucide="edit-2" class="w-4 h-4"></i> Edit</a>
                                                <a href="#" class="text-red-600 block px-4 py-2 text-sm hover:bg-red-50 flex items-center gap-2" onclick="this.closest('tr').remove()"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</a>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                            `;

                    if (tableBody) tableBody.appendChild(row);
                    lucide.createIcons();
                    closeModal('modal-add-ci');
                    document.getElementById('form-ci').reset();
                };

                function getStatusColor(status) {
                    switch (status) {
                        case 'New': return 'bg-blue-100 text-blue-800';
                        case 'In Progress': return 'bg-yellow-100 text-yellow-800';
                        case 'Completed': return 'bg-green-100 text-green-800';
                        default: return 'bg-slate-100 text-slate-800';
                    }
                }

                window.toggleActionMenu = function (btn) {
                    const menu = btn.nextElementSibling;
                    document.querySelectorAll('.action-menu-dropdown').forEach(el => {
                        if (el !== menu) el.classList.remove('show');
                    });
                    menu.classList.toggle('show');
                };

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.action-menu-container')) {
                        document.querySelectorAll('.action-menu-dropdown').forEach(el => el.classList.remove('show'));
                    }
                });

                document.body.addEventListener('mousedown', function (e) {
                    const btn = e.target.closest('.rte-btn');
                    if (btn) {
                        e.preventDefault();
                        const command = btn.dataset.command;
                        document.execCommand(command, false, null);
                    }
                });

                // NEW: Main View Switcher Logic
                window.switchMainView = function (viewName) {
                    const calendarEl = document.getElementById('calendar');
                    const listEl = document.getElementById('list-view-container');
                    const tabSchedule = document.getElementById('tab-schedule');
                    const tabList = document.getElementById('tab-list-view');

                    if (viewName === 'schedule') {
                        calendarEl.classList.remove('hidden');
                        listEl.classList.add('hidden');

                        tabSchedule.classList.add('active', 'text-blue-600', 'border-blue-600');
                        tabSchedule.classList.remove('text-slate-500', 'border-transparent');

                        tabList.classList.remove('active', 'text-blue-600', 'border-blue-600');
                        tabList.classList.add('text-slate-500', 'border-transparent');

                        // Force calendar resize
                        if (window.calendar) window.calendar.render();

                        // Show View Toolbar
                        document.querySelector('.views-toolbar').classList.remove('hidden');

                    } else if (viewName === 'list') {
                        calendarEl.classList.add('hidden');
                        listEl.classList.remove('hidden');

                        tabList.classList.add('active', 'text-blue-600', 'border-blue-600');
                        tabList.classList.remove('text-slate-500', 'border-transparent');

                        tabSchedule.classList.remove('active', 'text-blue-600', 'border-blue-600');
                        tabSchedule.classList.add('text-slate-500', 'border-transparent');

                        renderListView();
                    }
                };
                // ROBUST ACCORDION HANDLER (Fix for Google Sites Embeds)
                document.addEventListener('click', function (e) {
                    // 1. Handle Guidance Toggles
                    const guidanceBtn = e.target.closest('[data-toggle-guidance]');
                    if (guidanceBtn) {
                        e.stopImmediatePropagation(); // Prevent other handlers
                        const id = guidanceBtn.getAttribute('data-toggle-guidance');
                        const content = document.getElementById(`${id}-content`);
                        const chevron = document.getElementById(`${id}-chevron`);

                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            if (chevron) chevron.style.transform = 'rotate(180deg)';
                        } else {
                            content.classList.add('hidden');
                            if (chevron) chevron.style.transform = 'rotate(0deg)';
                        }
                        return;
                    }

                    // 2. Handle Sample Row Toggles
                    const sampleBtn = e.target.closest('[data-toggle-sample-row]');
                    if (sampleBtn) {
                        e.stopImmediatePropagation();
                        const rowId = sampleBtn.getAttribute('data-toggle-sample-row');
                        const content = document.getElementById(`${rowId}-content`);
                        const chevron = document.getElementById(`${rowId}-chevron`);

                        if (content.classList.contains('hidden')) {
                            content.classList.remove('hidden');
                            if (chevron) chevron.style.transform = 'rotate(0deg)';
                        } else {
                            content.classList.add('hidden');
                            if (chevron) chevron.style.transform = 'rotate(-90deg)';
                        }
                        return;
                    }

                    // 3. Handle Add Agenda Sub Item (Restored) - Uses Title + Presenter + Notes RTE format
                    const addSubBtn = e.target.closest('[data-action="add-agenda-sub-item"]');
                    if (addSubBtn) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        const parentId = addSubBtn.getAttribute('data-id');
                        const container = document.getElementById(`agenda-subs-${parentId}`);
                        if (!container) return;

                        const notesRTE = getRTEHtml('min-h-[60px]', 'Sub-item notes...');
                        const presenterOptions = getPresenterOptions();

                        const subHtml = `
                               <div class="agenda-sub-item bg-slate-50 border border-slate-200 rounded-md p-3 relative group mt-2">
                                   <button type="button" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-action="remove-closest" data-target=".agenda-sub-item">
                                       <i data-lucide="x" class="w-4 h-4"></i>
                                   </button>
                                   <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-2">
                                        <div class="md:col-span-8">
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Sub-item Title</label>
                                            <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Sub-item title...">
                                        </div>
                                        <div class="md:col-span-4">
                                            <label class="block text-xs font-medium text-slate-500 mb-1">Presenter</label>
                                            <select class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                                ${presenterOptions}
                                            </select>
                                        </div>
                                   </div>
                                   <div>
                                       <label class="block text-xs font-medium text-slate-500 mb-1">Notes</label>
                                       ${notesRTE}
                                   </div>
                               </div>`;
                        container.insertAdjacentHTML('beforeend', subHtml);
                        lucide.createIcons();
                        return;
                    }
                });

                // --- RISK MANAGEMENT LOGIC ---

                window.risks = window.risks || [];

                function renderRisksTable(context) {
                    // Both meeting and validation events use the same modal/table IDs
                    const tbodyId = 'val-risk-table-body';
                    const emptyId = 'val-risk-empty-state';

                    const tbody = document.getElementById(tbodyId);
                    const emptyState = document.getElementById(emptyId);

                    if (!tbody) return;

                    tbody.innerHTML = '';

                    if (window.risks.length === 0) {
                        if (emptyState) emptyState.classList.remove('hidden');
                        return;
                    } else {
                        if (emptyState) emptyState.classList.add('hidden');
                    }

                    window.risks.forEach(risk => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-slate-50 transition-colors border-b border-slate-100 last:border-0';
                        row.innerHTML = `
                                    <td class="px-6 py-4">
                                        <div class="flex flex-col">
                                            <span class="font-bold text-slate-800">${risk.id}</span>
                                            <span class="text-xs text-slate-500 truncate max-w-[200px]">${risk.description}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-slate-600">${formatDate(risk.date)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getRiskStatusColor(risk.status)}">
                                            ${risk.status}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-slate-600">${risk.owner}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <div class="action-menu-container relative inline-block text-left">
                                            <button type="button" class="text-blue-600 hover:text-blue-800 p-1" onclick="toggleActionMenu(this)">
                                                <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                            </button>
                                            <div class="action-menu-dropdown absolute right-0 bottom-full mb-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50">
                                                <div class="py-1">
                                                    <button class="w-full text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center gap-2" onclick="editRisk('${risk.id}')"><i data-lucide="edit-2" class="w-4 h-4"></i> Edit</button>
                                                    <button class="w-full text-red-600 block px-4 py-2 text-sm hover:bg-red-50 flex items-center gap-2" onclick="deleteRisk('${risk.id}')"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                `;
                        tbody.appendChild(row);
                    });
                    lucide.createIcons();
                }

                function getRiskStatusColor(status) {
                    switch (status) {
                        case 'Active': return 'bg-green-100 text-green-800';
                        case 'Closed': return 'bg-slate-100 text-slate-800';
                        case 'Monitored': return 'bg-yellow-100 text-yellow-800';
                        default: return 'bg-slate-100 text-slate-800';
                    }
                }



                window.saveRisk = function () {
                    const id = document.getElementById('risk-id').value;
                    const description = document.getElementById('risk-description').value;
                    const owner = document.getElementById('risk-owner').value;
                    const status = document.getElementById('risk-status').value;
                    const impact = document.getElementById('risk-impact').value;
                    const likelihood = document.getElementById('risk-likelihood').value;
                    const reviewDate = document.getElementById('risk-review-date').value;

                    if (!description) {
                        alert('Description is required');
                        return;
                    }

                    if (id) {
                        // Edit
                        const index = risks.findIndex(r => r.id === id);
                        if (index !== -1) {
                            risks[index] = { ...risks[index], description, owner, status, impact, likelihood, date: reviewDate }; // Update fields
                        }
                    } else {
                        // New
                        const newId = 'R' + String(risks.length + 100).padStart(3, '0'); // Simple ID gen
                        risks.push({
                            id: newId,
                            description,
                            owner,
                            status,
                            impact,
                            likelihood,
                            date: reviewDate || new Date().toISOString().split('T')[0]
                        });
                    }

                    renderRisksTable(currentRiskContext);
                    closeModal('modal-add-risk');
                };

                window.editRisk = function (id) {
                    const risk = risks.find(r => r.id === id);
                    if (!risk) return;

                    document.getElementById('risk-id').value = risk.id;
                    document.getElementById('risk-description').value = risk.description;
                    document.getElementById('risk-owner').value = risk.owner;
                    document.getElementById('risk-status').value = risk.status;
                    document.getElementById('risk-impact').value = risk.impact;
                    document.getElementById('risk-likelihood').value = risk.likelihood;
                    document.getElementById('risk-review-date').value = risk.date;

                    document.getElementById('modal-risk-title').innerText = 'Edit Risk ' + risk.id;

                    openModal('modal-add-risk');
                };

                window.deleteRisk = function (id) {
                    if (confirm('Are you sure you want to delete this risk?')) {
                        risks = risks.filter(r => r.id !== id);
                        renderRisksTable(currentRiskContext);
                    }
                };

                // Helper for Date Formatting
                function formatDate(dateString) {
                    if (!dateString) return '-';
                    const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                    return new Date(dateString).toLocaleDateString('en-AU', options);
                }

                // 3. Handle Add Agenda Sub Item (Dynamic)
                document.addEventListener('click', function (e) {
                    const addSubBtn = e.target.closest('[data-action="add-agenda-sub-item"]');
                    if (addSubBtn) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        const parentId = addSubBtn.getAttribute('data-id');
                        const container = document.getElementById(`agenda-subs-${parentId}`); // FIXED: Removed extra spaces
                        if (!container) return;

                        const notesRTE = getRTEHtml('min-h-[60px]', 'Sub-item notes...');
                        const presenterOptions = getPresenterOptions();

                        const subHtml = `
                               <div class="agenda-sub-item bg-slate-50 border border-slate-200 rounded-md p-3 relative group">
                                   <button type="button" class="absolute top-2 right-2 text-slate-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" data-action="remove-closest" data-target=".agenda-sub-item">
                                       <i data-lucide="x" class="w-4 h-4"></i>
                                   </button>
                                   
                                   <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-2">
                                       <div class="md:col-span-8">
                                           <label class="block text-xs font-medium text-slate-500 mb-1">Sub-item Title</label>
                                           <input type="text" class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm" placeholder="Sub-item title...">
                                       </div>
                                       <div class="md:col-span-4">
                                           <label class="block text-xs font-medium text-slate-500 mb-1">Presenter</label>
                                           <select class="block w-full border-slate-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500 text-sm">
                                               ${presenterOptions}
                                           </select>
                                       </div>
                                   </div>
                                   
                                   <div>
                                       <label class="block text-xs font-medium text-slate-500 mb-1">Notes</label>
                                       ${notesRTE}
                                   </div>
                               </div>`;

                        container.insertAdjacentHTML('beforeend', subHtml);
                        lucide.createIcons();
                        return;
                    }

                    // 4. Handle Remove Closest (Generic Delete)
                    const removeBtn = e.target.closest('[data-action="remove-closest"]');
                    if (removeBtn) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        const selector = removeBtn.getAttribute('data-target');
                        const target = removeBtn.closest(selector);
                        if (target) {
                            target.remove();
                            updateAgendaButtonVisibility();
                        }
                        return;
                    }
                }, true); // Use capture phase for maximum reliability





                // NEW: Render Participant List for Validation
                window.renderParticipantList = function (participants) {
                    const list = document.getElementById('participant-list');
                    if (!list) return;
                    list.innerHTML = '';

                    participants.forEach((p, index) => {
                        const initials = p.name ? p.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : '??';
                        const isExternal = p.type === 'external';

                        // Determine checked state for credentials based on participant data
                        const industryCurrencyChecked = p.industryCurrency ? 'checked' : '';
                        const profDevChecked = p.professionalDevelopment ? 'checked' : '';
                        const trainerCredChecked = p.trainerCredential ? 'checked' : '';
                        const independentChecked = p.independent ? 'checked' : '';

                        // Status badge
                        const statusBadge = p.status ? `<span class="ml-2 text-xs px-2 py-0.5 rounded-full ${p.status === 'Confirmed' ? 'bg-green-100 text-green-800' : p.status === 'Invited' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}">${p.status}</span>` : '';

                        // External info (email, organization)
                        const externalInfo = isExternal && p.email ? `<p class="text-xs text-slate-400 mt-0.5">${p.email}${p.organization ? '  ' + p.organization : ''}</p>` : '';

                        const html = `
                            <div class="bg-white border border-slate-200 rounded-md shadow-sm participant-card">
                                <div class="p-4 flex items-start justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 font-bold text-sm">${initials}</div>
                                        <div>
                                            <p class="text-sm font-bold text-slate-900">${p.name}${statusBadge}</p>
                                            <p class="text-xs text-slate-500">${p.role || ''}</p>
                                            ${externalInfo}
                                            <button type="button" class="text-xs text-blue-600 font-medium hover:underline mt-1">View Linked Evidence</button>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <label class="flex items-center text-xs text-slate-600 gap-1 cursor-pointer">
                                            <input type="checkbox" class="rounded border-slate-300 text-blue-600 focus:ring-blue-500" ${independentChecked}>Independent
                                        </label>
                                        <div class="action-menu-container relative inline-block text-left">
                                            <button type="button" class="p-1 text-slate-400 hover:text-slate-600" onclick="toggleActionMenu(this)" title="Actions">
                                                <i data-lucide="more-vertical" class="w-5 h-5"></i>
                                            </button>
                                            <div class="action-menu-dropdown absolute right-0 bottom-full mb-2 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50 hidden">
                                                <div class="py-1">
                                                    <a href="#" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center gap-2" onclick="event.preventDefault(); editValidationParticipant(${index});"><i data-lucide="edit-2" class="w-4 h-4"></i> Edit</a>
                                                    <a href="#" class="text-red-600 block px-4 py-2 text-sm hover:bg-red-50 flex items-center gap-2" onclick="event.preventDefault(); removeValidationParticipant(${index});"><i data-lucide="trash-2" class="w-4 h-4"></i> Delete</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Credentials Footer -->
                                <div class="bg-slate-50 p-3 border-t border-slate-100 rounded-b-md">
                                    <p class="text-xs font-semibold text-slate-700 mb-2">Tag evidence against requirements:</p>
                                    <div class="flex flex-wrap gap-4">
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Industry Currency" ${industryCurrencyChecked} onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Industry Currency</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Professional Development" ${profDevChecked} onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Professional Development</span>
                                        </label>
                                        <label class="inline-flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" class="compliance-checkbox rounded border-slate-300 text-blue-600 focus:ring-blue-500 h-4 w-4" data-type="Trainer Credential" ${trainerCredChecked} onchange="checkCompliance()">
                                            <span class="text-xs text-slate-600">Trainer Credential</span>
                                        </label>
                                    </div>
                                </div>
                            </div>`;
                        list.insertAdjacentHTML('beforeend', html);
                    });
                    lucide.createIcons();
                };

                window.toggleReportGuidance = function () {
                    const text = document.getElementById('report-guidance-text');
                    const chevron = document.getElementById('report-guidance-chevron');
                    if (text) {
                        if (text.classList.contains('hidden')) {
                            text.classList.remove('hidden');
                            if (chevron) chevron.style.transform = 'rotate(0deg)';
                        } else {
                            text.classList.add('hidden');
                            if (chevron) chevron.style.transform = 'rotate(180deg)';
                        }
                    }
                };

                // Initial render for validation risks (waiting for DOM content loaded actually, but good to have ready)
                // We'll call renderRiskTable whenever the tab is switched or modal opened.

                // --- Meeting External Participants Logic ---
                let meetingExternalParticipants = [];
                let meetingInternalParticipants = [];

                window.renderMeetingInternalParticipants = function () {
                    const list = document.getElementById('meeting-internal-participants-list');
                    if (!list) return;

                    if (meetingInternalParticipants.length === 0) {
                        list.innerHTML = '';
                    } else {
                        // Status badge colors
                        const statusColors = {
                            'accepted': 'bg-green-100 text-green-800',
                            'pending': 'bg-orange-100 text-orange-800',
                            'declined': 'bg-red-100 text-red-800',
                            'tentative': 'bg-yellow-100 text-yellow-800'
                        };

                        list.innerHTML = meetingInternalParticipants.map((p, index) => {
                            const status = p.status || 'pending';
                            const statusClass = statusColors[status] || statusColors['pending'];
                            const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
                            const initials = p.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                            // Get extra info based on participant type
                            let extraInfo = '';
                            const participantType = p.type || '';

                            // Check if this is a student - look up program info
                            if (participantType === 'students' || window.participantMetadata?.students?.[p.name]) {
                                const studentMeta = window.participantMetadata?.students?.[p.name];
                                if (studentMeta && studentMeta.programs) {
                                    const programLinks = studentMeta.programs.map(prog =>
                                        `<a href="#/enrollment/${studentMeta.enrollmentId}/${prog}" class="text-blue-600 hover:text-blue-800 hover:underline">${prog}</a>`
                                    ).join(', ');
                                    extraInfo = `<div class="text-xs text-slate-500 mt-0.5">Programs: ${programLinks}</div>`;
                                }
                            }

                            // Check if this is a company contact - look up company info
                            if (participantType === 'company-contacts') {
                                // Try to find company from the full value (name - role format)
                                const fullValue = `${p.name}${p.role ? ' - ' + p.role : ''}`;
                                const contactMeta = window.participantMetadata?.['company-contacts']?.[fullValue];
                                if (contactMeta && contactMeta.company) {
                                    extraInfo = `<div class="text-xs text-slate-500 mt-0.5">Company: <span class="text-blue-600">${contactMeta.company}</span></div>`;
                                } else if (window.selectedParticipants?.company?.[0]) {
                                    // Fallback to currently selected company
                                    extraInfo = `<div class="text-xs text-slate-500 mt-0.5">Company: <span class="text-blue-600">${window.selectedParticipants.company[0]}</span></div>`;
                                }
                            }

                            return `
                                <div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-xs font-bold text-blue-700">${initials}</div>
                                        <div>
                                            <div class="font-medium text-slate-800">${p.name}</div>
                                            <div class="text-xs text-slate-500">${p.role || ''}</div>
                                            ${extraInfo}
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="flex flex-col items-end">
                                            <span class="text-[10px] text-slate-500 font-semibold mb-0.5">Attendance</span>
                                            <select class="text-xs font-medium px-2 py-1 rounded-full border-0 cursor-pointer ${statusClass}" 
                                                    onchange="updateMeetingInternalStatus(${index}, this.value)">
                                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                                                <option value="accepted" ${status === 'accepted' ? 'selected' : ''}>Accepted</option>
                                                <option value="declined" ${status === 'declined' ? 'selected' : ''}>Declined</option>
                                                <option value="tentative" ${status === 'tentative' ? 'selected' : ''}>Tentative</option>
                                            </select>
                                        </div>
                                        <button type="button" class="text-slate-400 hover:text-red-600 p-1" onclick="removeMeetingInternalParticipant(${index})" title="Remove participant">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `}).join('');
                        lucide.createIcons();
                    }
                };

                window.editMeetingInternalParticipant = function (index) {
                    // Placeholder for edit function
                    alert('Edit internal participant: ' + meetingInternalParticipants[index]?.name);
                };

                window.removeMeetingInternalParticipant = function (index) {
                    meetingInternalParticipants.splice(index, 1);
                    renderMeetingInternalParticipants();
                };

                window.updateMeetingInternalStatus = function (index, newStatus) {
                    if (meetingInternalParticipants[index]) {
                        meetingInternalParticipants[index].status = newStatus;
                        renderMeetingInternalParticipants();
                    }
                };

                // --- Participant Modal Functions (Dropdown Multi-Select with Pills) ---

                // Track selected participants per type
                window.selectedParticipants = {
                    'staff': [],
                    'students': [],
                    'orgUnit': [],
                    'company': [],
                    'company-contacts': [],
                    'trainers': []
                };

                // Participant metadata for cards (programs for students, company for contacts)
                window.participantMetadata = {
                    students: {
                        'Emily Thompson': { programs: ['CHC33015', 'CHC43015'], enrollmentId: 'STU001' },
                        'James Wilson': { programs: ['CHC33015'], enrollmentId: 'STU002' },
                        'Sarah Mitchell': { programs: ['CHC43015', 'SIT30316'], enrollmentId: 'STU003' },
                        'Michael Chen': { programs: ['SIT30316'], enrollmentId: 'STU004' },
                        'Jessica Lee': { programs: ['BSB42015'], enrollmentId: 'STU005' }
                    },
                    'company-contacts': {
                        'John Smith - Manager': { company: 'Care Plus' },
                        'Jane Doe - Coordinator': { company: 'Allied Health Services' },
                        'Bob Wilson - Supervisor': { company: 'Community Care Inc.' },
                        'Alice Johnson - Representative': { company: 'Aged Care Solutions' },
                        'Tom Brown - Director': { company: 'Health First Australia' }
                    }
                };

                window.toggleSelectAll = function (type) {
                    const container = document.getElementById(`select-${type}`);
                    if (!container) return;

                    // Get all available options (values) from the container's data attributes
                    const allOptions = Array.from(container.querySelectorAll('.participant-option')).map(opt => opt.dataset.value);

                    // Check if all are currently selected
                    const allSelected = allOptions.every(val => selectedParticipants[type].includes(val));

                    if (allSelected) {
                        // Deselect All
                        selectedParticipants[type] = selectedParticipants[type].filter(val => !allOptions.includes(val));
                    } else {
                        // Select All (union)
                        const newSet = new Set([...selectedParticipants[type], ...allOptions]);
                        selectedParticipants[type] = Array.from(newSet);
                    }

                    updatePillsDisplay(type);
                    updateParticipantListVisibility(type);
                };

                window.populateParticipantDropdown = function (type) {
                    const container = document.getElementById(`select-${type}`);
                    if (!container || container.dataset.populated === 'true') return;

                    // Sample data
                    const sampleData = {
                        staff: ['David Jones - Lead Assessor', 'Sarah Chen - Senior Assessor', 'Michael Brown - Quality Officer', 'Emily White - Trainer', 'Jessica Davis - Admin Officer'],
                        trainers: ['John Trainer - Senior Trainer', 'Alice Educator - VET Trainer', 'Bob Instructor - Assessor', 'Clara Coach - Mentor', 'Dan Teacher - Content Lead'],
                        students: ['Emily Thompson', 'James Wilson', 'Sarah Mitchell', 'Michael Chen', 'Jessica Lee'],
                        orgUnit: ['Individual Support Department', 'Community Services', 'Business Administration', 'Hospitality & Tourism', 'Information Technology'],
                        company: ['Care Plus', 'Allied Health Services', 'Community Care Inc.', 'Aged Care Solutions', 'Health First Australia'],
                        'company-contacts': ['John Smith - Manager', 'Jane Doe - Coordinator', 'Bob Wilson - Supervisor', 'Alice Johnson - Representative', 'Tom Brown - Director']
                    };

                    const data = sampleData[type] || [];

                    let selectAllHtml = '';
                    if (type === 'staff' || type === 'trainers') {
                        selectAllHtml = `
                            <div class="p-2 hover:bg-blue-100 cursor-pointer border-b border-slate-200 text-sm font-semibold text-blue-700 bg-blue-50" 
                                 onclick="toggleSelectAll('${type}')">
                                Select All
                            </div>
                            `;
                    }

                    // Create clickable list items (no checkboxes)
                    container.innerHTML = selectAllHtml + data.map((item) => `
                            <div class="participant-option p-2 hover:bg-blue-50 cursor-pointer border-b border-slate-100 last:border-b-0 text-sm" 
                                 data-value="${item}" data-type="${type}"
                                 onclick="selectParticipant('${type}', '${item.replace(/'/g, "\\'")}')">
                                ${item}
                            </div>
                        `).join('');

                    container.dataset.populated = 'true';
                    updateParticipantListVisibility(type);
                };

                window.selectParticipant = function (type, value) {
                    // Check if already selected
                    if (selectedParticipants[type].includes(value)) return;

                    // For company, only allow single selection (replace previous)
                    if (type === 'company') {
                        selectedParticipants[type] = [value];
                    } else {
                        // Add to selected array
                        selectedParticipants[type].push(value);
                    }

                    // Update the pills display
                    updatePillsDisplay(type);

                    // Hide the selected item from the dropdown
                    updateParticipantListVisibility(type);

                    // Special handling: Show Company Contacts when company is selected
                    if (type === 'company') {
                        const companyContactsCard = document.getElementById('card-company-contacts');
                        if (companyContactsCard) {
                            companyContactsCard.classList.remove('hidden');
                        }
                        // Populate company contacts for selected company
                        populateParticipantDropdown('company-contacts');
                    }
                };

                window.removeParticipantPill = function (type, value, event) {
                    // Stop the click from triggering the dropdown toggle
                    if (event) {
                        event.stopPropagation();
                    }

                    // Remove from selected array
                    const index = selectedParticipants[type].indexOf(value);
                    if (index > -1) {
                        selectedParticipants[type].splice(index, 1);
                    }

                    // Update the pills display
                    updatePillsDisplay(type);

                    // Show the item back in the dropdown
                    updateParticipantListVisibility(type);

                    // Special handling: Hide Company Contacts when company is removed
                    if (type === 'company' && selectedParticipants['company'].length === 0) {
                        const companyContactsCard = document.getElementById('card-company-contacts');
                        if (companyContactsCard) {
                            companyContactsCard.classList.add('hidden');
                        }
                        // Clear company contacts selection
                        selectedParticipants['company-contacts'] = [];
                        updatePillsDisplay('company-contacts');
                    }
                };

                window.updatePillsDisplay = function (type) {
                    const pillsContainer = document.getElementById(`${type}-pills`);
                    const placeholder = document.getElementById(`${type}-selected-display`);
                    if (!pillsContainer || !placeholder) return;

                    const selected = selectedParticipants[type];

                    if (selected.length === 0) {
                        pillsContainer.innerHTML = '';
                        placeholder.classList.remove('hidden');
                    } else {
                        placeholder.classList.add('hidden');
                        // Get short name (first part before " - ")
                        pillsContainer.innerHTML = selected.map(item => {
                            const shortName = item.split(' - ')[0];
                            return `
                                    <span class="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                        ${shortName}
                                        <button type="button" class="hover:text-blue-600" onclick="removeParticipantPill('${type}', '${item.replace(/'/g, "\\'")}', event)">
                                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                            </svg>
                                        </button>
                                    </span>
                                `;
                        }).join('');
                    }
                };

                window.updateParticipantListVisibility = function (type) {
                    const container = document.getElementById(`select-${type}`);
                    if (!container) return;

                    const options = container.querySelectorAll('.participant-option');
                    options.forEach(option => {
                        const value = option.dataset.value;
                        if (selectedParticipants[type].includes(value)) {
                            option.classList.add('hidden');
                        } else {
                            option.classList.remove('hidden');
                        }
                    });
                };

                window.toggleParticipantDropdown = function (type) {
                    const dropdown = document.getElementById(`dropdown-${type}`);
                    const filterContainer = document.getElementById(`${type}-filter-container`);
                    if (!dropdown) return;

                    // Close all other dropdowns and their filter containers
                    document.querySelectorAll('[id^="dropdown-"]').forEach(d => {
                        if (d.id !== `dropdown-${type}`) {
                            d.classList.add('hidden');
                        }
                    });
                    // Close all filter containers except for this type
                    ['company', 'company-contacts'].forEach(t => {
                        if (t !== type) {
                            const fc = document.getElementById(`${t}-filter-container`);
                            if (fc) fc.classList.add('hidden');
                        }
                    });

                    // Toggle this dropdown and filter container
                    dropdown.classList.toggle('hidden');
                    if (filterContainer) {
                        filterContainer.classList.toggle('hidden');
                    }

                    // Focus search input if opening
                    if (!dropdown.classList.contains('hidden')) {
                        // Ensure list is populated
                        populateParticipantDropdown(type);

                        const searchInput = document.getElementById(`search-${type}`);
                        if (searchInput) {
                            setTimeout(() => searchInput.focus(), 50);
                        }
                    }
                };

                // Close dropdowns when clicking outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.participant-multiselect')) {
                        document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                            dropdown.classList.add('hidden');
                        });
                        // Also close filter containers
                        ['company', 'company-contacts'].forEach(type => {
                            const fc = document.getElementById(`${type}-filter-container`);
                            if (fc) fc.classList.add('hidden');
                        });
                    }
                });

                window.filterParticipantOptions = function (type, searchTerm) {
                    const container = document.getElementById(`select-${type}`);
                    if (!container) return;

                    if (!window.selectedParticipants || !window.selectedParticipants[type]) {
                        console.warn('Selected participants not initialized for:', type);
                        window.selectedParticipants = window.selectedParticipants || {};
                        window.selectedParticipants[type] = [];
                    }

                    const options = container.querySelectorAll('.participant-option');
                    const term = searchTerm.toLowerCase();

                    options.forEach(option => {
                        const value = option.dataset.value;
                        const text = option.textContent.toLowerCase();
                        // Hide if doesn't match search OR if already selected
                        if (text.includes(term) && !selectedParticipants[type].includes(value)) {
                            option.classList.remove('hidden');
                        } else {
                            option.classList.add('hidden');
                        }
                    });
                };

                window.handleCompanySelection = function (select) {
                    const contactsCard = document.getElementById('card-company-contacts');
                    const contactsContainer = document.getElementById('select-company-contacts');

                    if (select.value) {
                        contactsCard.classList.remove('hidden');

                        // Clear and populate contacts for selected company
                        contactsContainer.innerHTML = '';
                        const sampleContacts = [
                            'John Smith - Manager',
                            'Jane Doe - Coordinator',
                            'Bob Wilson - Supervisor',
                            'Alice Johnson - Representative'
                        ];

                        contactsContainer.innerHTML = sampleContacts.map(contact => `
                                <label class="flex items-center gap-2 p-2 hover:bg-slate-100 cursor-pointer border-b border-slate-100 last:border-b-0" data-value="${select.value} - ${contact}">
                                    <input type="checkbox" value="${select.value} - ${contact}" class="rounded border-slate-300">
                                    <span class="text-sm">${contact}</span>
                                </label>
                            `).join('');

                        contactsContainer.dataset.populated = 'true';
                    } else {
                        contactsCard.classList.add('hidden');
                    }
                };

                window.saveParticipantsFromModal = function () {
                    const collectedParticipants = [];

                    // Collect from staff pills
                    selectedParticipants['staff'].forEach(item => {
                        collectedParticipants.push({
                            name: item.split(' - ')[0],
                            role: item.split(' - ')[1] || 'Staff Member',
                            status: 'pending',
                            type: 'staff'
                        });
                    });

                    // Collect from trainers pills
                    selectedParticipants['trainers'].forEach(item => {
                        collectedParticipants.push({
                            name: item.split(' - ')[0],
                            role: item.split(' - ')[1] || 'Trainer',
                            status: 'pending',
                            type: 'trainers'
                        });
                    });

                    // Collect from students pills
                    selectedParticipants['students'].forEach(item => {
                        collectedParticipants.push({
                            name: item,
                            role: 'Student',
                            status: 'pending',
                            type: 'students'
                        });
                    });

                    // Collect from org units pills
                    selectedParticipants['orgUnit'].forEach(item => {
                        collectedParticipants.push({
                            name: item,
                            role: 'Org Unit Representative',
                            status: 'pending',
                            type: 'orgUnit'
                        });
                    });

                    // Collect from company contacts pills
                    selectedParticipants['company-contacts'].forEach(item => {
                        collectedParticipants.push({
                            name: item.split(' - ')[0],
                            role: item.split(' - ')[1] || 'Company Contact',
                            status: 'pending',
                            type: 'company-contacts'
                        });
                    });

                    // Add to internal participants
                    meetingInternalParticipants.push(...collectedParticipants);
                    renderMeetingInternalParticipants();

                    // Reset and close modal
                    resetParticipantModal();
                    closeModal('modal-add-meeting-participant');
                };

                window.resetParticipantModal = function () {
                    // Reset all selected participants including company
                    ['staff', 'trainers', 'students', 'orgUnit', 'company', 'company-contacts'].forEach(type => {
                        selectedParticipants[type] = [];
                        updatePillsDisplay(type);
                        updateParticipantListVisibility(type);
                    });

                    // Hide company contacts card
                    const companyContactsCard = document.getElementById('card-company-contacts');
                    if (companyContactsCard) {
                        companyContactsCard.classList.add('hidden');
                    }

                    // Clear search inputs and reset filter visibility
                    ['staff', 'trainers', 'students', 'orgUnit', 'company', 'company-contacts'].forEach(type => {
                        const searchInput = document.getElementById(`search-${type}`);
                        if (searchInput) searchInput.value = '';
                        // Reset filter to show all items
                        filterParticipantOptions(type, '');
                    });
                };

                window.openAddMeetingExternalModal = function () {
                    document.getElementById('form-meeting-external').reset();
                    openModal('modal-add-meeting-external');
                };

                window.saveMeetingExternalParticipant = function () {
                    const firstName = document.getElementById('meeting-ext-first-name').value.trim();
                    const lastName = document.getElementById('meeting-ext-last-name').value.trim();
                    const email = document.getElementById('meeting-ext-email').value.trim();
                    const role = document.getElementById('meeting-ext-role').value.trim();

                    if (!firstName || !lastName || !email) {
                        alert("First Name, Last Name, and Email are required.");
                        return;
                    }

                    const newParticipant = {
                        id: Date.now(), // simple ID
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        role: role || 'External Participant',
                        status: 'pending' // Default status
                    };

                    meetingExternalParticipants.push(newParticipant);
                    renderMeetingExternalParticipants();
                    closeModal('modal-add-meeting-external');
                };

                window.renderMeetingExternalParticipants = function () {
                    const list = document.getElementById('meeting-external-participants-list');
                    const card = document.getElementById('card-meeting-external-participants');

                    if (!list || !card) return;

                    if (meetingExternalParticipants.length === 0) {
                        card.classList.add('hidden');
                        list.innerHTML = '';
                    } else {
                        card.classList.remove('hidden');

                        // Status badge colors
                        const statusColors = {
                            'accepted': 'bg-green-100 text-green-800',
                            'pending': 'bg-orange-100 text-orange-800',
                            'declined': 'bg-red-100 text-red-800',
                            'tentative': 'bg-yellow-100 text-yellow-800'
                        };

                        list.innerHTML = meetingExternalParticipants.map((p, index) => {
                            const status = p.status || 'pending';
                            const statusClass = statusColors[status] || statusColors['pending'];
                            // Fix: Combine firstName and lastName for display
                            const displayName = p.name || `${p.firstName || ''} ${p.lastName || ''}`.trim() || 'Unknown';
                            const initials = displayName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

                            return `
                                <div class="flex justify-between items-center p-3 bg-slate-50 border border-slate-100 rounded-lg text-sm group">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-xs font-bold text-purple-700">${initials}</div>
                                        <div>
                                            <div class="font-medium text-slate-800">${displayName}</div>
                                            <div class="text-xs text-slate-500">${p.role || ''} ${p.email ? ' ' + p.email : ''} ${p.organization ? ' ' + p.organization : ''}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <select class="text-xs font-medium px-2 py-1 rounded-full border-0 cursor-pointer ${statusClass}" 
                                                onchange="updateMeetingExternalStatus(${index}, this.value)">
                                            <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="accepted" ${status === 'accepted' ? 'selected' : ''}>Accepted</option>
                                            <option value="declined" ${status === 'declined' ? 'selected' : ''}>Declined</option>
                                            <option value="tentative" ${status === 'tentative' ? 'selected' : ''}>Tentative</option>
                                        </select>
                                        <button type="button" class="text-slate-400 hover:text-red-600 p-1" onclick="removeMeetingExternalParticipant(${index})" title="Remove participant">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </button>
                                    </div>
                                </div>
                            `}).join('');
                        lucide.createIcons();
                    }
                };

                window.updateMeetingExternalStatus = function (index, newStatus) {
                    if (meetingExternalParticipants[index]) {
                        meetingExternalParticipants[index].status = newStatus;
                        renderMeetingExternalParticipants(); // Re-render to update badge color
                    }
                };

                window.editMeetingExternalParticipant = function (index) {
                    const participant = meetingExternalParticipants[index];
                    if (!participant) return;

                    // Pre-fill the add external participant modal with existing data
                    const nameParts = participant.name.split(' ');
                    document.getElementById('meeting-external-first-name').value = nameParts[0] || '';
                    document.getElementById('meeting-external-last-name').value = nameParts.slice(1).join(' ') || '';
                    document.getElementById('meeting-external-email').value = participant.email || '';
                    document.getElementById('meeting-external-role').value = participant.role || '';
                    document.getElementById('meeting-external-organization').value = participant.organization || '';

                    // Store index for update
                    window.editingExternalParticipantIndex = index;

                    openModal('modal-add-meeting-external');
                };

                window.removeMeetingExternalParticipant = function (index) {
                    meetingExternalParticipants.splice(index, 1);
                    renderMeetingExternalParticipants();
                };


            });
            console.log("END OF FILE REACHED");
        </script>
</body>

</html>